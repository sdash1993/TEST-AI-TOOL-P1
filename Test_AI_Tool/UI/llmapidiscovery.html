<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Discovery Suite - Welcome</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    /* Background Image Layer */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      /* Replace this URL with your desired background image */
      background-image: url('https://img.freepik.com/premium-photo/ai-artificial-intelligence-technology-microchip-background_951586-29705.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: brightness(0.3);
      z-index: -2;
    }

    .container {
      text-align: center;
      z-index: 10;
      position: relative;
      max-width: 1200px;
      padding: 20px;
      animation: fadeInUp 1s ease-out;
      width: 100%;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      justify-content: space-between;
      align-items: center;
    }

    .left-features {
      position: fixed;
      left: 50px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      width: 200px;
    }

    .right-features {
      position: fixed;
      right: 50px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      width: 200px;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header-section {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 800px;
    }

    .logo-container {
      margin-bottom: 30px;
      animation: pulse 2s ease-in-out infinite;
    }

    /* Fixed pulse animation - removed box-shadow */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    .logo {
      font-size: 60px;
      margin-bottom: 15px;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
    }

    h1 {
      color: white;
      font-size: 2.8em;
      font-weight: 700;
      margin-bottom: 15px;
      text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      letter-spacing: -1px;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.2em;
      margin-bottom: 0;
      font-weight: 300;
      line-height: 1.5;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      max-width: 800px;
      margin: 0 auto;
    }

    .middle-section {
      position: absolute;
      top: 65%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 1400px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bottom-section {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }

    /* Animated arrow styles */
    .button-with-arrow {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
    }

    .animated-arrow {
      font-size: 40px;
      color: #fff;
      animation: arrowPulse 2s ease-in-out infinite;
      filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8));
      position: relative;
      display: inline-block;
    }

    /* Create a glowing trail effect */
    .animated-arrow::before {
      content: '‚û§';
      position: absolute;
      top: 0;
      left: 0;
      font-size: 40px;
      color: rgba(255, 255, 255, 0.3);
      animation: arrowTrail 2s ease-in-out infinite;
      filter: blur(3px);
    }

    /* Create a secondary glow */
    .animated-arrow::after {
      content: '‚û§';
      position: absolute;
      top: 0;
      left: 0;
      font-size: 40px;
      color: rgba(255, 255, 255, 0.5);
      animation: arrowGlow 2s ease-in-out infinite;
      filter: blur(8px);
    }

    @keyframes arrowPulse {
      0% {
        transform: translateX(-10px) scale(0.9);
        opacity: 0.4;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5)) brightness(1);
      }
      25% {
        transform: translateX(0px) scale(1);
        opacity: 0.7;
        filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)) brightness(1.2);
      }
      50% {
        transform: translateX(15px) scale(1.2);
        opacity: 1;
        filter: drop-shadow(0 0 30px rgba(255, 255, 255, 1)) brightness(1.5);
      }
      75% {
        transform: translateX(5px) scale(1.1);
        opacity: 0.8;
        filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)) brightness(1.2);
      }
      100% {
        transform: translateX(-10px) scale(0.9);
        opacity: 0.4;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5)) brightness(1);
      }
    }

    @keyframes arrowTrail {
      0% {
        transform: translateX(-20px) scale(0.8);
        opacity: 0;
      }
      50% {
        transform: translateX(10px) scale(1.1);
        opacity: 0.6;
      }
      100% {
        transform: translateX(-20px) scale(0.8);
        opacity: 0;
      }
    }

    @keyframes arrowGlow {
      0% {
        transform: scale(1);
        opacity: 0.3;
      }
      50% {
        transform: scale(1.3);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 0.3;
      }
    }

    /* Different animation delays for each arrow */
    .arrow-1 {
      animation-delay: 0s;
    }
    .arrow-1::before {
      animation-delay: 0.1s;
    }
    .arrow-1::after {
      animation-delay: 0.2s;
    }

    .arrow-2 {
      animation-delay: 0.5s;
    }
    .arrow-2::before {
      animation-delay: 0.6s;
    }
    .arrow-2::after {
      animation-delay: 0.7s;
    }

    .arrow-3 {
      animation-delay: 1s;
    }
    .arrow-3::before {
      animation-delay: 1.1s;
    }
    .arrow-3::after {
      animation-delay: 1.2s;
    }

    /* Color variations for each arrow */
    .arrow-1 {
      color: #FF6B6B;
      filter: drop-shadow(0 0 20px rgba(255, 107, 107, 0.8));
    }

    .arrow-2 {
      color: #4ECDC4;
      filter: drop-shadow(0 0 20px rgba(78, 205, 196, 0.8));
    }

    .arrow-3 {
      color: #667eea;
      filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.8));
    }

    /* Hover effect on arrows */
    .button-with-arrow:hover .animated-arrow {
      animation-duration: 0.8s;
      filter: drop-shadow(0 0 40px currentColor) brightness(1.8);
    }

    .features {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .feature {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .left-features .feature:hover {
      transform: translateX(10px);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .right-features .feature:hover {
      transform: translateX(-10px);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .feature-icon {
      font-size: 35px;
      flex-shrink: 0;
    }

    .feature-content {
      flex: 1;
    }

    .feature h3 {
      color: white;
      font-size: 1.1em;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .feature p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.85em;
      line-height: 1.4;
      margin: 0;
    }

    .button-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 30px;
      margin: 0;
      flex-wrap: wrap;
    }

    .cta-button {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      padding: 18px 35px;
      border: none;
      border-radius: 50px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
      position: relative;
      overflow: hidden;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-width: 280px;
      justify-content: center;
    }

    .cta-button.primary {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
    }

    .cta-button.secondary {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      box-shadow: 0 10px 30px rgba(78, 205, 196, 0.4);
    }

    .cta-button.tertiary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .cta-button.disabled {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
    }

    .cta-button.disabled:hover {
      transform: none;
      box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
    }

    .cta-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }

    .cta-button:not(.disabled):hover::before {
      left: 100%;
    }

    .cta-button:not(.disabled):hover {
      transform: translateY(-3px) scale(1.05);
    }

    .coming-soon {
      font-size: 0.8em;
      opacity: 0.8;
      font-style: italic;
    }

    .badge-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .badge {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 0.9em;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .badge:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .footer {
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.3em;
      font-weight: 600;
      text-align: center;
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
      letter-spacing: 1px;
      background: linear-gradient(135deg, #FF6B6B 0%, #667eea 50%, #4ECDC4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      animation: footerGlow 3s ease-in-out infinite;
    }

    @keyframes footerGlow {
      0%, 100% {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)) brightness(1);
      }
      50% {
        filter: drop-shadow(0 4px 8px rgba(255, 255, 255, 0.4)) brightness(1.2);
      }
    }

    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 700px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      transform: scale(0.8);
      transition: transform 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      margin-bottom: 30px;
      text-align: center;
    }

    .modal-header h2 {
      color: #333;
      font-size: 2em;
      margin-bottom: 10px;
    }

    .modal-header p {
      color: #666;
      font-size: 1.1em;
    }

    .checkbox-section {
      margin-bottom: 25px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .checkbox-section:hover {
      border-color: #667eea;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      user-select: none;
    }

    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .checkbox-container label {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      flex: 1;
    }

    .expandable {
      background: #ffffff;
      margin-top: 20px;
      padding: 25px;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .expandable.active {
      max-height: 2000px;
      opacity: 1;
    }

    .expandable h4 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .expandable p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .form-group .optional {
      color: #999;
      font-weight: 400;
      font-size: 0.9em;
    }

    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="file"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      font-family: inherit;
      transition: all 0.3s ease;
      background-color: #f8f9fa;
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="password"]:focus,
    .form-group input[type="file"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group input[type="text"]:disabled,
    .form-group input[type="password"]:disabled,
    .form-group select:disabled,
    .form-group textarea:disabled {
      background-color: #e9ecef;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Courier New', monospace;
    }

    .form-group select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      padding-right: 40px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .modal-footer {
      margin-top: 30px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    .modal-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn.close {
      background: #e9ecef;
      color: #495057;
    }

    .modal-btn.close:hover {
      background: #dee2e6;
      transform: translateY(-2px);
    }

    .modal-btn.submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .modal-btn.submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .loading-ring {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Process button styles */
    .form-actions {
      margin-top: 25px;
      display: flex;
      justify-content: center;
    }

    .process-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .process-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .process-btn:disabled {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* Agreement checkbox styles */
    .agreement-section {
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
    }

    .agreement-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .agreement-container input[type="checkbox"] {
      margin-top: 2px;
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .agreement-container input[type="checkbox"]:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .agreement-container label {
      font-size: 0.95em;
      color: #333;
      line-height: 1.4;
      cursor: pointer;
    }

    .agreement-container label.disabled {
      color: #999;
      cursor: not-allowed;
    }

    /* Prompt selection modal styles */
    .prompt-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .prompt-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .prompt-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }

    .prompt-option {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .prompt-option:hover {
      border-color: #667eea;
      background: #f0f3ff;
    }

    .prompt-option.selected {
      border-color: #667eea;
      background: #e8edff;
    }

    .prompt-option h4 {
      color: #333;
      margin-bottom: 5px;
      font-size: 1.1em;
    }

    .prompt-option p {
      color: #666;
      font-size: 0.9em;
      margin: 0;
    }

    .prompt-category {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8em;
      margin-top: 8px;
    }

    /* Test case result modal */
    .result-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 400;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .result-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .result-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }

    .result-modal.active .result-content {
      transform: scale(1);
    }

    .result-header {
      margin-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 20px;
    }

    .result-header h3 {
      color: #333;
      font-size: 1.8em;
      margin-bottom: 5px;
    }

    .result-meta {
      color: #666;
      font-size: 0.9em;
    }

    /* CRITICAL FIX: Enhanced result body styles to prevent text truncation */
    .result-body {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e9ecef;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 60vh; /* Increased from 500px */
      min-height: 300px;
      line-height: 1.6;
      font-size: 0.9em;
      color: #333;
    }

    /* Additional styling for better readability */
    .result-body::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .result-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }

    .result-body::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    .result-body::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .result-actions {
      margin-top: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .result-info {
      font-size: 0.85em;
      color: #666;
      font-style: italic;
    }

    .result-buttons {
      display: flex;
      gap: 15px;
    }

    .copy-btn {
      background: #28a745;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .copy-btn:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .download-btn {
      background: #17a2b8;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .download-btn:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    /* Download options dropdown */
    .download-options {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      min-width: 200px;
      display: none;
      z-index: 1000;
      overflow: hidden;
    }

    .download-options.show {
      display: block;
      animation: dropdownFadeIn 0.3s ease;
    }

    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .download-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #374151;
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      position: relative;
    }

    .download-option:hover {
      background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);
      color: #0369a1;
    }

    .download-option:first-child {
      border-radius: 0;
    }

    .download-option:last-child {
      border-radius: 0;
      border-top: 1px solid #f1f5f9;
    }

    .download-option::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: transparent;
      transition: background 0.2s ease;
    }

    .download-option:hover::before {
      background: #17a2b8;
    }

    .download-option-icon {
      font-size: 20px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .download-option span:not(.download-option-icon) {
      flex: 1;
      line-height: 1.4;
    }

    /* Enhanced download button container */
    #prdDownloadContainer {
      position: relative;
      display: inline-block;
    }

    /* Improved download button styling */
    #downloadTestCaseBtnPRD {
      min-width: 140px;
      justify-content: center;
      position: relative;
      padding-right: 35px;
    }

    #downloadTestCaseBtnPRD::after {
      content: '‚ñº';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      opacity: 0.7;
      transition: transform 0.2s ease;
    }

    #downloadTestCaseBtnPRD:hover::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }

    .loading-text {
      color: #667eea;
      font-weight: 600;
      margin-left: 10px;
    }

    /* Swagger result display styles */
    .swagger-result {
      margin-top: 20px;
      padding: 20px;
      background: #f0f4ff;
      border-radius: 10px;
      border: 2px solid #667eea;
    }

    .swagger-result h5 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .swagger-result .result-section {
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 5px;
    }

    .swagger-result .result-section h6 {
      color: #667eea;
      margin-bottom: 5px;
      font-size: 0.95em;
    }

    .swagger-result pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 0.85em;
    }

    .fetch-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .fetch-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .fetch-btn:disabled {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* PRD Test Case Modal styles */
    .prd-modal-content {
      max-width: 600px;
    }

    .form-group.info-box {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4ECDC4;
      margin-bottom: 25px;
    }

    .form-group.info-box p {
      margin: 0;
      color: #0066cc;
      font-size: 0.9em;
      line-height: 1.4;
    }

    /* Claude-style overlay button */
    #claude-overlay-btn {
      position: fixed;
      bottom: 30px;
      left: 30px;
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white;
      border: none;
      border-radius: 30px;
      padding: 15px 25px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      z-index: 100;
      transition: all 0.3s ease;
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0% {
        transform: scale(1);
        box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 12px 35px rgba(124, 58, 237, 0.6);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
      }
    }

    #claude-overlay-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(124, 58, 237, 0.6);
      background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%);
    }

    #claude-overlay-btn:active {
      transform: scale(0.95);
    }

    /* Claude-style overlay container */
    .claude-overlay-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .claude-overlay-container.active {
      opacity: 1;
      visibility: visible;
    }

    /* Claude-style overlay content */
    .claude-overlay-content {
      background: #ffffff;
      width: 90%;
      max-width: 1200px;
      height: 85vh;
      max-height: 800px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      transform: scale(0.9) translateY(20px);
      transition: all 0.3s ease;
      overflow: hidden;
      position: relative;
    }

    .claude-overlay-container.active .claude-overlay-content {
      transform: scale(1) translateY(0);
    }

    /* Clear chat button in header */
    .claude-clear-btn {
     color: #f59e0b;
    }

    .claude-clear-btn:hover {
    background: #fef3c7;
    color: #d97706;
    }
    /* Minimize state */
    .claude-overlay-content.minimized {
      height: 60px;
      min-height: 60px;
      width: 400px;
      transform: scale(1);
    }

    .claude-overlay-content.minimized .claude-overlay-body {
      display: none;
    }

    /* Maximize state */
    .claude-overlay-content.maximized {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      border-radius: 0;
    }

    /* Claude overlay header */
    .claude-overlay-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fafafa;
    }

    .claude-overlay-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .claude-overlay-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .claude-overlay-action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: #6b7280;
    }

    .claude-overlay-action-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .claude-home-btn {
      color: #10b981;
    }

    .claude-home-btn:hover {
      background: #d1fae5;
      color: #059669;
    }

    .claude-close-btn {
      color: #ef4444;
    }

    .claude-close-btn:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    /* Claude overlay body */
    .claude-overlay-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #f9fafb;
    }

    /* Chat container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Messages area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: white;
    }

    .messages-area::-webkit-scrollbar {
      width: 8px;
    }

    .messages-area::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .messages-area::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Message styles */
    .message {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .user-avatar {
      background: #7c3aed;
      color: white;
    }

    .assistant-avatar {
      background: #10b981;
      color: white;
    }

    .message-content {
      flex: 1;
    }

    .message-role {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }

    .message-text {
      color: #1f2937;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message-text p {
      margin-bottom: 12px;
    }

    .message-text p:last-child {
      margin-bottom: 0;
    }

    .message-text code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .message-text pre {
      background: #1f2937;
      color: #f3f4f6;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
    }

    .message-text pre code {
      background: transparent;
      padding: 0;
      color: #f3f4f6;
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: #e5e7eb;
      border-radius: 20px;
      width: fit-content;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #6b7280;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingBounce {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }

    /* Input area */
    .input-area {
      border-top: 1px solid #e5e7eb;
      background: white;
      padding: 16px;
    }

    .input-area.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      max-width: 900px;
      margin: 0 auto;
    }

    .chat-input-wrapper {
      flex: 1;
      position: relative;
    }

    .chat-input {
      width: 100%;
      min-height: 70px;
      max-height: 250px;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      font-size: 18px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: all 0.2s ease;
      line-height: 1.6;
    }

    .chat-input:focus {
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .chat-input::placeholder {
      color: #9ca3af;
    }

    .send-button {
      width: 48px;
      height: 48px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-button:hover:not(:disabled) {
      background: #6d28d9;
      transform: scale(1.05);
    }

    .send-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .send-button:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* Welcome message */
    .welcome-message {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .welcome-title {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .welcome-subtitle {
      font-size: 16px;
      margin-bottom: 24px;
    }

    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .suggestion-chip {
      background: white;
      border: 1px solid #e5e7eb;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-chip:hover {
      background: #f3f4f6;
      border-color: #7c3aed;
      color: #7c3aed;
      transform: translateY(-1px);
    }

    /* Authentication Modal Styles */
    .auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .auth-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .auth-modal-content {
      background: #ffffff;
      width: 90%;
      max-width: 450px;
      border-radius: 20px;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
      transform: scale(0.8) translateY(30px);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .auth-modal.active .auth-modal-content {
      transform: scale(1) translateY(0);
    }

    .auth-modal-header {
      padding: 30px 30px 20px;
      text-align: center;
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      color: white;
    }

    .auth-modal-header h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .auth-modal-header p {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
    }

    .auth-modal-body {
      padding: 30px;
    }

    .auth-form-group {
      margin-bottom: 20px;
    }

    .auth-form-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .auth-form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background-color: #f9fafb;
    }

    .auth-form-group input:focus {
      outline: none;
      border-color: #4ECDC4;
      background-color: #ffffff;
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
    }

    .auth-form-group input.error {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .auth-error {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }

    .auth-error.show {
      display: block;
    }

    .auth-modal-footer {
      padding: 0 30px 30px;
      display: flex;
      gap: 12px;
    }

    .auth-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .auth-btn.cancel {
      background: #f3f4f6;
      color: #6b7280;
    }

    .auth-btn.cancel:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .auth-btn.login {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
    }

    .auth-btn.login:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }

    .auth-btn.login:disabled {
      background: #d1d5db;
      color: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .auth-loading {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    /* User session indicator */
    .user-session-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-session-indicator.active {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-session-indicator .user-avatar-small {
      width: 24px;
      height: 24px;
      background: #4ECDC4;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    /* Welcome options styles */
    .welcome-options {
      display: flex;
      flex-direction: row;
      gap: 15px;
      margin-top: 24px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
    }

    .welcome-option {
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      border: none;
      padding: 14px 20px !important;
      border-radius: 25px !important;
      font-size: 12px !important;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: inline-flex !important;
      align-items: center;
      gap: 8px !important;
      justify-content: center;
      white-space: nowrap;
      min-width: fit-content;
      width: auto;
    }

    .welcome-option.option-2 {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%) !important;
    }

    .welcome-option:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25) !important;
    }

    .welcome-option:active {
      transform: translateY(-1px) scale(0.98);
    }

    .welcome-option-icon {
      font-size: 14px !important;
      flex-shrink: 0;
    }

    .welcome-option-text {
      font-size: 12px !important;
      line-height: 1.2;
      white-space: nowrap;
    }

    /* Mobile responsive - stack on small screens */
    @media (max-width: 700px) {
      .welcome-options {
        flex-direction: column;
        gap: 12px;
        flex-wrap: wrap;
      }

      .welcome-option {
        font-size: 13px !important;
        padding: 16px 24px !important;
      }

      .welcome-option-text {
        font-size: 13px !important;
      }
    }

    /* Voice button styles */
    #voiceToggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
      color: white;
      border: none;
      border-radius: 30px;
      padding: 15px 25px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      z-index: 100;
      transition: all 0.3s ease;
      animation: pulse 2s ease-in-out infinite;
    }

    #voiceToggle:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6) !important;
      background: linear-gradient(135deg, #FF8E53 0%, #FF6B6B 100%) !important;
    }

    #voiceToggle:active {
      transform: scale(0.95) !important;
    }

    /* Responsive adjustments */
    @media (max-width: 1400px) {
      .left-features, .right-features {
        display: none;
      }
    }

    @media (max-width: 1200px) {
      .button-container {
        flex-direction: column;
        gap: 20px;
      }

      .button-with-arrow {
        width: 100%;
        justify-content: center;
      }

      .animated-arrow {
        transform: rotate(90deg);
      }

      @keyframes arrowPulse {
        0% {
          transform: rotate(90deg) translateY(-10px) scale(0.9);
          opacity: 0.4;
        }
        25% {
          transform: rotate(90deg) translateY(0px) scale(1);
          opacity: 0.7;
        }
        50% {
          transform: rotate(90deg) translateY(15px) scale(1.2);
          opacity: 1;
        }
        75% {
          transform: rotate(90deg) translateY(5px) scale(1.1);
          opacity: 0.8;
        }
        100% {
          transform: rotate(90deg) translateY(-10px) scale(0.9);
          opacity: 0.4;
        }
      }
    }

    @media (max-width: 768px) {
      .cta-button {
        min-width: 250px;
        font-size: 1em;
        padding: 15px 25px;
      }

      .animated-arrow {
        font-size: 25px;
      }

      .claude-overlay-content {
        width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
      }

      .auth-modal-content {
        width: 95%;
        margin: 0 10px;
      }

      .auth-modal-header,
      .auth-modal-body,
      .auth-modal-footer {
        padding-left: 20px;
        padding-right: 20px;
      }

      .welcome-options {
        gap: 12px;
      }

      .welcome-option {
        padding: 15px 30px !important;
        min-width: 280px !important;
        font-size: 16px !important;
      }
    }
  </style>
</head>
<body>
    <!-- User Session Indicator -->
    <div class="user-session-indicator" id="userSessionIndicator">
        <div class="user-avatar-small" id="userAvatarSmall">U</div>
        <span id="userSessionName">Guest</span>
    </div>

    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>üîê Session Login</h2>
                <p>Enter any username to create your isolated session</p>
            </div>
            <div class="auth-modal-body">
                <div class="auth-error" id="authError">
                    Please enter both username and password to continue.
                </div>
                <div class="auth-form-group">
                    <label for="authUsername">Username</label>
                    <input type="text" id="authUsername" placeholder="Enter your username" autocomplete="username">
                </div>
                <div class="auth-form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" placeholder="Enter your password" autocomplete="current-password">
                </div>
            </div>
            <div class="auth-modal-footer">
                <button class="auth-btn cancel" onclick="closeAuthModal()">Cancel</button>
                <button class="auth-btn login" id="authLoginBtn" onclick="performLogin()">
                    <span id="authLoginText">Login</span>
                    <div class="auth-loading" id="authLoading" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Claude-style overlay button -->
    <button id="claude-overlay-btn" onclick="openClaudeOverlay()" title="Open Advanced Interface">
        <span style="font-size: 20px;">üöÄ</span>
        <span>Chat With Me! </span>
    </button>

    <!-- Claude-style overlay -->
    <div class="claude-overlay-container" id="claudeOverlayContainer" onclick="handleClaudeOverlayClick(event)">
        <div class="claude-overlay-content" id="claudeOverlayContent">
            <!-- Header -->
            <div class="claude-overlay-header">
                <div class="claude-overlay-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    AI Assistant
                </div>
                <div class="claude-overlay-actions">
                    <button class="claude-overlay-action-btn claude-home-btn" onclick="goToHome()" title="Go to Home">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </button>
                    <!-- ADD THIS CLEAR BUTTON -->
                    <button class="claude-overlay-action-btn claude-clear-btn" id="clearChatBtnHeader" onclick="clearChatHistory()" title="Clear Chat History" style="display: none;">
                         <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                               <line x1="10" y1="11" x2="10" y2="17"/>
                               <line x1="14" y1="11" x2="14" y2="17"/>
                          </svg>
                    </button>
                    <button class="claude-overlay-action-btn" onclick="maximizeClaudeOverlay()" title="Maximize">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                        </svg>
                    </button>
                    <button class="claude-overlay-action-btn claude-close-btn" onclick="closeClaudeOverlay()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Body -->
            <div class="claude-overlay-body">
                <div class="chat-container">
                    <!-- Messages area -->
                    <div class="messages-area" id="messagesArea">
                        <!-- Welcome message -->
                        <div class="welcome-message" id="welcomeMessage">
                            <div class="welcome-icon">ü§ñ</div>
                            <div class="welcome-title">Welcome to API Assistant</div>
                            <div class="welcome-subtitle">How can I help you today?</div>
                            <div class="welcome-options">
                                <button class="welcome-option option-1" onclick="selectToolAssistance(event)">
                                    <span class="welcome-option-icon">üìö</span>
                                    <span class="welcome-option-text">Want to learn more about this tool?</span>
                                </button>
<!--                                <button class="welcome-option option-2" onclick="selectAIAssistance(event)">-->
<!--                                    <span class="welcome-option-icon">ü§ñ</span>-->
<!--                                    <span class="welcome-option-text">Would you need AI assistance?</span>-->
<!--                                </button>-->
                            </div>
                        </div>
                    </div>

                    <!-- Input area -->
                    <div class="input-area disabled" id="inputArea">
                        <div class="input-container">
                            <div class="chat-input-wrapper">
                                <textarea
                                    class="chat-input"
                                    id="chatInput"
                                    placeholder="Please select an option above to continue..."
                                    rows="1"
                                    onkeydown="handleChatKeydown(event)"
                                    oninput="adjustTextareaHeight(this)"
                                    disabled
                                ></textarea>
                            </div>
                            <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Left side features -->
    <div class="left-features">
        <div class="features">
            <div class="feature">
                <div class="feature-icon">üöÄ</div>
                <div class="feature-content">
                    <h3>Smart Discovery</h3>
                    <p>Automatically discover all APIs from New Relic data</p>
                </div>
            </div>
            <div class="feature">
                <div class="feature-icon">ü§ñ</div>
                <div class="feature-content">
                    <h3>AI-Powered</h3>
                    <p>Generate intelligent test cases with LLM integration</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right side features -->
    <div class="right-features">
        <div class="features">
            <div class="feature">
                <div class="feature-icon">üìä</div>
                <div class="feature-content">
                    <h3>Deep Analytics</h3>
                    <p>Comprehensive performance and error analysis</p>
                </div>
            </div>
            <div class="feature">
                <div class="feature-icon">üîí</div>
                <div class="feature-content">
                    <h3>Secure Testing</h3>
                    <p>Enterprise-grade security for your API tests</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-section">
            <div class="logo-container">
                <div class="logo">üîç</div>
                <h1>AI Discovery Suite</h1>
            </div>
            <p class="subtitle">
                Discover, analyze, and test your APIs with AI-powered intelligence.<br>
                Complete New Relic integration with smart test case generation.
            </p>
        </div>

        <div class="middle-section">
            <div class="bottom-section">
                <div class="button-container">
                    <div class="button-with-arrow">
                        <span class="animated-arrow arrow-1">‚û§</span>
                        <button class="cta-button primary" id="llmApiBtn">
                            <span>üöÄ</span>
                            <span>Launch LLM Discovery</span>
                            <div class="loading-ring" id="loadingRing"></div>
                        </button>
                    </div>

                    <div class="button-with-arrow">
                        <span class="animated-arrow arrow-2">‚û§</span>
                        <button class="cta-button secondary" id="prdTestBtn" title="PRD Test Case Generation">
                            <span>üìù</span>
                            <span>PRD Test Case Generation</span>
                        </button>
                    </div>

                    <div class="button-with-arrow">
                        <span class="animated-arrow arrow-3">‚û§</span>
                        <button class="cta-button tertiary" id="apiTestBtn" title="API Test Generation">
                            <span>üß™</span>
                            <span>API Test Generation</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <button id="voiceToggle" title="Click for voice guidance">
            <span style="font-size: 20px;">üí°</span>
            <span>Need Help?</span>
        </button>

        <div class="footer">
            Powered by Cargoes Runner Advanced AI Model
        </div>
    </div>

    <!-- PRD Test Case Generation Modal -->
    <div class="modal" id="prdTestModal">
        <div class="modal-content prd-modal-content">
            <div class="modal-header">
                <h2>PRD Test Case Generation</h2>
            </div>

            <div class="checkbox-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="prdUserStoryEpic">
                    <label for="prdUserStoryEpic">PRD Test Case Generation from Epic/User story</label>
                </div>
                <div class="expandable" id="prdUserStoryEpicExpand">
                    <div class="form-group">
                        <label for="azureToken">Azure Token <span style="color: red;">*</span></label>
                        <input type="text" id="azureToken" placeholder="Enter the AZ token" />
                    </div>

                    <div class="form-group">
                        <label for="epicNo">Epic No</label>
                        <input type="text" id="epicNo" placeholder="Enter Epic No (Optional)" />
                    </div>

                    <div class="form-group">
                        <label for="userStoryNo">User Story No <span style="color: red;">*</span></label>
                        <input type="text" id="userStoryNo" placeholder="User Story with comma separate Ex: US123, US12" />
                    </div>

                    <div class="agreement-section">
                        <div class="agreement-container">
                            <input type="checkbox" id="prdAgreement" disabled>
                            <label for="prdAgreement" id="prdAgreementLabel" class="disabled">
                                I confirm, that the data given above are correct
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="process-btn" id="processPRDBtn" disabled>
                            <span>‚öôÔ∏è</span>
                            <span>Generate Test Cases</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="checkbox-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="prdUpload">
                    <label for="prdUpload">PRD Test Case Generation to upload the PRD</label>
                </div>
                <div class="expandable" id="prdUploadExpand">
                    <div class="form-group">
                        <label for="prdFile">Upload PRD Document <span style="color: red;">*</span></label>
                        <input type="file" id="prdFile" accept=".pdf,.doc,.docx,.txt" style="padding: 10px; background: #f8f9fa; border: 2px dashed #667eea; border-radius: 8px; width: 100%; cursor: pointer;" />
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Supported formats: PDF, DOC, DOCX, TXT
                        </small>
                    </div>

                    <div class="form-actions">
                        <button class="process-btn" id="processUploadPRDBtn">
                            <span>üìÑ</span>
                            <span>Generate Test Cases from Document</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="checkbox-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="customizeTestGeneration">
                    <label for="customizeTestGeneration">AI-Powered Flexi Test Case Generation</label>
                </div>
                <div class="expandable" id="customizeTestGenerationExpand">
                    <div class="form-group">
                        <label for="customTestInput">Describe Your Test Requirements</label>
                        <textarea id="customTestInput"
                                  placeholder="Enter your requirements or specifications here..."
                                  style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="process-btn" id="processCustomTestBtn">
                            <span>‚ú®</span>
                            <span>Generate Test Cases</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group info-box">
                <p>‚ÑπÔ∏è Select one of the above options to generate comprehensive test cases from your Product Requirements Document.</p>
            </div>

            <div class="modal-footer">
                <button class="modal-btn close" id="closePRDModalBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- API Test Generation Modal -->
    <div class="modal" id="apiTestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>API Test Generation Options</h2>
                <p>Select your preferred test generation method</p>
            </div>

            <div class="checkbox-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="manualApiTest">
                    <label for="manualApiTest">Manual API Test Case Generation</label>
                </div>
                <div class="expandable" id="manualExpand">
                    <div class="form-group">
                        <label for="apiEndpoint">1. API Endpoint</label>
                        <input type="text" id="apiEndpoint" placeholder="e.g., https://api.example.com/users" />
                    </div>

                    <div class="form-group">
                        <label for="httpMethod">2. HTTP Method</label>
                        <select id="httpMethod">
                            <option value="">Select Method</option>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="requestBody">3. Request Body/Payload <span class="optional">(optional)</span></label>
                        <textarea id="requestBody" placeholder='{"key": "value"}'></textarea>
                    </div>

                    <div class="form-group">
                        <label for="response">4. Response <span class="optional">(optional)</span></label>
                        <textarea id="response" placeholder='{"status": "success", "data": {...}}'></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="process-btn" id="processManualTestBtn">
                            <span>‚öôÔ∏è</span>
                            <span>Process Test Case</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="checkbox-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="swaggerApiTest">
                    <label for="swaggerApiTest">Swagger API Test Generation</label>
                </div>
                <div class="expandable" id="swaggerExpand">
                    <div class="form-group">
                        <label for="swaggerUrl">Swagger URL</label>
                        <input type="text" id="swaggerUrl" placeholder="e.g., https://api.example.com" />
                    </div>

                    <div class="form-group">
                        <label for="swaggerApiEndpoint">API Endpoint</label>
                        <input type="text" id="swaggerApiEndpoint" placeholder="e.g., /users/create" />
                    </div>

                    <div class="form-actions">
                        <button class="fetch-btn" id="fetchSwaggerBtn">
                            <span>üì°</span>
                            <span>Fetch Swagger Data</span>
                        </button>
                    </div>

                    <div id="swaggerResult" style="display: none;" class="swagger-result">
                        <!-- Swagger results will be displayed here -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="modal-btn close" id="closeApiModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Prompt Selection Modal -->
    <div class="prompt-modal" id="promptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Test Generation Type</h2>
                <p>Choose the type of test case you want to generate</p>
            </div>

            <div class="prompt-options" id="promptOptions">
                <!-- Options will be dynamically loaded here -->
            </div>

            <div class="modal-footer">
                <button class="modal-btn close" id="closePromptModalBtn">Cancel</button>
                <button class="modal-btn submit" id="generateTestCaseBtn">Generate Smart Test Case</button>
            </div>
        </div>
    </div>

    <!-- Test Case Result Modal -->
    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <div class="result-header">
                <h3>Generated Test Case</h3>
                <div class="result-meta" id="resultMeta"></div>
            </div>

            <div class="result-body" id="resultBody">
                <!-- Test case will be displayed here -->
            </div>

            <div class="result-actions">
                <div class="result-info" id="resultInfo"></div>
                <div class="result-buttons">
                    <button class="copy-btn" id="copyTestCaseBtn">
                        <span>üìã</span> Copy to Clipboard
                    </button>
                    <!-- PRD Test Download with dropdown -->
                    <div id="prdDownloadContainer" style="position: relative; display: none;">
                        <button class="download-btn" id="downloadTestCaseBtnPRD" onclick="toggleDownloadOptions(event)">
                            <span>üíæ</span> Download
                        </button>
                        <div class="download-options" id="downloadOptions">
                            <button class="download-option" onclick="downloadAsFormat('excel')">
                                <span class="download-option-icon">üìä</span>
                                <span>Download As Excel</span>
                            </button>
                            <button class="download-option" onclick="downloadAsFormat('txt')">
                                <span class="download-option-icon">üìÑ</span>
                                <span>Download As Text</span>
                            </button>
                        </div>
                    </div>
                    <!-- API Test Download (single button) -->
                    <button class="download-btn" id="apiDownloadBtn" onclick="downloadTestCaseSimple()" style="display: none;">
                        <span>üíæ</span> Download
                    </button>
                    <button class="modal-btn close" id="closeResultModalBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============== SESSION MANAGEMENT ==============

    // Session storage key prefix to isolate user data
    const SESSION_PREFIX = 'chatSession_';

    // Current user session data
    let currentUserSession = {
        username: null,
        sessionId: null,
        chatHistory: [],
        isAuthenticated: false,
        loginTime: null
    };

    // Generate unique session ID
    function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Get session storage key for current user
    function getSessionStorageKey(key) {
        if (!currentUserSession.username) return null;
        return SESSION_PREFIX + currentUserSession.username + '_' + key;
    }

    // Save user session data
    function saveUserSessionData() {
        if (!currentUserSession.username) return;

        const sessionData = {
            username: currentUserSession.username,
            sessionId: currentUserSession.sessionId,
            chatHistory: currentUserSession.chatHistory,
            isAuthenticated: currentUserSession.isAuthenticated,
            loginTime: currentUserSession.loginTime,
            lastActivity: Date.now()
        };

        try {
            localStorage.setItem(getSessionStorageKey('data'), JSON.stringify(sessionData));
            console.log(`Session data saved for user: ${currentUserSession.username}`);
        } catch (error) {
            console.error('Failed to save session data:', error);
        }
    }

    // Load user session data
    function loadUserSessionData(username) {
        try {
            const sessionKey = SESSION_PREFIX + username + '_data';
            const sessionData = localStorage.getItem(sessionKey);

            if (sessionData) {
                const parsed = JSON.parse(sessionData);

                // Check if session is still valid (within 24 hours)
                const sessionAge = Date.now() - (parsed.lastActivity || parsed.loginTime || 0);
                const MAX_SESSION_AGE = 24 * 60 * 60 * 1000; // 24 hours

                if (sessionAge > MAX_SESSION_AGE) {
                    console.log(`Session expired for user: ${username}`);
                    clearUserSessionData(username);
                    return null;
                }

                console.log(`Session data loaded for user: ${username}`, {
                    chatHistoryCount: parsed.chatHistory?.length || 0,
                    sessionAge: Math.round(sessionAge / 1000 / 60) + ' minutes'
                });

                return parsed;
            }
        } catch (error) {
            console.error('Failed to load session data:', error);
        }

        return null;
    }

    // Clear user session data
    function clearUserSessionData(username) {
        if (!username) return;

        try {
            const sessionKey = SESSION_PREFIX + username + '_data';
            localStorage.removeItem(sessionKey);
            console.log(`Session data cleared for user: ${username}`);
        } catch (error) {
            console.error('Failed to clear session data:', error);
        }
    }

    // Initialize user session
    function initializeUserSession(username) {
        // First, try to load existing session data
        const existingSession = loadUserSessionData(username);

        if (existingSession) {
            // Restore existing session
            currentUserSession = {
                username: existingSession.username,
                sessionId: existingSession.sessionId,
                chatHistory: existingSession.chatHistory || [],
                isAuthenticated: true,
                loginTime: existingSession.loginTime
            };

            console.log(`Restored session for user: ${username}`, {
                sessionId: currentUserSession.sessionId,
                chatHistoryCount: currentUserSession.chatHistory.length
            });
        } else {
            // Create new session
            currentUserSession = {
                username: username,
                sessionId: generateSessionId(),
                chatHistory: [],
                isAuthenticated: true,
                loginTime: Date.now()
            };

            console.log(`New session created for user: ${username}`, {
                sessionId: currentUserSession.sessionId
            });
        }

        // Save the session data
        saveUserSessionData();

        // Update UI
        updateUserSessionIndicator();
    }

    // Clear current session (logout)
    function clearCurrentSession() {
        if (currentUserSession.username) {
            console.log(`Clearing session for user: ${currentUserSession.username}`);
        }

        currentUserSession = {
            username: null,
            sessionId: null,
            chatHistory: [],
            isAuthenticated: false,
            loginTime: null
        };

        // Update UI
        updateUserSessionIndicator();
    }

    // Update user session indicator in UI
    function updateUserSessionIndicator() {
        const indicator = document.getElementById('userSessionIndicator');
        const avatar = document.getElementById('userAvatarSmall');
        const name = document.getElementById('userSessionName');

        if (currentUserSession.isAuthenticated && currentUserSession.username) {
            indicator.classList.add('active');
            avatar.textContent = currentUserSession.username.charAt(0).toUpperCase();
            name.textContent = currentUserSession.username;
        } else {
            indicator.classList.remove('active');
            avatar.textContent = 'U';
            name.textContent = 'Guest';
        }
    }

    // ============== AUTHENTICATION ==============

    // No credential validation - just screen login for session isolation
    // Any username/password combination is accepted

    // Authentication functions
    function showAuthModal() {
        const modal = document.getElementById('authModal');
        modal.classList.add('active');

        // Clear previous inputs and errors
        document.getElementById('authUsername').value = '';
        document.getElementById('authPassword').value = '';
        document.getElementById('authError').classList.remove('show');

        // Remove error styles
        document.getElementById('authUsername').classList.remove('error');
        document.getElementById('authPassword').classList.remove('error');

        // Focus on username field
        setTimeout(() => {
            document.getElementById('authUsername').focus();
        }, 300);
    }

    function closeAuthModal() {
        const modal = document.getElementById('authModal');
        modal.classList.remove('active');
    }

    function showAuthError(message) {
        const errorDiv = document.getElementById('authError');
        errorDiv.textContent = message;
        errorDiv.classList.add('show');

        // Add error styles to inputs
        document.getElementById('authUsername').classList.add('error');
        document.getElementById('authPassword').classList.add('error');
    }

    async function performLogin() {
        const username = document.getElementById('authUsername').value.trim();
        const password = document.getElementById('authPassword').value.trim();
        const loginButton = document.getElementById('authLoginBtn');
        const loginText = document.getElementById('authLoginText');
        const loginLoading = document.getElementById('authLoading');

        // Clear previous errors
        document.getElementById('authError').classList.remove('show');
        document.getElementById('authUsername').classList.remove('error');
        document.getElementById('authPassword').classList.remove('error');

        // Validation
        if (!username || !password) {
            showAuthError('Please enter both username and password.');
            return;
        }

        // Show loading state
        loginButton.disabled = true;
        loginText.textContent = 'Logging in...';
        loginLoading.style.display = 'block';

        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1500));

        // Check credentials - accept any non-empty username/password combination
        if (username && password) {
            // Success - any username/password combination works (just for session isolation)
            initializeUserSession(username);

            console.log(`User logged in with screen login: ${username}`);
            closeAuthModal();

            // Proceed with AI assistance
            proceedWithAIAssistance();

        } else {
            // Failed - only fail if fields are empty
            showAuthError('Please enter both username and password.');
        }

        // Reset loading state
        loginButton.disabled = false;
        loginText.textContent = 'Login';
        loginLoading.style.display = 'none';
    }

    function proceedWithAIAssistance() {
        // Clear welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }

        // Restore existing chat history if available
        if (currentUserSession.chatHistory.length > 0) {
            console.log(`Restoring ${currentUserSession.chatHistory.length} previous messages`);

            // Clear messages area first
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';

            // Restore each message
            currentUserSession.chatHistory.forEach(msg => {
                addMessageToUI(msg.role, msg.content, false); // false = don't save to history again
            });
        } else {
            // Add personalized initial AI assistant message for new session
            const welcomeMsg = currentUserSession.username
                ? `Hello ${currentUserSession.username}! I'm your AI Assistant. Authentication successful! I can help you with any questions or tasks you have. Feel free to ask me anything.`
                : `Hello! I'm your AI Assistant. Authentication successful! I can help you with any questions or tasks you have. Feel free to ask me anything.`;

            addMessage('assistant', welcomeMsg);
        }

        // Enable input area
        const inputArea = document.getElementById('inputArea');
        inputArea.classList.remove('disabled');

        // Enable chat input
        const chatInput = document.getElementById('chatInput');
        chatInput.disabled = false;
        chatInput.placeholder = 'Ask me anything...';

        // Enable send button
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = false;

        // Show clear button
        const clearChatBtnHeader = document.getElementById('clearChatBtnHeader');
        clearChatBtnHeader.style.display = 'flex';

        // Focus on input
        setTimeout(() => {
            chatInput.focus();
        }, 100);

        // Set AI assistance mode
        window.isAIAssistanceMode = true;

        console.log('AI Assistance mode activated with authentication for user:', currentUserSession.username);
    }

    // Handle Enter key in auth modal
    document.addEventListener('keydown', function(event) {
        const authModal = document.getElementById('authModal');
        if (authModal.classList.contains('active') && event.key === 'Enter') {
            event.preventDefault();
            performLogin();
        }
    });

    // ============== CHAT FUNCTIONALITY ==============

    // Global variables
    let selectedPromptType = null;
    let currentTestData = null;
    let availablePromptsData = [];
    let fullTestCaseContent = ''; // Store the full content
    let currentTestType = 'api'; // Track whether it's 'prd' or 'api' test
    let overlayStates = {
        isMaximized: false
    };

    // Track if voice is currently playing
    let isVoicePlaying = false;

    // Enhanced copy test case to clipboard - Fixed for localhost and HTTP/HTTPS
    window.copyTestCase = async function copyTestCase() {
        console.log('[copyTestCase] === Starting Copy Operation ===');
        console.log('[copyTestCase] Function called at:', new Date().toISOString());

        try {
            // Get the text to copy
            const resultBody = document.getElementById('resultBody');
            console.log('[copyTestCase] Result body element found:', !!resultBody);

            if (!resultBody) {
                console.error('[copyTestCase] ERROR: Result body element not found');
                alert('Error: No content to copy. Please generate a test case first.');
                return false;
            }

            // Get text content - try multiple methods
            let text = '';
            if (resultBody.value !== undefined && resultBody.value) {
                text = resultBody.value;
                console.log('[copyTestCase] Got text from .value');
            } else if (resultBody.textContent !== undefined && resultBody.textContent) {
                text = resultBody.textContent;
                console.log('[copyTestCase] Got text from .textContent');
            } else if (resultBody.innerText !== undefined && resultBody.innerText) {
                text = resultBody.innerText;
                console.log('[copyTestCase] Got text from .innerText');
            } else if (resultBody.innerHTML !== undefined && resultBody.innerHTML) {
                // Last resort - strip HTML
                text = resultBody.innerHTML.replace(/<[^>]*>/g, '');
                console.log('[copyTestCase] Got text from .innerHTML (stripped)');
            }

            console.log('[copyTestCase] Text length to copy:', text.length);
            console.log('[copyTestCase] First 100 chars:', text.substring(0, 100));

            if (!text || text.trim() === '') {
                console.warn('[copyTestCase] WARNING: No text content to copy');
                alert('No content to copy. The result body is empty.');
                return false;
            }

            // Check environment
            console.log('[copyTestCase] Environment Check:');
            console.log('[copyTestCase] - URL:', window.location.href);
            console.log('[copyTestCase] - Protocol:', window.location.protocol);
            console.log('[copyTestCase] - Hostname:', window.location.hostname);
            console.log('[copyTestCase] - Is localhost?:', window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
            console.log('[copyTestCase] - Is Secure Context:', window.isSecureContext);
            console.log('[copyTestCase] - Navigator.clipboard exists?:', 'clipboard' in navigator);
            console.log('[copyTestCase] - Navigator.clipboard.writeText exists?:', navigator.clipboard && typeof navigator.clipboard.writeText === 'function');

            // Method 1: Try modern clipboard API (should work on localhost)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                console.log('[copyTestCase] Attempting Method 1: Modern Clipboard API...');
                try {
                    await navigator.clipboard.writeText(text);
                    console.log('[copyTestCase] ‚úÖ SUCCESS: Copied using modern Clipboard API');
                    return true;  // IMPORTANT: Return true on success
                } catch (clipboardError) {
                    console.error('[copyTestCase] ‚ùå Clipboard API error:', clipboardError);
                    console.error('[copyTestCase] Error name:', clipboardError.name);
                    console.error('[copyTestCase] Error message:', clipboardError.message);
                    // Don't return false here, try the next method
                }
            } else {
                console.log('[copyTestCase] Clipboard API not available');
            }

            // Method 2: Try with execCommand (older but reliable)
            console.log('[copyTestCase] Attempting Method 2: document.execCommand...');

            // Create textarea
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '0';
            textArea.style.top = '0';
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = '0';
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            let execCommandResult = false;
            try {
                execCommandResult = document.execCommand('copy');
                console.log('[copyTestCase] execCommand result:', execCommandResult);
            } catch (execError) {
                console.error('[copyTestCase] execCommand error:', execError);
            }

            document.body.removeChild(textArea);

            if (execCommandResult) {
                console.log('[copyTestCase] ‚úÖ SUCCESS: Copied using execCommand');
                return true;
            } else {
                console.log('[copyTestCase] ‚ùå execCommand failed, trying manual method...');
            }

            // Method 3: Fallback with user interaction
            console.log('[copyTestCase] Attempting Method 3: Manual copy with user interaction...');

            // Create a temporary element with the text
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'fixed';
            tempContainer.style.left = '50%';
            tempContainer.style.top = '50%';
            tempContainer.style.transform = 'translate(-50%, -50%)';
            tempContainer.style.background = 'white';
            tempContainer.style.padding = '20px';
            tempContainer.style.border = '2px solid #007bff';
            tempContainer.style.borderRadius = '10px';
            tempContainer.style.zIndex = '10000';
            tempContainer.style.maxWidth = '80%';
            tempContainer.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';

            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.width = '100%';
            textarea.style.height = '200px';
            textarea.style.marginBottom = '10px';
            textarea.readOnly = true;

            const instruction = document.createElement('p');
            instruction.innerHTML = '<strong>Please select all text above (Ctrl+A/Cmd+A) and copy (Ctrl+C/Cmd+C)</strong>';
            instruction.style.marginBottom = '10px';
            instruction.style.textAlign = 'center';

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Done';
            closeBtn.style.padding = '10px 30px';
            closeBtn.style.background = '#28a745';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.display = 'block';
            closeBtn.style.margin = '0 auto';

            tempContainer.appendChild(textarea);
            tempContainer.appendChild(instruction);
            tempContainer.appendChild(closeBtn);
            document.body.appendChild(tempContainer);

            // Auto-select the text
            textarea.select();
            textarea.focus();

            return new Promise((resolve) => {
                closeBtn.onclick = () => {
                    document.body.removeChild(tempContainer);
                    console.log('[copyTestCase] ‚úÖ Manual copy completed');
                    resolve(true);
                };
            });

        } catch (error) {
            console.error('[copyTestCase] ‚ùå CRITICAL ERROR:', error);
            console.error('[copyTestCase] Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });

            alert('Copy operation failed. Please manually select and copy the text from the result area.');
            return false;
        } finally {
            console.log('[copyTestCase] === Copy Operation Completed ===');
        }
    }

    // Function to show result modal
    function showResultModal(title, content) {
        const modal = document.getElementById('resultModal');
        const resultBody = document.getElementById('resultBody');
        const resultMeta = document.getElementById('resultMeta');

        // Set the content
        resultBody.textContent = content;
        resultMeta.textContent = `Generated on ${new Date().toLocaleString()}`;

        // Show the modal
        modal.classList.add('active');
    }

    // Claude overlay functions
    function openClaudeOverlay() {
        const overlay = document.getElementById('claudeOverlayContainer');
        overlay.classList.add('active');

        // Don't focus on input immediately since it's hidden by default
    }

    function closeClaudeOverlay() {
        const overlay = document.getElementById('claudeOverlayContainer');
        overlay.classList.remove('active');
    }

    function maximizeClaudeOverlay() {
        const content = document.getElementById('claudeOverlayContent');

        if (overlayStates.isMaximized) {
            // Restore from maximize
            content.classList.remove('maximized');
            overlayStates.isMaximized = false;
        } else {
            // Maximize
            content.classList.add('maximized');
            overlayStates.isMaximized = true;
        }
    }

    function goToHome() {
        // Clear all messages except welcome message
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.innerHTML = '';

        // Re-add welcome message with options (matching the initial structure)
        const welcomeMessageHTML = `
            <div class="welcome-message" id="welcomeMessage">
                <div class="welcome-icon">ü§ñ</div>
                <div class="welcome-title">Welcome to AI Assistant</div>
                <div class="welcome-subtitle">How can I help you today?</div>
                <div class="welcome-options">
                    <button class="welcome-option option-1" onclick="selectToolAssistance(event)">
                        <span class="welcome-option-icon">üìö</span>
                        <span class="welcome-option-text">Want to learn more about this tool?</span>
                    </button>
<!--                    <button class="welcome-option option-2" onclick="selectAIAssistance(event)">-->
<!--                        <span class="welcome-option-icon">ü§ñ</span>-->
<!--                        <span class="welcome-option-text">Would you need AI assistance?</span>-->
<!--                    </button>-->
                </div>
            </div>
        `;

        messagesArea.innerHTML = welcomeMessageHTML;

        // Disable input area
        const inputArea = document.getElementById('inputArea');
        inputArea.classList.add('disabled');

        // Disable and reset chat input
        const chatInput = document.getElementById('chatInput');
        chatInput.value = '';
        chatInput.disabled = true;
        chatInput.placeholder = 'Please select an option above to continue...';
        adjustTextareaHeight(chatInput);

        // Disable send button
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        // Hide clear button
        const clearChatBtnHeader = document.getElementById('clearChatBtnHeader');
        clearChatBtnHeader.style.display = 'none';

        // Reset mode but keep session
        window.isAIAssistanceMode = false;

        // Clear current session's chat history
        currentUserSession.chatHistory = [];
        saveUserSessionData();

        console.log('Went to home - chat history cleared for current session');
    }


<!-- =============   select TOOL Assistance ==========-->

const CORRECT_TOOL_RESPONSES = {
    "prd": `**How to Generate PRD Test Cases:**

‚úÖ **Upload PRD documents** (PDF, DOC, DOCX, TXT formats)
‚úÖ **AI analyzes requirements** and extracts testable scenarios
‚úÖ **Generates detailed test cases** with steps, expected results
‚úÖ **Azure DevOps integration** - sync with Epics and User Stories
‚úÖ **Maps requirements to tests** for full traceability

Also you can give the epic and userstory, LLM will provide the test case.

**Generated Test Types:**
‚Ä¢ Functional test cases
‚Ä¢ Edge case scenarios
‚Ä¢ Integration test scenarios
‚Ä¢ User acceptance criteria validation
‚Ä¢ E2E cases

**üìã Easy Steps to Get Started:**

**Method 1: Upload PRD Document**
1Ô∏è‚É£ **Click "PRD Test Case Generation"** on the main page
2Ô∏è‚É£ **Select "Upload PRD Document"** option
3Ô∏è‚É£ **Choose your file** (PDF, DOC, DOCX, or TXT format)
4Ô∏è‚É£ **Click "Generate Test Cases"** - AI will analyze your document
5Ô∏è‚É£ **Review the results** and download your test cases

**Method 2: Use Azure DevOps Integration**
1Ô∏è‚É£ **Click "PRD Test Case Generation"** on the main page
2Ô∏è‚É£ **Select "Epic/User Story"** option
3Ô∏è‚É£ **Enter your Azure Token** (get this from your Azure DevOps settings)
4Ô∏è‚É£ **Add Epic Number** (optional) and **User Story Numbers** (required)
5Ô∏è‚É£ **Confirm the details** by checking the agreement box
6Ô∏è‚É£ **Click "Generate Test Cases"** - AI will fetch and analyze your stories

**üí° Pro Tips:**
‚Ä¢ For best results, ensure your PRD has clear requirements and acceptance criteria
‚Ä¢ User stories should be well-defined with proper descriptions
‚Ä¢ The AI works better with detailed requirements rather than vague statements

**Need Help?**
‚Ä¢ Having trouble with Azure token? Check your Azure DevOps permissions
‚Ä¢ File not uploading? Make sure it's under 10MB and in supported format
‚Ä¢ Questions about the results? The AI generates comprehensive test scenarios based on your requirements`,

    "api_discovery": `**What is API Discovery and How can I use API Discovery?**

API Discovery automatically finds and analyzes all APIs in your system using your existing New Relic monitoring data. No manual cataloging needed!

**üöÄ Quick Setup (5 minutes):**

1Ô∏è‚É£ **Click "Launch LLM Discovery"** on the main page
2Ô∏è‚É£ **Connect your New Relic account**
   ‚Ä¢ Enter your New Relic API key
   ‚Ä¢ Select your account region
   ‚Ä¢ Test the connection

3Ô∏è‚É£ **Choose applications to scan**
   ‚Ä¢ Pick from your monitored applications
   ‚Ä¢ Select time range for analysis
   ‚Ä¢ Set discovery scope (production, staging, etc.)

4Ô∏è‚É£ **Add Swagger documentation** (optional but recommended)
   ‚Ä¢ Provide Swagger/OpenAPI URLs for each service
   ‚Ä¢ This helps AI understand your API structure better
   ‚Ä¢ Skip if you don't have documentation

5Ô∏è‚É£ **Start AI analysis**
   ‚Ä¢ Click "Analyze & Discover APIs"
   ‚Ä¢ AI processes your New Relic traces and logs
   ‚Ä¢ Wait 2-5 minutes for completion

6Ô∏è‚É£ **Review your API inventory**
   ‚Ä¢ Browse discovered endpoints
   ‚Ä¢ Check performance metrics
   ‚Ä¢ Explore dependency maps

**üîç What You'll Get:**

‚úÖ **Complete API catalog** - Every endpoint automatically discovered
‚úÖ **Performance insights** - Response times, error rates, throughput data
‚úÖ **Dependency mapping** - See which services talk to each other
‚úÖ **Health monitoring** - Real-time status of all your APIs
‚úÖ **Visual topology** - Interactive maps of your API ecosystem
‚úÖ **Usage analytics** - Most/least used endpoints and patterns

**üí° Pro Tips:**
‚Ä¢ Run discovery weekly to catch new APIs as they're deployed
‚Ä¢ Connect multiple New Relic accounts if you have different environments
‚Ä¢ Add Swagger docs later to improve AI analysis accuracy
‚Ä¢ Use filters to focus on specific services or time periods

**‚ùì Common Questions:**
‚Ä¢ "Where do I find my New Relic API key?" - Go to New Relic ‚Üí Account Settings ‚Üí API Keys
‚Ä¢ "Can I discover APIs from multiple environments?" - Yes! Connect different New Relic accounts
‚Ä¢ "What if I don't have Swagger docs?" - No problem! AI can discover APIs from traces alone
‚Ä¢ "How often should I run discovery?" - Weekly or after major deployments

**Need Help?**
‚Ä¢ New Relic connection issues? Check your API key permissions
‚Ä¢ Not seeing expected APIs? Verify your applications have recent traffic
‚Ä¢ Want to exclude certain endpoints? Use our filtering options`,

    "manual_api": `**How to generate API Component test:**

**Getting Started:**
1. Import your Swagger/OpenAPI spec OR create tests manually
2. Configure test parameters and data
3. Generate test scripts in your preferred framework
4. Execute tests and view detailed reports

**Quick Setup (5 minutes):**

1Ô∏è‚É£ **Account Setup**
   ‚Ä¢ Sign up for your account
   ‚Ä¢ Choose your subscription plan
   ‚Ä¢ Complete profile setup

2Ô∏è‚É£ **Connect Your Tools**
   ‚Ä¢ Link New Relic account (for API discovery)
   ‚Ä¢ Connect Azure DevOps (for PRD integration)
   ‚Ä¢ Set up your preferred testing frameworks

3Ô∏è‚É£ **First Project**
   ‚Ä¢ Create your first project
   ‚Ä¢ Choose: API Discovery, PRD Testing, or API Component test Generation
   ‚Ä¢ Follow the guided workflow

**More Questions You Can Ask:**
‚Ä¢ "How to import Swagger spec?"
‚Ä¢ "Testing framework options"
‚Ä¢ "API test automation help"`
};

// Track the last user message to determine correct response
let lastUserMessage = '';

// Function to detect which response to use
function detectCorrectResponse(userInput) {
    const input = userInput.toLowerCase().trim();
    console.log(`[DETECT] Analyzing user input: "${input}"`);

    // Manual API Testing / Component Test questions (CHECK FIRST - most specific)
    if (input.includes('component test') ||
        input.includes('api component test') ||
        input.includes('how to generate api component test') ||
        input.includes('manual api') ||
        (input.includes('manual') && input.includes('testing')) ||
        (input.includes('manual') && input.includes('api')) ||
        input.includes('what is manual api testing')) {
        console.log('[DETECT] ‚Üí Manual API Testing / Component Test Match');
        return CORRECT_TOOL_RESPONSES.manual_api;
    }

    // PRD-related questions (CHECK SECOND to avoid conflicts)
    if (input.includes('prd') ||
        input.includes('product requirements') ||
        input.includes('requirements document') ||
        (input.includes('generate') && input.includes('test') && !input.includes('component'))) {
        console.log('[DETECT] ‚Üí PRD Match');
        return CORRECT_TOOL_RESPONSES.prd;
    }

    // API Discovery questions
    if (input.includes('api discovery') ||
        (input.includes('discover') && input.includes('api')) ||
        input.includes('what is api discovery') ||
        input.includes('how to use api discovery')) {
        console.log('[DETECT] ‚Üí API Discovery Match');
        return CORRECT_TOOL_RESPONSES.api_discovery;
    }

    console.log('[DETECT] ‚Üí No specific match found');
    return null; // Let default response through
}

// INTERCEPT: Override the addMessage function to catch wrong responses
const originalAddMessage = window.addMessage;
window.addMessage = function(sender, content) {
    console.log(`[INTERCEPT] ${sender}: ${content.substring(0, 100)}...`);

    // Check if this is a wrong assistant response that needs to be replaced
    let shouldReplace = false;

    if (sender === 'assistant') {
        // Pattern 1: "I can help you generate test cases!" response
        if (content.includes('I can help you generate test cases!') &&
            content.includes('Manual API Test Generation:')) {
            shouldReplace = true;
        }
        // Pattern 2: "I understand you're asking about" response
        else if (content.includes('I understand you\'re asking about') &&
                 content.includes('While I\'m specialized in API discovery')) {
            shouldReplace = true;
        }
        // Pattern 3: Generic "While I'm specialized" response
        else if (content.includes('While I\'m specialized in API discovery and test generation')) {
            shouldReplace = true;
        }
        // Pattern 4: Any response mentioning "specialized in API discovery"
        else if (content.includes('specialized in API discovery') &&
                 content.includes('I can help you with:')) {
            shouldReplace = true;
        }
        // Pattern 5: "To discover APIs from New Relic:" response (NEW PATTERN)
        else if (content.includes('To discover APIs from New Relic:') &&
                 content.includes('Click "Launch LLM Discovery"')) {
            shouldReplace = true;
        }
        // Pattern 6: API Discovery getAIResponse function response
        else if (content.includes('Click "Launch LLM Discovery" on the main screen') &&
                 content.includes('The system will automatically:')) {
            shouldReplace = true;
        }
        // Pattern 7: Generic API Discovery from getAIResponse
        else if (content.includes('Automatic endpoint detection') &&
                 content.includes('Performance metrics analysis') &&
                 content.includes('Error rate tracking')) {
            shouldReplace = true;
        }
    }

    if (shouldReplace) {
        console.log('[INTERCEPT] üîÑ Replacing with correct answer...');
        console.log('[INTERCEPT] Last user message was:', lastUserMessage);

        // Get the correct response based on the last user message
        const correctResponse = detectCorrectResponse(lastUserMessage);

        if (correctResponse) {
            console.log('[INTERCEPT] ‚úÖ Replacing with correct response');
            content = correctResponse;
        } else {
            console.log('[INTERCEPT] ‚ö†Ô∏è No specific correct response found, using original');
        }
    }

    // Call the original addMessage with the corrected content
    if (originalAddMessage) {
        originalAddMessage.call(this, sender, content);
    } else {
        // Fallback implementation
        console.log(`[INTERCEPT FALLBACK] ${sender}: ${content}`);
    }
};

// INTERCEPT: Override sendMessage to track user messages
const originalSendMessage = window.sendMessage;
window.sendMessage = function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        lastUserMessage = chatInput.value.trim();
        console.log(`[INTERCEPT] Tracked user message: "${lastUserMessage}"`);
    }

    // Call the original sendMessage
    if (originalSendMessage) {
        return originalSendMessage.call(this);
    }
};

// ADDITIONAL BACKUP: Direct override of handleToolAssistanceQuery
window.handleToolAssistanceQuery = function(userInput) {
    console.log(`[DIRECT OVERRIDE] Processing: "${userInput}"`);

    const correctResponse = detectCorrectResponse(userInput);

    if (correctResponse) {
        setTimeout(() => {
            if (originalAddMessage) {
                originalAddMessage('assistant', correctResponse);
            }
        }, 300);
    } else {
        // Let the original function handle it if it exists
        if (window.originalHandleToolAssistanceQuery) {
            window.originalHandleToolAssistanceQuery(userInput);
        }
    }
};

// Enhanced selectToolAssistance with better initialization
window.selectToolAssistance = function(event) {
    // Set tool assistance mode
    window.isToolAssistanceMode = true;

    // Ripple effect
    if (event && event.currentTarget) {
        const ripple = document.createElement('span');
        ripple.style.cssText = `
            position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3);
            width: 50px; height: 50px; left: 50%; top: 50%; margin: -25px 0 0 -25px;
            transform: scale(0); animation: ripple 0.6s linear; pointer-events: none;
        `;
        event.currentTarget.style.position = 'relative';
        event.currentTarget.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
    }

    // Clear welcome message
    const welcome = document.getElementById('welcomeMessage');
    if (welcome) welcome.remove();

    // Add correct initial message
    const initialMessage = `This powerful platform offers three main capabilities:

üîç **API Discovery**
üìù **PRD Test Case Generation**
üß™ **API Component Test case Generation**

**üî• Try asking:**
‚Ä¢ "How to generate PRD test case"
‚Ä¢ "What is API Discovery"
‚Ä¢ "How to generate API Component test"

What would you like to know about? Just ask me anything! üòä`;

    if (originalAddMessage) {
        originalAddMessage('assistant', initialMessage);
    }

    // Enable UI elements
    const inputArea = document.getElementById('inputArea');
    if (inputArea) {
        inputArea.classList.remove('disabled');
        inputArea.style.opacity = '1';
        inputArea.style.pointerEvents = 'auto';
    }

    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.disabled = false;
        chatInput.placeholder = 'Ask me about API discovery, PRD testing, manual testing, or anything else...';
        setTimeout(() => chatInput.focus(), 100);
    }

    const sendButton = document.getElementById('sendButton');
    if (sendButton) {
        sendButton.disabled = false;
    }

    // Show clear button
    const clearChatBtnHeader = document.getElementById('clearChatBtnHeader');
    if (clearChatBtnHeader) {
        clearChatBtnHeader.style.display = 'flex';
    }
};


<!--                selectAIAssistance-->

    function selectAIAssistance(event) {
        // Add ripple effect
        if (event && event.currentTarget) {
            event.currentTarget.style.position = 'relative';
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            const rect = event.currentTarget.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = event.clientX - rect.left - size / 2 + 'px';
            ripple.style.top = event.clientY - rect.top - size / 2 + 'px';
            event.currentTarget.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // Check if already authenticated
        if (currentUserSession.isAuthenticated) {
            proceedWithAIAssistance();
        } else {
            // Show authentication modal
            showAuthModal();
        }
    }

    function handleClaudeOverlayClick(event) {
        if (event.target === event.currentTarget) {
            closeClaudeOverlay();
        }
    }

    function adjustTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function handleChatKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function sendSuggestion(text) {
        const input = document.getElementById('chatInput');
        input.value = text;
        adjustTextareaHeight(input);
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        // Clear welcome message if it exists
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }

        // Add user message
        addMessage('user', message);

        // Clear input
        input.value = '';
        adjustTextareaHeight(input);

        // Disable send button temporarily
        const sendButton = document.getElementById('sendButton');
        sendButton.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        // Get AI response
        try {
            if (window.isAIAssistanceMode) {
                // Call the chat-box-llm API
                const response = await fetch('/ai/chat-box-llm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const aiResponse = await response.text();
                removeTypingIndicator();
                addMessage('assistant', aiResponse);
            } else {
                // Use the existing getAIResponse for tool assistance mode
                const response = await getAIResponse(message);
                removeTypingIndicator();
                addMessage('assistant', response);
            }
        } catch (error) {
            console.error('Error getting AI response:', error);
            removeTypingIndicator();

            let errorMessage = 'Sorry, I encountered an error. Please try again.';
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Cannot connect to server. Please ensure the backend is running.';
            }

            addMessage('assistant', errorMessage);
        }

        // Re-enable send button
        sendButton.disabled = false;
        input.focus();
    }

    // Clear chat history - Updated for session isolation
    async function clearChatHistory() {
        try {
            if (!confirm('Are you sure you want to clear the chat history?')) {
                return;
            }

            // Clear the messages from UI
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';

            // Clear current session's chat history
            currentUserSession.chatHistory = [];
            saveUserSessionData();

            // Add back the initial AI assistant message if in AI assistance mode
            if (window.isAIAssistanceMode) {
                const welcomeMsg = currentUserSession.username
                    ? `Hello ${currentUserSession.username}! I'm your AI Assistant. Chat history cleared! I can help you with any questions or tasks you have. Feel free to ask me anything.`
                    : `Hello! I'm your AI Assistant. Chat history cleared! I can help you with any questions or tasks you have. Feel free to ask me anything.`;

                addMessage('assistant', welcomeMsg);
            }

            // Silently call the clear API without UI feedback
            try {
                await fetch('/ai/chat-box-llm/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            } catch (apiError) {
                // Silently handle API errors - user doesn't need to know
                // The UI has already been cleared which is what matters most
            }

            console.log(`Chat history cleared for user: ${currentUserSession.username}`);

        } catch (error) {
            // Only show error if something critical fails
            alert('Failed to clear chat history. Please try again.');
        }
    }

    // Add message function with session support
    function addMessage(role, content) {
        addMessageToUI(role, content, true);
    }

    // Separate function to add message to UI
    function addMessageToUI(role, content, saveToHistory = true) {
        const messagesArea = document.getElementById('messagesArea');

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';

        const avatarDiv = document.createElement('div');
        avatarDiv.className = `message-avatar ${role === 'user' ? 'user-avatar' : 'assistant-avatar'}`;
        avatarDiv.textContent = role === 'user' ? 'U' : 'A';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const roleDiv = document.createElement('div');
        roleDiv.className = 'message-role';
        roleDiv.textContent = role === 'user' ? 'You' : 'AI Assistant';

        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        textDiv.innerHTML = formatMessage(content);

        contentDiv.appendChild(roleDiv);
        contentDiv.appendChild(textDiv);

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);

        messagesArea.appendChild(messageDiv);

        // Scroll to bottom
        messagesArea.scrollTop = messagesArea.scrollHeight;

        // Add to current session history and save
        if (saveToHistory && currentUserSession.isAuthenticated) {
            currentUserSession.chatHistory.push({ role, content, timestamp: Date.now() });
            saveUserSessionData();

            console.log(`Message added to session for user: ${currentUserSession.username} (total: ${currentUserSession.chatHistory.length})`);
        }
    }

    function formatMessage(content) {
        // Convert markdown-like formatting to HTML
        return content
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }

    function showTypingIndicator() {
        const messagesArea = document.getElementById('messagesArea');

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message';
        typingDiv.id = 'typingIndicator';

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar assistant-avatar';
        avatarDiv.textContent = 'A';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const indicatorDiv = document.createElement('div');
        indicatorDiv.className = 'typing-indicator';
        indicatorDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

        contentDiv.appendChild(indicatorDiv);
        typingDiv.appendChild(avatarDiv);
        typingDiv.appendChild(contentDiv);

        messagesArea.appendChild(typingDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }

       async function getAIResponse(message) {
        // Simulate AI response with context-aware answers
        const lowerMessage = message.toLowerCase();

        // Add a small delay to simulate thinking
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));

        // Context-aware responses
        if (lowerMessage.includes('discover') && lowerMessage.includes('api')) {
            return `To discover APIs from New Relic:

1. **Click "Launch LLM Discovery"** on the main screen
2. The system will automatically:
   - Connect to your New Relic account
   - Analyze your application traces
   - Identify all API endpoints
   - Generate comprehensive documentation

**Features include:**
- Automatic endpoint detection
- Performance metrics analysis
- Error rate tracking
- Dependency mapping

Would you like me to guide you through the setup process?`;
        }

        if (lowerMessage.includes('test') && (lowerMessage.includes('case') || lowerMessage.includes('generation'))) {
            return `I can help you generate test cases! We offer two methods:

**1. Manual API Test Generation:**
- Enter your API endpoint
- Select HTTP method (GET, POST, etc.)
- Provide request/response samples
- AI generates comprehensive test cases

**2. Swagger Integration:**
- Import your Swagger/OpenAPI spec
- Automatically extract endpoints
- Generate test cases for all operations
- Include edge cases and validations

Which method would you prefer to use?`;
        }

        if (lowerMessage.includes('prd')) {
            return `PRD (Product Requirements Document) Test Case Generation helps you create test cases from:

**1. Epic/User Stories:**
- Connect to Azure DevOps
- Fetch epic and user story details
- Generate test cases automatically

**2. Document Upload:**
- Upload PRD documents (PDF, DOC, TXT)
- AI analyzes requirements
- Creates comprehensive test scenarios

This ensures your tests align perfectly with business requirements. Would you like to try it?`;
        }

        if (lowerMessage.includes('swagger')) {
            return `For Swagger integration:

1. Click **"API Test Generation"**
2. Select **"Swagger API Test Generation"**
3. Enter your Swagger URL
4. Specify the endpoint you want to test

**The system will:**
- Fetch API specifications
- Extract parameters and schemas
- Generate test cases with:
  - Valid inputs
  - Boundary conditions
  - Error scenarios
  - Security tests

Need help with a specific Swagger URL?`;
        }

        if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
            return `I'm your AI Assistant! I can help you with:

üîç **API Discovery**
- Discover APIs from New Relic data
- Analyze performance metrics
- Map dependencies

üß™ **Test Generation**
- Create test cases from API specs
- Generate tests from Swagger/OpenAPI
- Support multiple test frameworks

üìù **PRD Testing**
- Generate tests from requirements
- Azure DevOps integration
- Document analysis

üìä **Analytics**
- Performance insights
- Error analysis
- Usage patterns

What would you like to explore first?`;
        }

        // Default response for unmatched queries
        return `I understand you're asking about "${message}".

While I'm specialized in API discovery and test generation, I can help you with:
- Discovering APIs from New Relic
- Generating test cases from specifications
- PRD-based test creation
- Swagger integration

Could you please specify which feature you'd like to know more about?`;
    }

    // ============== REMAINING FUNCTIONALITY ==============

    // Navigate to LLM API Discovery page
    function navigateToLLMAPI() {
        const button = document.getElementById('llmApiBtn');
        const loadingRing = document.getElementById('loadingRing');

        loadingRing.style.display = 'inline-block';
        button.style.pointerEvents = 'none';

        setTimeout(() => {
            window.location.href = '/ai/llmapidiscovery';
        }, 500);
    }

    // Show PRD Test Modal
    function showPRDTestModal() {
        const modal = document.getElementById('prdTestModal');
        modal.classList.add('active');

        // Clear form fields and any error messages
        document.getElementById('azureToken').value = '';
        document.getElementById('epicNo').value = '';
        document.getElementById('userStoryNo').value = '';
        document.getElementById('prdFile').value = '';

        // Reset checkboxes and collapse expandables
        document.getElementById('prdUserStoryEpic').checked = false;
        document.getElementById('prdUpload').checked = false;
        document.getElementById('prdUserStoryEpicExpand').classList.remove('active');
        document.getElementById('prdUploadExpand').classList.remove('active');

        // Reset agreement checkbox
        document.getElementById('prdAgreement').checked = false;
        document.getElementById('prdAgreement').disabled = true;
        document.getElementById('prdAgreementLabel').classList.add('disabled');
        document.getElementById('processPRDBtn').disabled = true;

        clearPRDErrors();
    }

    // Check if agreement checkbox should be enabled
    function checkAgreementEligibility() {
        const azureToken = document.getElementById('azureToken').value.trim();
        const userStoryNo = document.getElementById('userStoryNo').value.trim();
        const agreementCheckbox = document.getElementById('prdAgreement');
        const agreementLabel = document.getElementById('prdAgreementLabel');
        const processBtn = document.getElementById('processPRDBtn');

        if (azureToken && userStoryNo) {
            // Enable agreement checkbox
            agreementCheckbox.disabled = false;
            agreementLabel.classList.remove('disabled');
        } else {
            // Disable agreement checkbox and uncheck it
            agreementCheckbox.disabled = true;
            agreementCheckbox.checked = false;
            agreementLabel.classList.add('disabled');
            processBtn.disabled = true;

            // Re-enable form fields if they were disabled
            enablePRDFormFields();
        }
    }

    // Disable form fields when agreement is checked
    function disablePRDFormFields() {
        document.getElementById('azureToken').disabled = true;
        document.getElementById('epicNo').disabled = true;
        document.getElementById('userStoryNo').disabled = true;
    }

    // Enable form fields when agreement is unchecked
    function enablePRDFormFields() {
        document.getElementById('azureToken').disabled = false;
        document.getElementById('epicNo').disabled = false;
        document.getElementById('userStoryNo').disabled = false;
    }

    // Handle agreement checkbox change
    async function handleAgreementChange() {
        const agreementCheckbox = document.getElementById('prdAgreement');
        const processBtn = document.getElementById('processPRDBtn');

        if (agreementCheckbox.checked) {
            // User checked the checkbox - fetch work items and disable fields

            // First disable the checkbox to prevent multiple clicks during API call
            agreementCheckbox.disabled = true;

            // Fetch work items details
            const fetchSuccess = await fetchWorkItemsDetails();

            // Re-enable the checkbox
            agreementCheckbox.disabled = false;

            if (fetchSuccess) {
                // Success - keep checkbox checked, disable fields, enable process button
                disablePRDFormFields();
                processBtn.disabled = false;
            } else {
                // Failed - uncheck the checkbox and keep fields enabled
                agreementCheckbox.checked = false;
                enablePRDFormFields();
                processBtn.disabled = true;
            }
        } else {
            // User unchecked the checkbox - just enable fields, no API call
            enablePRDFormFields();
            processBtn.disabled = true;
            // Clear stored merged data
            window.prdMergedData = null;
            console.log('Agreement unchecked - fields enabled, merged data cleared');
        }
    }

    // Fetch work items details from API
    async function fetchWorkItemsDetails() {
        const azureToken = document.getElementById('azureToken').value.trim();
        const epicNo = document.getElementById('epicNo').value.trim();
        const userStoryNo = document.getElementById('userStoryNo').value.trim();

        // Clear any previous errors
        clearPRDErrors();

        // Collect all work item IDs
        const workItemIds = [];

        // Add epic ID if provided
        if (epicNo) {
            workItemIds.push(epicNo);
        }

        // Add user story IDs
        if (userStoryNo) {
            const userStories = userStoryNo.split(',').map(story => story.trim()).filter(story => story);
            workItemIds.push(...userStories);
        }

        if (workItemIds.length === 0) {
            showPRDError('general', 'No work item IDs to fetch');
            return false;
        }

        // Show loading state in agreement section
        const agreementSection = document.querySelector('.agreement-section');
        const loader = document.createElement('div');
        loader.id = 'fetchingLoader';
        loader.style.cssText = 'margin-top: 10px; text-align: center;';
        loader.innerHTML = '<span class="spinner"></span><span style="margin-left: 10px; color: #667eea;">Fetching work item details...</span>';
        agreementSection.appendChild(loader);

        try {
            console.log('Fetching work items details:', {
                work_item_ids: workItemIds,
                token: azureToken.substring(0, 10) + '...'
            });

            const response = await fetch('/ai/api/workitemsDetails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    work_item_ids: workItemIds,
                    token: azureToken
                })
            });

            const data = await response.json();
            console.log('Work items details response:', data);

            if (response.ok && data.success) {
                // Store the merged data globally for later use
                window.prdMergedData = {
                    epic_merged_data: data.epic_data?.epic_merged_data || '',
                    userstory_merged_data: data.user_story_data?.userstory_merged_data || '',
                    epic_count: data.epic_data?.count || 0,
                    user_story_count: data.user_story_data?.count || 0,
                    total_items: data.total_items || 0
                };

                console.log('Stored merged data:', window.prdMergedData);

                // Show success message
                loader.innerHTML = '<div style="color: #28a745;"><span>‚úÖ</span> Work items fetched successfully (' + window.prdMergedData.total_items + ' items)</div>';
                setTimeout(() => {
                    const loaderElement = document.getElementById('fetchingLoader');
                    if (loaderElement) loaderElement.remove();
                }, 2000);

                return true;
            } else {
                throw new Error(data.message || 'Failed to fetch work items');
            }
        } catch (error) {
            console.error('Error fetching work items:', error);

            // Remove loader
            const loaderElement = document.getElementById('fetchingLoader');
            if (loaderElement) loaderElement.remove();

            // Show error
            showPRDError('general', `Failed to fetch work items: ${error.message}`);
            return false;
        }
    }

    // Toggle PRD expand sections
    function togglePRDExpand(type) {
        const expandId = type === 'userStoryEpic' ? 'prdUserStoryEpicExpand' : 'prdUploadExpand';
        const checkboxId = type === 'userStoryEpic' ? 'prdUserStoryEpic' : 'prdUpload';
        const otherCheckboxId = type === 'userStoryEpic' ? 'prdUpload' : 'prdUserStoryEpic';
        const otherExpandId = type === 'userStoryEpic' ? 'prdUploadExpand' : 'prdUserStoryEpicExpand';

        const expandable = document.getElementById(expandId);
        const checkbox = document.getElementById(checkboxId);
        const otherCheckbox = document.getElementById(otherCheckboxId);
        const otherExpandable = document.getElementById(otherExpandId);

        if (checkbox.checked) {
            // Close the other section if open
            otherCheckbox.checked = false;
            otherExpandable.classList.remove('active');

            // Open this section
            expandable.classList.add('active');
        } else {
            expandable.classList.remove('active');
        }

        // Clear any existing errors when switching
        clearPRDErrors();

        // Reset agreement checkbox when switching sections
        if (type === 'userStoryEpic') {
            checkAgreementEligibility();
        }
    }

    // Close PRD Modal
    function closePRDModal() {
        const modal = document.getElementById('prdTestModal');
        modal.classList.remove('active');
        // Clear any error messages when closing
        clearPRDErrors();

        // Re-enable form fields
        enablePRDFormFields();

        // Clear stored merged data
        window.prdMergedData = null;
    }

    // Validate work item using the API
    async function validateWorkItem(workItemId, token, expectedType) {
        try {
            const response = await fetch('/ai/api/workitems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    work_item_ids: [workItemId],
                    token: token
                })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    return { valid: false, error: 'Invalid Azure token' };
                }
                return { valid: false, error: `Failed to validate work item (Status: ${response.status})` };
            }

            const data = await response.json();
            console.log('API Response for work item', workItemId, ':', data);

            // Check if data has work_items array
            if (!data || !data.work_items || !Array.isArray(data.work_items) || data.work_items.length === 0) {
                console.error('No work items found in response:', data);
                return { valid: false, error: `Work item ${workItemId} not found` };
            }

            // Get the first work item from the work_items array
            const workItem = data.work_items[0];

            // Check if the work item has the workItemType field
            if (!workItem.workItemType) {
                console.error('Work item missing workItemType field:', workItem);
                return { valid: false, error: `Work item ${workItemId} has no type information` };
            }

            // Check if the work item type matches expected type
            // Only show error if workItemType is NOT the expected type
            if (workItem.workItemType === expectedType) {
                // This is correct - no error
                console.log(`Work item ${workItemId} validated successfully as ${expectedType}`);
                return { valid: true };
            } else {
                // This is wrong type - show error
                return {
                    valid: false,
                    error: `ID ${workItemId} is not a ${expectedType}. Found: ${workItem.workItemType}`
                };
            }

        } catch (error) {
            console.error('Error validating work item:', error);
            return { valid: false, error: 'Network error or API unavailable' };
        }
    }

    // Show error message for PRD form
    function showPRDError(fieldId, message) {
        // Remove any existing error for this field
        const existingError = document.getElementById(`${fieldId}-error`);
        if (existingError) {
            existingError.remove();
        }

        // Create error element
        const errorDiv = document.createElement('div');
        errorDiv.id = `${fieldId}-error`;
        errorDiv.style.cssText = `
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ef5350;
            font-size: 0.9em;
            line-height: 1.4;
        `;
        errorDiv.innerHTML = message;

        // Insert error after the appropriate field
        if (fieldId === 'general') {
            // General error - show at the top of the form
            const modalHeader = document.querySelector('#prdTestModal .modal-header');
            modalHeader.appendChild(errorDiv);
        } else {
            const field = document.getElementById(fieldId);
            if (field && field.parentElement) {
                field.parentElement.appendChild(errorDiv);
            }
        }
    }

    // Clear all PRD error messages
    function clearPRDErrors() {
        const errors = document.querySelectorAll('[id$="-error"]');
        errors.forEach(error => error.remove());
    }

    // Process PRD Test Case
    async function processPRDTestCase() {
        const azureToken = document.getElementById('azureToken').value.trim();
        const epicNo = document.getElementById('epicNo').value.trim();
        const userStoryNo = document.getElementById('userStoryNo').value.trim();

        // Clear any previous error messages
        clearPRDErrors();

        // Check if we have the merged data
        if (!window.prdMergedData) {
            showPRDError('general', 'Work items data not loaded. Please check the agreement checkbox again.');
            return;
        }

        // Process the user story numbers (split by comma and trim)
        const userStories = userStoryNo.split(',').map(story => story.trim()).filter(story => story);

        // Prepare the payload for contact-testCase-llm API
        const payload = {
            epic_data: window.prdMergedData.epic_merged_data || "",
            us_data: window.prdMergedData.userstory_merged_data || "",
            prd_data: ""  // Empty for this flow
        };

        console.log('PRD Test Case Generation Request:', {
            azureToken: azureToken.substring(0, 10) + '...', // Log only first 10 chars for security
            epicNo: epicNo || 'Not provided (optional)',
            userStories: userStories,
            payload: payload
        });

        // Show loading state
        const submitBtn = document.getElementById('processPRDBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner"></span><span>Generating Test Cases...</span>';
        submitBtn.disabled = true;

        // Show result modal with loading state
        const resultModal = document.getElementById('resultModal');
        const resultBody = document.getElementById('resultBody');
        const resultMeta = document.getElementById('resultMeta');

        resultBody.innerHTML = '<div style="text-align: center; padding: 50px;"><div class="spinner"></div><div class="loading-text">Generating test cases from PRD...</div></div>';
        resultMeta.innerHTML = `Type: PRD Test Case | Epic: ${epicNo || 'None'} | User Stories: ${userStories.join(', ')}`;

        // Show result modal without closing PRD modal
        resultModal.classList.add('active');

        try {
            // Call the contact-testCase-llm API
            const response = await fetch('/ai/contact-testCase-llm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            console.log('Response status:', response.status);

            const testCases = await response.text();

            if (response.ok) {
                // Display the generated test cases
                currentTestType = 'prd';
                displayTestCase(testCases, 'prd');
            } else {
                throw new Error(testCases || 'Failed to generate test cases');
            }

        } catch (error) {
            console.error('Error in PRD test case generation:', error);

            let errorMessage = error.message;
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Cannot connect to server! Please ensure backend is running.';
            }

            resultBody.innerHTML = `<div style="color: red; text-align: center; padding: 50px;">
                <h4>Error Generating Test Cases</h4>
                <p>${errorMessage}</p>
                <p style="margin-top: 20px; font-size: 0.9em;">
                    Make sure:<br>
                    1. Backend is running<br>
                    2. All required APIs are available<br>
                    3. LLM service is configured correctly
                </p>
            </div>`;
        } finally {
            // Restore button state (even though modal is closed)
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Process PRD Upload Test Case
    async function processUploadPRDTestCase() {
        const prdFile = document.getElementById('prdFile').files[0];

        // Clear any previous error messages
        clearPRDErrors();

        // Validation
        if (!prdFile) {
            showPRDError('prdFile', 'Please upload a PRD document');
            return;
        }

        console.log('PRD Upload Test Case Generation Request:', {
            fileName: prdFile.name,
            fileSize: prdFile.size,
            fileType: prdFile.type
        });

        // Show loading state
        const submitBtn = document.getElementById('processUploadPRDBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner"></span><span>Uploading Document...</span>';
        submitBtn.disabled = true;

        try {
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('file', prdFile);

            console.log('Uploading file to /upload/raw...');

            // Upload file to /upload/raw API
            const uploadResponse = await fetch('/ai/upload/raw', {
                method: 'POST',
                body: formData
            });

            if (!uploadResponse.ok) {
                throw new Error(`Upload failed with status: ${uploadResponse.status}`);
            }

            const uploadData = await uploadResponse.json();
            console.log('Upload response:', uploadData);

            // Store the upload response
            window.uploadedPRDData = uploadData;

            // Update button to show processing
            submitBtn.innerHTML = '<span class="spinner"></span><span>Generating Test Cases...</span>';

            // Show result modal with loading state
            const resultModal = document.getElementById('resultModal');
            const resultBody = document.getElementById('resultBody');
            const resultMeta = document.getElementById('resultMeta');

            resultBody.innerHTML = '<div style="text-align: center; padding: 50px;"><div class="spinner"></div><div class="loading-text">Generating test cases from uploaded PRD...</div></div>';
            resultMeta.innerHTML = `Type: PRD Upload Test Case | File: ${prdFile.name}`;

            // Show result modal
            resultModal.classList.add('active');

            // Prepare payload for contact-testCase-llm API
            const payload = {
                epic_data: "",  // Empty for upload flow
                us_data: "",    // Empty for upload flow
                prd_data: uploadData.full_text || "" // Use the full_text from the uploaded document
            };

            console.log('Calling contact-testCase-llm with uploaded PRD data...');

            // Call the contact-testCase-llm API with uploaded content
            const testCaseResponse = await fetch('/ai/contact-testCase-llm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const testCases = await testCaseResponse.text();

            if (testCaseResponse.ok) {
                // Display the generated test cases
                currentTestType = 'prd';
                displayTestCase(testCases, 'prd');

                // Don't close the PRD modal - let user close it manually
                // This allows them to generate multiple test cases or make changes
            } else {
                throw new Error(testCases || 'Failed to generate test cases');
            }

        } catch (error) {
            console.error('Error in PRD upload test case generation:', error);

            let errorMessage = error.message;
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Cannot connect to server! Please ensure backend is running.';
            }

            // Check if result modal is open
            const resultModal = document.getElementById('resultModal');
            if (resultModal.classList.contains('active')) {
                const resultBody = document.getElementById('resultBody');
                resultBody.innerHTML = `<div style="color: red; text-align: center; padding: 50px;">
                    <h4>Error Processing Document</h4>
                    <p>${errorMessage}</p>
                    <p style="margin-top: 20px; font-size: 0.9em;">
                        Make sure:<br>
                        1. Backend is running<br>
                        2. File upload API is available<br>
                        3. LLM service is configured correctly
                    </p>
                </div>`;
            } else {
                showPRDError('general', `Failed to process document: ${errorMessage}`);
            }
        } finally {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Show API Test Modal
    function showAPITestModal() {
        const modal = document.getElementById('apiTestModal');
        modal.classList.add('active');

        // Reset checkboxes and expandables
        document.getElementById('manualApiTest').checked = false;
        document.getElementById('swaggerApiTest').checked = false;
        document.getElementById('manualExpand').classList.remove('active');
        document.getElementById('swaggerExpand').classList.remove('active');

        // Clear Swagger fields and results
        document.getElementById('swaggerUrl').value = '';
        document.getElementById('swaggerApiEndpoint').value = '';
        document.getElementById('swaggerResult').style.display = 'none';
        document.getElementById('swaggerResult').innerHTML = '';
    }

    // Close Modal
    function closeModal() {
        const modal = document.getElementById('apiTestModal');
        modal.classList.remove('active');
    }

    // Toggle Expand/Collapse
    function toggleExpand(type) {
        const expandId = type === 'manual' ? 'manualExpand' : 'swaggerExpand';
        const checkboxId = type === 'manual' ? 'manualApiTest' : 'swaggerApiTest';

        const expandable = document.getElementById(expandId);
        const checkbox = document.getElementById(checkboxId);

        if (checkbox.checked) {
            expandable.classList.add('active');
        } else {
            expandable.classList.remove('active');
        }
    }

    // Fetch Swagger Data
    async function fetchSwaggerData() {
        const swaggerUrl = document.getElementById('swaggerUrl').value.trim();
        const apiEndpoint = document.getElementById('swaggerApiEndpoint').value.trim();
        const fetchBtn = document.getElementById('fetchSwaggerBtn');
        const resultDiv = document.getElementById('swaggerResult');

        // Validation
        if (!swaggerUrl) {
            alert('Please enter a Swagger URL');
            return;
        }

        if (!apiEndpoint) {
            alert('Please enter an API endpoint');
            return;
        }

        // Show loading state
        const originalText = fetchBtn.innerHTML;
        fetchBtn.innerHTML = '<span class="spinner"></span><span>Fetching...</span>';
        fetchBtn.disabled = true;

        try {
            console.log('Fetching swagger data for:', swaggerUrl, apiEndpoint);

            const response = await fetch('/ai/get-api-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    swaggerUrl: swaggerUrl,
                    apiEndpoint: apiEndpoint
                })
            });

            const data = await response.json();
            console.log('Swagger data received:', data);

            if (response.ok && data.status !== 'error') {
                displaySwaggerData(data);
            } else {
                throw new Error(data.message || 'Failed to fetch Swagger data');
            }
        } catch (error) {
            console.error('Error fetching swagger data:', error);
            resultDiv.innerHTML = `
                <div style="color: red; padding: 15px; background: #ffebee; border-radius: 5px;">
                    <strong>Error:</strong> ${error.message}
                </div>
            `;
            resultDiv.style.display = 'block';
        } finally {
            fetchBtn.innerHTML = originalText;
            fetchBtn.disabled = false;
        }
    }

    // Display Swagger Data
    function displaySwaggerData(data) {
        const resultDiv = document.getElementById('swaggerResult');

        let html = '<h5>Swagger API Details</h5>';

        // API Endpoint and Method
        html += `
            <div class="result-section">
                <h6>Endpoint Information</h6>
                <p><strong>Endpoint:</strong> ${data.endpoint}</p>
                <p><strong>Method:</strong> <span style="color: #667eea; font-weight: bold;">${data.method}</span></p>
            </div>
        `;

        // Parameters
        if (data.parameters) {
            html += '<div class="result-section"><h6>Parameters</h6>';

            // Path Parameters
            if (data.parameters.path_parameters && data.parameters.path_parameters.length > 0) {
                html += '<p><strong>Path Parameters:</strong></p>';
                html += '<div style="margin-left: 20px;">';
                data.parameters.path_parameters.forEach(param => {
                    const isRequired = param.required;
                    const fieldLabel = isRequired ? 'Mandatory' : 'Optional';
                    const labelColor = isRequired ? '#dc3545' : '#28a745';

                    html += `
                        <div class="param-input-group" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <label style="display: inline-block; font-weight: 600; color: #333;">
                                    ${param.name} ${param.required ? '<span style="color: red;">*</span>' : ''}
                                </label>
                                <span style="font-size: 0.85em; padding: 2px 8px; background: ${labelColor}; color: white; border-radius: 12px; font-weight: 500;">
                                    ${fieldLabel}
                                </span>
                            </div>
                            <input type="text"
                                   id="path_${param.name}"
                                   class="param-input"
                                   placeholder="${param.type} - ${param.description || 'Enter value'}"
                                   data-param-type="path"
                                   data-param-name="${param.name}"
                                   data-param-required="${isRequired}"
                                   style="width: 100%; padding: 8px 12px; border: 1px solid ${isRequired ? '#ffc107' : '#ddd'}; border-radius: 4px; font-size: 0.95em;">
                            ${param.description ? `<small style="color: #666; margin-top: 4px; display: block;">Description: ${param.description}</small>` : ''}
                            ${param.type ? `<small style="color: #666; margin-top: 2px; display: block;">Type: ${param.type}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Query Parameters
            if (data.parameters.query_parameters && data.parameters.query_parameters.length > 0) {
                html += '<p><strong>Query Parameters:</strong></p>';
                html += '<div style="margin-left: 20px;">';
                data.parameters.query_parameters.forEach(param => {
                    const isRequired = param.required;
                    const fieldLabel = isRequired ? 'Mandatory' : 'Optional';
                    const labelColor = isRequired ? '#dc3545' : '#28a745';

                    html += `
                        <div class="param-input-group" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <label style="display: inline-block; font-weight: 600; color: #333;">
                                    ${param.name} ${param.required ? '<span style="color: red;">*</span>' : ''}
                                </label>
                                <span style="font-size: 0.85em; padding: 2px 8px; background: ${labelColor}; color: white; border-radius: 12px; font-weight: 500;">
                                    ${fieldLabel}
                                </span>
                            </div>
                            <input type="text"
                                   id="query_${param.name}"
                                   class="param-input"
                                   placeholder="${param.type} - ${param.description || 'Enter value'}"
                                   data-param-type="query"
                                   data-param-name="${param.name}"
                                   data-param-required="${isRequired}"
                                   value="${param.default || ''}"
                                   style="width: 100%; padding: 8px 12px; border: 1px solid ${isRequired ? '#ffc107' : '#ddd'}; border-radius: 4px; font-size: 0.95em;">
                            ${param.description ? `<small style="color: #666; margin-top: 4px; display: block;">Description: ${param.description}</small>` : ''}
                            ${param.type ? `<small style="color: #666; margin-top: 2px; display: block;">Type: ${param.type}</small>` : ''}
                            ${param.default ? `<small style="color: #666; margin-top: 2px; display: block;">Default: ${param.default}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Header Parameters
            if (data.parameters.header_parameters && data.parameters.header_parameters.length > 0) {
                html += '<p><strong>Header Parameters:</strong></p>';
                html += '<div style="margin-left: 20px;">';
                data.parameters.header_parameters.forEach(param => {
                    html += `
                        <div class="param-input-group" style="margin-bottom: 10px;">
                            <label style="display: inline-block; width: 150px; font-weight: 500;">
                                ${param.name} ${param.required ? '<span style="color: red;">*</span>' : ''}
                            </label>
                            <input type="text"
                                   id="header_${param.name}"
                                   class="param-input"
                                   placeholder="${param.type} - ${param.description || 'Enter value'}"
                                   data-param-type="header"
                                   data-param-name="${param.name}"
                                   style="width: calc(100% - 160px); padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';
        }

        // Request Body
        html += `
            <div class="result-section">
                <h6>Request Body ${data.request ? '' : '(Optional)'}</h6>
                <textarea id="swaggerRequestBody"
                          style="width: 100%; min-height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.9em;"
                          placeholder='Enter request body JSON...'>${data.request ? JSON.stringify(data.request, null, 2) : ''}</textarea>
            </div>
        `;

        // Response
        html += `
            <div class="result-section">
                <h6>Expected Response ${data.response ? '' : '(Optional)'}</h6>
                <textarea id="swaggerResponseBody"
                          style="width: 100%; min-height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.9em;"
                          placeholder='Enter expected response JSON...'>${data.response ? JSON.stringify(data.response, null, 2) : ''}</textarea>
            </div>
        `;

        // Store the swagger data for later use
        window.swaggerApiData = data;

        // Add test generation button
        html += `
            <div class="form-actions" style="margin-top: 20px;">
                <button class="process-btn" id="processSwaggerTestBtn">
                    <span>üß™</span>
                    <span>Generate Test Case</span>
                </button>
            </div>
        `;

        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';

        // Add event listener to the newly created button
        const processSwaggerTestBtn = document.getElementById('processSwaggerTestBtn');
        if (processSwaggerTestBtn) {
            processSwaggerTestBtn.addEventListener('click', processSwaggerTest);
        }
    }

    // Process Swagger Test
    function processSwaggerTest() {
        if (!window.swaggerApiData) {
            alert('No Swagger data available. Please fetch Swagger data first.');
            return;
        }

        // Collect all parameter values
        const paramInputs = document.querySelectorAll('.param-input');
        const collectedParams = {
            path: {},
            query: {},
            header: {}
        };

        paramInputs.forEach(input => {
            const paramType = input.getAttribute('data-param-type');
            const paramName = input.getAttribute('data-param-name');
            const paramValue = input.value.trim();

            if (paramValue) {
                collectedParams[paramType][paramName] = paramValue;
            }
        });

        // Get request and response from textareas
        const requestBodyElement = document.getElementById('swaggerRequestBody');
        const responseBodyElement = document.getElementById('swaggerResponseBody');

        let requestBody = null;
        let responseBody = null;

        // Parse request body if provided
        if (requestBodyElement && requestBodyElement.value.trim()) {
            try {
                requestBody = JSON.parse(requestBodyElement.value.trim());
            } catch (e) {
                requestBody = requestBodyElement.value.trim();
            }
        }

        // Parse response body if provided
        if (responseBodyElement && responseBodyElement.value.trim()) {
            try {
                responseBody = JSON.parse(responseBodyElement.value.trim());
            } catch (e) {
                responseBody = responseBodyElement.value.trim();
            }
        }

        // Build complete endpoint with path parameters
        let endpoint = window.swaggerApiData.endpoint;

        // Replace path parameters in endpoint
        Object.keys(collectedParams.path).forEach(paramName => {
            endpoint = endpoint.replace(`{${paramName}}`, collectedParams.path[paramName]);
        });

        // Add query parameters to endpoint
        if (Object.keys(collectedParams.query).length > 0) {
            const queryString = Object.entries(collectedParams.query)
                .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
                .join('&');
            endpoint += '?' + queryString;
        }

        // Store current test data with all collected information
        currentTestData = {
            endpoint: endpoint,
            method_type: window.swaggerApiData.method,
            payload: requestBody,
            response: responseBody,
            parameters: window.swaggerApiData.parameters,
            collectedParams: collectedParams,
            isSwagger: true
        };

        console.log('Swagger test data with parameters:', currentTestData);

        // Load available prompts
        loadAvailablePromptsWithRetry();
    }

    // Process Manual Test
    function processManualTest() {
        // Get form values
        const endpoint = document.getElementById('apiEndpoint').value.trim();
        const method = document.getElementById('httpMethod').value;
        const requestBody = document.getElementById('requestBody').value.trim();
        const response = document.getElementById('response').value.trim();

        // Validation
        if (!endpoint) {
            alert('Please enter an API endpoint');
            return;
        }

        if (!method) {
            alert('Please select an HTTP method');
            return;
        }

        // Store current test data
        currentTestData = {
            endpoint: endpoint,
            method_type: method,
            payload: requestBody ? requestBody : null,
            response: response ? response : null
        };

        console.log('Current test data:', currentTestData);

        // Load available prompts with retry option
        loadAvailablePromptsWithRetry();
    }

    // Load available prompts with retry option
    async function loadAvailablePromptsWithRetry(isRetry = false) {
        if (!isRetry) {
            // Show loading state in the form
            const processBtns = document.querySelectorAll('.process-btn');
            const originalTexts = [];

            processBtns.forEach((btn, index) => {
                originalTexts[index] = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span><span>Loading options...</span>';
                btn.disabled = true;
            });

            try {
                await loadAvailablePrompts();
            } finally {
                // Restore button states
                processBtns.forEach((btn, index) => {
                    btn.innerHTML = originalTexts[index];
                    btn.disabled = false;
                });
            }
        } else {
            await loadAvailablePrompts();
        }
    }

    // Load available prompts from API
    async function loadAvailablePrompts() {
        try {
            console.log('Loading prompts from:', window.location.origin + '/get-available-prompts');

            const response = await fetch('/ai/get-available-prompts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Prompts data received:', data);

            if (data.status === 'success' && data.prompts && data.prompts.length > 0) {
                console.log('Number of prompts:', data.prompts.length);
                console.log('Available prompts:', data.prompts.map(p => p.id).join(', '));

                availablePromptsData = data.prompts;
                displayPromptOptions(data.prompts);
                showPromptModal();
            } else {
                throw new Error(data.message || 'No prompts available from server');
            }
        } catch (error) {
            console.error('Error loading prompts:', error);
            alert('Failed to load test options. Please check if backend is running and try again.');
        }
    }

    // Display prompt options in modal
    function displayPromptOptions(prompts) {
        console.log('Displaying prompts:', prompts);

        const promptOptionsDiv = document.getElementById('promptOptions');

        if (!promptOptionsDiv) {
            console.error('promptOptions div not found!');
            alert('Error: Prompt options container not found');
            return;
        }

        promptOptionsDiv.innerHTML = '';

        if (!prompts || prompts.length === 0) {
            promptOptionsDiv.innerHTML = '<p style="text-align: center; color: #666;">No test generation options available</p>';
            return;
        }

        prompts.forEach((prompt, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'prompt-option';
            optionDiv.setAttribute('data-prompt-id', prompt.id);
            optionDiv.onclick = () => selectPrompt(prompt.id);

            optionDiv.innerHTML = `
                <h4>${prompt.name}</h4>
                <p>${prompt.description}</p>
                <span class="prompt-category">${prompt.category}</span>
            `;

            promptOptionsDiv.appendChild(optionDiv);

            // Select first option by default
            if (index === 0) {
                selectPrompt(prompt.id);
            }
        });

        console.log('Prompts displayed successfully');
    }

    // Select a prompt option
    function selectPrompt(promptId) {
        console.log('Selecting prompt:', promptId);
        selectedPromptType = promptId;

        // Update UI
        document.querySelectorAll('.prompt-option').forEach(option => {
            option.classList.remove('selected');
        });

        const selectedElement = document.querySelector(`[data-prompt-id="${promptId}"]`);
        if (selectedElement) {
            selectedElement.classList.add('selected');
        }

        console.log('Selected prompt type:', selectedPromptType);
    }

    // Show prompt selection modal
    function showPromptModal() {
        const modal = document.getElementById('promptModal');
        if (!modal) {
            console.error('Prompt modal not found!');
            alert('Error: Prompt modal not found');
            return;
        }

        modal.classList.add('active');
        console.log('Prompt modal shown');
    }

    // Close prompt modal
    function closePromptModal() {
        const modal = document.getElementById('promptModal');
        if (modal) {
            modal.classList.remove('active');
        }
        console.log('Prompt modal closed, selected type:', selectedPromptType);
    }

    // Generate test case
    async function generateTestCase() {
        console.log('Generate test case called');
        console.log('Selected prompt type:', selectedPromptType);
        console.log('Current test data:', currentTestData);

        if (!selectedPromptType) {
            alert('Please select a test generation type');
            return;
        }

        if (!currentTestData) {
            alert('No test data available. Please fill the form again.');
            return;
        }

        // Find the selected prompt details
        const selectedPromptDetails = availablePromptsData.find(p => p.id === selectedPromptType);
        console.log('Selected prompt details:', selectedPromptDetails);

        // Close prompt modal
        closePromptModal();

        // Show result modal with loading state
        const resultModal = document.getElementById('resultModal');
        const resultBody = document.getElementById('resultBody');
        const resultMeta = document.getElementById('resultMeta');

        const promptName = selectedPromptDetails ? selectedPromptDetails.name : selectedPromptType;
        resultBody.innerHTML = '<div style="text-align: center; padding: 50px;"><div class="spinner"></div><div class="loading-text">Generating test case...</div></div>';
        resultMeta.innerHTML = `Type: ${promptName} | Method: ${currentTestData.method_type} | Endpoint: ${currentTestData.endpoint}`;

        resultModal.classList.add('active');

        try {
            const requestData = {
                endpoint: currentTestData.endpoint,
                method_type: currentTestData.method_type,
                prompt_type: selectedPromptType
            };

            // Add payload if provided
            if (currentTestData.payload) {
                try {
                    requestData.payload = JSON.parse(currentTestData.payload);
                } catch (e) {
                    requestData.payload = currentTestData.payload;
                }
            }

            console.log('Sending request to /contact-llm:', requestData);
            console.log('Request data stringified:', JSON.stringify(requestData, null, 2));

            const response = await fetch('/ai/contact-llm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            console.log('Response status:', response.status);

            const testCase = await response.text();

            if (response.ok) {
                currentTestType = 'api';
                displayTestCase(testCase, 'api');
            } else {
                throw new Error(testCase || 'Failed to generate test case');
            }
        } catch (error) {
            console.error('Error generating test case:', error);

            let errorMessage = error.message;
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Cannot connect to server! Please ensure backend is running.';
            }

            resultBody.innerHTML = `<div style="color: red; text-align: center; padding: 50px;">
                <h4>Error Generating Test Case</h4>
                <p>${errorMessage}</p>
                <p style="margin-top: 20px; font-size: 0.9em;">
                    Make sure:<br>
                    1. Backend is running (python app.py)<br>
                    2. You have set GOOGLE_API_KEY in .env file<br>
                    3. You're accessing via http://localhost:5000<br>
                    4. Selected prompt type: ${selectedPromptType}
                </p>
            </div>`;
        }
    }

    // Enhanced display generated test case function to prevent truncation
    function displayTestCase(testCase, testType = null) {
        const resultBody = document.getElementById('resultBody');
        const resultInfo = document.getElementById('resultInfo');

        // Store the full content globally
        fullTestCaseContent = testCase;

        // Use testContent to preserve all content and formatting
        resultBody.textContent = testCase;

        // Update download button visibility based on test type
        const prdDownloadContainer = document.getElementById('prdDownloadContainer');
        const apiDownloadBtn = document.getElementById('apiDownloadBtn');

        if (testType) {
            currentTestType = testType;
        }

        if (currentTestType === 'prd') {
            // Show PRD download with dropdown (Excel & TXT) - for all PRD test case options:
            // 1. Epic/User Story
            // 2. Upload PRD
            // 3. AI-Powered Flexi Test Case Generation
            prdDownloadContainer.style.display = 'inline-block';
            apiDownloadBtn.style.display = 'none';
        } else {
            // Show simple TXT download for API test cases only
            prdDownloadContainer.style.display = 'none';
            apiDownloadBtn.style.display = 'inline-flex';
        }

        // Show character count info
        if (resultInfo) {
            const charCount = testCase.length;
            const lineCount = testCase.split('\n').length;
            resultInfo.textContent = `Total: ${charCount.toLocaleString()} characters, ${lineCount} lines`;
        }

        // Log content info for debugging
        console.log('Test case displayed:', {
            testType: currentTestType,
            totalLength: testCase.length,
            firstChars: testCase.substring(0, 100),
            lastChars: testCase.substring(testCase.length - 100),
            lineCount: testCase.split('\n').length
        });
    }

// Enhanced copy test case to clipboard - HTTP/HTTPS compatible with proper button behavior
async function copyTestCase() {
    try {
        // Get the copy button reference
        const copyBtn = document.getElementById('copyTestCaseBtn');
        if (!copyBtn) {
            console.error('Copy button not found');
            return;
        }

        // Store original button state (get fresh state each time)
        const originalText = copyBtn.getAttribute('data-original-text') || copyBtn.innerHTML;
        const originalBackground = copyBtn.getAttribute('data-original-bg') || copyBtn.style.background || '';

        // Store original state in data attributes for future reference
        if (!copyBtn.getAttribute('data-original-text')) {
            copyBtn.setAttribute('data-original-text', originalText);
            copyBtn.setAttribute('data-original-bg', originalBackground);
        }

        // Check if button is currently in "copied" state
        if (copyBtn.innerHTML.includes('‚úÖ') || copyBtn.innerHTML.includes('Copied!')) {
            console.log('Button is in copied state, resetting first...');
            // Reset button immediately
            copyBtn.innerHTML = originalText;
            copyBtn.style.background = originalBackground;
            copyBtn.disabled = false;
        }

        // Disable button during copy process
        copyBtn.disabled = true;
        copyBtn.innerHTML = '<span>‚è≥</span> Copy...';

        // Use the stored full content
        const testCase = fullTestCaseContent || document.getElementById('resultBody').textContent;

        if (!testCase || testCase.trim() === '') {
            // Reset button and show error
            copyBtn.innerHTML = originalText;
            copyBtn.style.background = originalBackground;
            copyBtn.disabled = false;
            alert('No content to copy');
            return;
        }

        let copySuccess = false;

        // Method 1: Try modern Clipboard API (HTTPS only)
        if (navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext) {
            try {
                await navigator.clipboard.writeText(testCase);
                copySuccess = true;
                console.log('‚úÖ Copied using Clipboard API (HTTPS)');
            } catch (clipboardError) {
                console.warn('‚ùå Clipboard API failed:', clipboardError.message);
            }
        } else {
            console.log('‚ÑπÔ∏è Clipboard API not available (HTTP or unsupported browser)');
        }

        // Method 2: HTTP-compatible execCommand fallback
        if (!copySuccess) {
            try {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = testCase;
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.left = '-9999px';
                tempTextArea.style.top = '-9999px';
                tempTextArea.style.opacity = '0';
                tempTextArea.style.pointerEvents = 'none';
                tempTextArea.style.tabIndex = '-1';
                tempTextArea.setAttribute('readonly', '');

                document.body.appendChild(tempTextArea);
                tempTextArea.focus();
                tempTextArea.select();
                tempTextArea.setSelectionRange(0, testCase.length);

                const success = document.execCommand('copy');
                document.body.removeChild(tempTextArea);

                if (success) {
                    copySuccess = true;
                    console.log('‚úÖ Copied using execCommand (HTTP compatible)');
                } else {
                    console.warn('‚ùå execCommand returned false');
                }
            } catch (execError) {
                console.error('‚ùå execCommand failed:', execError.message);
            }
        }

        // Method 3: Enhanced fallback for mobile/problematic browsers
        if (!copySuccess) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = testCase;
                textarea.style.cssText = `
                    position: fixed !important;
                    left: 50% !important;
                    top: 50% !important;
                    width: 1px !important;
                    height: 1px !important;
                    padding: 0 !important;
                    border: none !important;
                    outline: none !important;
                    boxShadow: none !important;
                    background: transparent !important;
                    transform: translate(-50%, -50%) !important;
                    opacity: 0 !important;
                    z-index: -1 !important;
                `;

                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                if (textarea.setSelectionRange) {
                    textarea.setSelectionRange(0, testCase.length);
                }

                if (window.getSelection && document.createRange) {
                    const range = document.createRange();
                    range.selectNodeContents(textarea);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }

                const success = document.execCommand('copy');
                document.body.removeChild(textarea);

                if (success) {
                    copySuccess = true;
                    console.log('‚úÖ Copied using enhanced method (mobile compatible)');
                }
            } catch (enhancedError) {
                console.error('‚ùå Enhanced method failed:', enhancedError.message);
            }
        }

        if (copySuccess) {
            // SUCCESS - Enhanced button feedback with proper state management
            copyBtn.innerHTML = '<span>‚úÖ</span> Copied!';
            copyBtn.style.background = '#28a745';
            copyBtn.disabled = false; // Re-enable immediately so user can copy again

            console.log('Copied to clipboard:', {
                length: testCase.length,
                preview: testCase.substring(0, 50) + '...'
            });

            // Clear any existing timeout
            if (copyBtn.resetTimeout) {
                clearTimeout(copyBtn.resetTimeout);
            }

            // Reset button after delay
            copyBtn.resetTimeout = setTimeout(() => {
                // Only reset if the button still shows "Copied!" (user hasn't clicked again)
                if (copyBtn.innerHTML.includes('Copied!')) {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.background = originalBackground;
                }
                // Clear the timeout reference
                copyBtn.resetTimeout = null;
            }, 2000);

        } else {
            // ALL METHODS FAILED - Reset button and show manual copy
            copyBtn.innerHTML = originalText;
            copyBtn.style.background = originalBackground;
            copyBtn.disabled = false;

            console.error('‚ùå All automatic copy methods failed');
            showSimpleManualCopy(testCase);
        }

    } catch (error) {
        console.error('üí• Unexpected error in copyTestCase:', error);

        // Reset button state on error
        const copyBtn = document.getElementById('copyTestCaseBtn');
        if (copyBtn) {
            const originalText = copyBtn.getAttribute('data-original-text') || '<span>üìã</span> Copy to Clipboard';
            const originalBackground = copyBtn.getAttribute('data-original-bg') || '';

            copyBtn.innerHTML = originalText;
            copyBtn.style.background = originalBackground;
            copyBtn.disabled = false;
        }

        // Ultimate fallback
        const testCase = fullTestCaseContent || document.getElementById('resultBody').textContent;
        if (testCase) {
            showSimpleManualCopy(testCase);
        } else {
            alert('Failed to copy to clipboard. Please select and copy manually.');
        }
    }
}

// üîß ADDITIONAL FIX: Enhanced manual copy dialog with better button handling
function showSimpleManualCopy(content) {
    // Remove any existing manual copy modal
    const existingModal = document.getElementById('simpleManualCopy');
    if (existingModal) {
        existingModal.remove();
    }

    // Create modal with improved button handling
    const modal = document.createElement('div');
    modal.id = 'simpleManualCopy';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
    `;

    modal.innerHTML = `
        <div style="
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            width: 700px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        ">
            <div style="
                text-align: center;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 2px solid #e9ecef;
            ">
                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                <h3 style="
                    color: #333;
                    margin: 0 0 10px 0;
                    font-size: 24px;
                    font-weight: 600;
                ">Manual Copy Required</h3>
                <p style="
                    color: #666;
                    margin: 0;
                    font-size: 16px;
                    line-height: 1.5;
                ">
                    Automatic clipboard access isn't working.<br>
                    Please copy the content manually:
                </p>
            </div>

            <div style="
                background: #f0f4ff;
                border: 2px solid #667eea;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
            ">
                <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">
                    üìù Instructions:
                </div>
                <div style="color: #555; font-size: 14px; line-height: 1.4;">
                    1Ô∏è‚É£ Click "Select All" button below<br>
                    2Ô∏è‚É£ Press <strong>Ctrl+C</strong> (or <strong>Cmd+C</strong> on Mac)<br>
                    3Ô∏è‚É£ Paste with <strong>Ctrl+V</strong> wherever needed
                </div>
            </div>

            <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                <div style="
                    margin-bottom: 10px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <label style="font-weight: 600; color: #333; font-size: 16px;">
                        Content to Copy:
                    </label>
                    <button id="selectAllBtn" style="
                        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
                        transition: all 0.2s ease;
                    ">üìÑ Select All</button>
                </div>

                <textarea id="simpleManualCopyText" readonly style="
                    flex: 1;
                    min-height: 300px;
                    max-height: 400px;
                    padding: 15px;
                    border: 2px solid #007bff;
                    border-radius: 8px;
                    font-family: 'Courier New', 'Monaco', monospace;
                    font-size: 13px;
                    line-height: 1.5;
                    resize: vertical;
                    background: #f8f9fa;
                    color: #333;
                    outline: none;
                ">${content}</textarea>
            </div>

            <div style="
                margin-top: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            ">
                <div style="color: #666; font-size: 14px;">
                    üí° <strong>Tip:</strong> Content is pre-selected for easy copying
                </div>
                <button id="closeManualBtn" style="
                    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 15px;
                    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                    transition: all 0.2s ease;
                ">‚úÖ Done</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Add event handlers with proper button behavior
    setTimeout(() => {
        const textarea = document.getElementById('simpleManualCopyText');
        const selectBtn = document.getElementById('selectAllBtn');
        const closeBtn = document.getElementById('closeManualBtn');

        if (textarea) {
            textarea.focus();
            textarea.select();
        }

        if (selectBtn) {
            selectBtn.onclick = function() {
                if (textarea) {
                    textarea.focus();
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);

                    // Enhanced button feedback
                    const originalText = this.innerHTML;
                    const originalStyle = this.style.background;

                    this.innerHTML = '‚úÖ Selected!';
                    this.style.background = '#28a745';
                    this.disabled = true;

                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.style.background = originalStyle;
                        this.disabled = false;
                    }, 1500);
                }
            };
        }

        if (closeBtn) {
            closeBtn.onclick = () => closeSimpleManualCopy();
        }

        // Close on overlay click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeSimpleManualCopy();
            }
        });

        // Close on escape key
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                closeSimpleManualCopy();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }, 100);
}

// üîß HELPER FUNCTION: Close manual copy modal
function closeSimpleManualCopy() {
    const modal = document.getElementById('simpleManualCopy');
    if (modal) {
        modal.remove();
        console.log('Manual copy modal closed');
    }
}

// üîß HELPER FUNCTION: Reset copy button to original state
function resetCopyButton() {
    const copyBtn = document.getElementById('copyTestCaseBtn');
    if (copyBtn) {
        const originalText = copyBtn.getAttribute('data-original-text') || '<span>üìã</span> Copy to Clipboard';
        const originalBackground = copyBtn.getAttribute('data-original-bg') || '';

        copyBtn.innerHTML = originalText;
        copyBtn.style.background = originalBackground;
        copyBtn.disabled = false;

        // Clear any pending timeout
        if (copyBtn.resetTimeout) {
            clearTimeout(copyBtn.resetTimeout);
            copyBtn.resetTimeout = null;
        }

        console.log('Copy button reset to original state');
    }
}

// üîß INITIALIZE: Set up button on page load
document.addEventListener('DOMContentLoaded', function() {
    // Store original button state when page loads
    const copyBtn = document.getElementById('copyTestCaseBtn');
    if (copyBtn && !copyBtn.getAttribute('data-original-text')) {
        copyBtn.setAttribute('data-original-text', copyBtn.innerHTML);
        copyBtn.setAttribute('data-original-bg', copyBtn.style.background || '');
        console.log('Copy button original state stored');
    }
});

// üîß ADDITIONAL: Add this CSS for better button transitions
if (!document.querySelector('#copyButtonStyles')) {
    const style = document.createElement('style');
    style.id = 'copyButtonStyles';
    style.textContent = `
        .copy-btn {
            transition: all 0.3s ease !important;
        }
        .copy-btn:disabled {
            opacity: 0.8 !important;
            cursor: wait !important;
        }
    `;
    document.head.appendChild(style);
}





    // Toggle download options dropdown
    function toggleDownloadOptions(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('downloadOptions');
        dropdown.classList.toggle('show');

        // Close dropdown when clicking outside
        const closeDropdown = (e) => {
            if (!dropdown.contains(e.target) && !event.target.contains(e.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeDropdown);
            }
        };

        if (dropdown.classList.contains('show')) {
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 10);
        }
    }

    // Download test case in specified format
    async function downloadAsFormat(format) {
        try {
            // Hide the dropdown
            const dropdown = document.getElementById('downloadOptions');
            dropdown.classList.remove('show');

            const testCase = fullTestCaseContent || document.getElementById('resultBody').textContent;

            if (!testCase || testCase.trim() === '') {
                alert('No content to download');
                return;
            }

            // Get the correct download button based on test type
            const downloadBtn = currentTestType === 'prd'
                ? document.getElementById('downloadTestCaseBtnPRD')
                : document.getElementById('apiDownloadBtn');

            if (!downloadBtn) {
                alert('Download button not found');
                return;
            }

            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<span class="spinner"></span> Converting...';
            downloadBtn.disabled = true;

            // Create FormData for the API request
            const formData = new FormData();
            formData.append('text', testCase);
            formData.append('format', format);

            // Call the /convert API
            const response = await fetch('/ai/convert', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Get the response blob
            const blob = await response.blob();

            // Determine the file extension and MIME type
            let extension, mimeType;
            if (format === 'excel') {
                extension = 'xlsx';
                mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
            } else {
                extension = 'txt';
                mimeType = 'text/plain';
            }

            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/:/g, '-').substring(0, 19);
            const filename = `test_case_${timestamp}.${extension}`;

            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Clean up
            window.URL.revokeObjectURL(url);

            // Show success feedback
            downloadBtn.innerHTML = `<span>‚úÖ</span> Downloaded as ${format.toUpperCase()}`;
            downloadBtn.disabled = false;

            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
            }, 2000);

            console.log(`Downloaded as ${format}:`, {
                filename: filename,
                size: blob.size,
                format: format
            });

        } catch (error) {
            console.error('Failed to download:', error);

            // Reset button on error
            const downloadBtn = currentTestType === 'prd'
                ? document.getElementById('downloadTestCaseBtnPRD')
                : document.getElementById('apiDownloadBtn');

            if (downloadBtn) {
                downloadBtn.innerHTML = '<span>üíæ</span> Download';
                downloadBtn.disabled = false;
            }

            // Check if it's a network error
            if (error.message.includes('Failed to fetch')) {
                alert('Cannot connect to server. Please ensure the /convert API is available.');
            } else {
                alert(`Failed to download as ${format}. ${error.message}`);
            }
        }
    }

    // Simple download function for API tests (original behavior)
    function downloadTestCaseSimple() {
        try {
            const testCase = fullTestCaseContent || document.getElementById('resultBody').textContent;
            const resultMeta = document.getElementById('resultMeta').textContent;

            // Create a blob with the content
            const blob = new Blob([testCase], { type: 'text/plain' });

            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            // Generate filename based on metadata
            const timestamp = new Date().toISOString().replace(/:/g, '-').substring(0, 19);
            const filename = `test_case_${timestamp}.txt`;

            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // Clean up
            window.URL.revokeObjectURL(url);

            // Show success feedback
            const downloadBtn = document.getElementById('apiDownloadBtn');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<span>‚úÖ</span> Downloaded!';

            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
            }, 2000);

            console.log('Downloaded test case:', {
                filename: filename,
                size: blob.size,
                length: testCase.length
            });
        } catch (error) {
            console.error('Failed to download:', error);
            alert('Failed to download file. Please try copying the content instead.');
        }
    }

    // Legacy download function (keeping for backward compatibility if needed)
    function downloadTestCase() {
        if (currentTestType === 'prd') {
            // For PRD, trigger the dropdown
            const event = new Event('click');
            event.stopPropagation = () => {};
            toggleDownloadOptions(event);
        } else {
            // For API, use simple download
            downloadTestCaseSimple();
        }
    }

    // Close result modal
    function closeResultModal() {
        document.getElementById('resultModal').classList.remove('active');
        // Clear stored content when closing
        fullTestCaseContent = '';
    }

    // Update modal close on outside click
    window.onclick = function(event) {
        const apiTestModal = document.getElementById('apiTestModal');
        const promptModal = document.getElementById('promptModal');
        const resultModal = document.getElementById('resultModal');
        const prdTestModal = document.getElementById('prdTestModal');
        const authModal = document.getElementById('authModal');

        if (event.target === apiTestModal) {
            closeModal();
        } else if (event.target === promptModal) {
            closePromptModal();
        } else if (event.target === resultModal) {
            closeResultModal();
        } else if (event.target === prdTestModal) {
            closePRDModal();
        } else if (event.target === authModal) {
            closeAuthModal();
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            // Close any open modal
            if (document.getElementById('authModal').classList.contains('active')) {
                closeAuthModal();
            } else if (document.getElementById('claudeOverlayContainer').classList.contains('active')) {
                closeClaudeOverlay();
            } else if (document.getElementById('resultModal').classList.contains('active')) {
                closeResultModal();
            } else if (document.getElementById('promptModal').classList.contains('active')) {
                closePromptModal();
            } else if (document.getElementById('apiTestModal').classList.contains('active')) {
                closeModal();
            } else if (document.getElementById('prdTestModal').classList.contains('active')) {
                closePRDModal();
            }
        }
    });

    // Voice message functions
    function playWelcomeMessageWithPauses() {
        if (!('speechSynthesis' in window)) {
            console.warn('Speech synthesis not supported');
            return;
        }

        // Cancel any ongoing speech and clear the queue
        speechSynthesis.cancel();

        // Update button to show "Stop"
        const voiceToggle = document.getElementById('voiceToggle');
        if (voiceToggle) {
            voiceToggle.innerHTML = '<span style="font-size: 20px;">üõë</span><span>Stop</span>';
            voiceToggle.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
        }

        isVoicePlaying = true;

        // Add a small delay to ensure cancellation is complete
        setTimeout(() => {
            const messages = [
                'Welcome to DP World Cargoes Runner Advanced A I Model.',
                'Supercharge your AP I with A I-powered analytics, in wan intelligent platform.',
                'Click Launch LLM Discovery to generate intelligent test scripts from your New Relic data.',
                'Click PRD Test Case Generation to automatically create test cases from user stories and product requirements.',
                'Click AP I Test Generation to build comprehensive test scripts from your Swagger specifications.'
            ];

            let currentIndex = 0;

            function speakNext() {
                if (currentIndex < messages.length && isVoicePlaying) {
                    // Check if speech synthesis is not speaking
                    if (!speechSynthesis.speaking) {
                        const utterance = new SpeechSynthesisUtterance(messages[currentIndex]);
                        utterance.rate = 0.9;
                        utterance.pitch = 1;
                        utterance.volume = 1;
                        utterance.lang = 'hi-IN';

                        utterance.onend = function() {
                            console.log(`‚úì Sentence ${currentIndex + 1} completed`);
                            currentIndex++;
                            if (currentIndex < messages.length && isVoicePlaying) {
                                // Add 800ms pause between sentences
                                setTimeout(speakNext, 500);
                            } else {
                                console.log('‚úì All messages completed');
                                // Reset button to help state
                                isVoicePlaying = false;
                                const voiceToggle = document.getElementById('voiceToggle');
                                if (voiceToggle) {
                                    voiceToggle.innerHTML = '<span style="font-size: 20px;">üí°</span><span>Need Help?</span>';
                                    voiceToggle.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)';
                                }
                            }
                        };

                        utterance.onerror = function(event) {
                            if (event.error !== 'interrupted') {
                                console.error('Speech error:', event.error);
                            }
                            stopSpeech();
                        };

                        speechSynthesis.speak(utterance);
                    } else {
                        // If still speaking, wait a bit and try again
                        setTimeout(speakNext, 100);
                    }
                }
            }

            speakNext();
        }, 100);
    }

    // Function to stop speech
    function stopSpeech() {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
            isVoicePlaying = false;
            console.log('Speech stopped');

            // Update button appearance
            const voiceToggle = document.getElementById('voiceToggle');
            if (voiceToggle) {
                voiceToggle.innerHTML = '<span style="font-size: 20px;">üí°</span><span>Need Help?</span>';
                voiceToggle.style.background = 'linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%)';
            }
        }
    }

    // Initialize animations and event listeners
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Page loaded with session management. Voice will only play on speaker button click.');

        // Initialize session management
        updateUserSessionIndicator();

        // Add all event listeners for buttons
        const llmApiBtn = document.getElementById('llmApiBtn');
        if (llmApiBtn) {
            llmApiBtn.addEventListener('click', navigateToLLMAPI);
        }

        const prdTestBtn = document.getElementById('prdTestBtn');
        if (prdTestBtn) {
            prdTestBtn.addEventListener('click', showPRDTestModal);
        }

        const apiTestBtn = document.getElementById('apiTestBtn');
        if (apiTestBtn) {
            apiTestBtn.addEventListener('click', showAPITestModal);
        }

        // Modal close buttons
        const closePRDModalBtn = document.getElementById('closePRDModalBtn');
        if (closePRDModalBtn) {
            closePRDModalBtn.addEventListener('click', closePRDModal);
        }

        const processPRDBtn = document.getElementById('processPRDBtn');
        if (processPRDBtn) {
            processPRDBtn.addEventListener('click', processPRDTestCase);
        }

        const processUploadPRDBtn = document.getElementById('processUploadPRDBtn');
        if (processUploadPRDBtn) {
            processUploadPRDBtn.addEventListener('click', processUploadPRDTestCase);
        }

        // PRD checkbox event listeners
        const prdUserStoryEpic = document.getElementById('prdUserStoryEpic');
        if (prdUserStoryEpic) {
            prdUserStoryEpic.addEventListener('change', () => togglePRDExpand('userStoryEpic'));
        }

        const prdUpload = document.getElementById('prdUpload');
        if (prdUpload) {
            prdUpload.addEventListener('change', () => togglePRDExpand('upload'));
        }

        // Add event listeners for PRD form fields to check agreement eligibility
        const azureTokenField = document.getElementById('azureToken');
        const userStoryNoField = document.getElementById('userStoryNo');

        if (azureTokenField) {
            azureTokenField.addEventListener('input', checkAgreementEligibility);
        }

        if (userStoryNoField) {
            userStoryNoField.addEventListener('input', checkAgreementEligibility);
        }

        // Add event listener for agreement checkbox
        const prdAgreement = document.getElementById('prdAgreement');
        if (prdAgreement) {
            prdAgreement.addEventListener('change', handleAgreementChange);
        }

        const closeApiModalBtn = document.getElementById('closeApiModalBtn');
        if (closeApiModalBtn) {
            closeApiModalBtn.addEventListener('click', closeModal);
        }

        const processManualTestBtn = document.getElementById('processManualTestBtn');
        if (processManualTestBtn) {
            processManualTestBtn.addEventListener('click', processManualTest);
        }

        const fetchSwaggerBtn = document.getElementById('fetchSwaggerBtn');
        if (fetchSwaggerBtn) {
            fetchSwaggerBtn.addEventListener('click', fetchSwaggerData);
        }

        const closePromptModalBtn = document.getElementById('closePromptModalBtn');
        if (closePromptModalBtn) {
            closePromptModalBtn.addEventListener('click', closePromptModal);
        }

        const generateTestCaseBtn = document.getElementById('generateTestCaseBtn');
        if (generateTestCaseBtn) {
            generateTestCaseBtn.addEventListener('click', generateTestCase);
        }

        const copyTestCaseBtn = document.getElementById('copyTestCaseBtn');
        if (copyTestCaseBtn) {
            copyTestCaseBtn.addEventListener('click', copyTestCase);
        }

        // Download button now handled by onclick attribute
        // No need to add event listener here as it uses onclick

        const closeResultModalBtn = document.getElementById('closeResultModalBtn');
        if (closeResultModalBtn) {
            closeResultModalBtn.addEventListener('click', closeResultModal);
        }

        // Checkbox event listeners
        const manualApiTest = document.getElementById('manualApiTest');
        if (manualApiTest) {
            manualApiTest.addEventListener('change', () => toggleExpand('manual'));
        }

        const swaggerApiTest = document.getElementById('swaggerApiTest');
        if (swaggerApiTest) {
            swaggerApiTest.addEventListener('change', () => toggleExpand('swagger'));
        }

        // Add event listeners for PRD form validation
        const epicNoField = document.getElementById('epicNo');
        if (epicNoField) {
            epicNoField.addEventListener('blur', async function() {
                const epicNo = this.value.trim();
                const azureToken = document.getElementById('azureToken').value.trim();

                if (epicNo && azureToken) {
                    // Clear any existing error for this field
                    const existingError = document.getElementById('epicNo-error');
                    if (existingError) existingError.remove();

                    // Show loading indicator
                    const loadingSpan = document.createElement('span');
                    loadingSpan.id = 'epicNo-loading';
                    loadingSpan.innerHTML = '<span class="spinner" style="width: 15px; height: 15px; margin-left: 10px;"></span>';
                    this.parentElement.appendChild(loadingSpan);

                    const validation = await validateWorkItem(epicNo, azureToken, 'Epic');

                    // Remove loading indicator
                    const loading = document.getElementById('epicNo-loading');
                    if (loading) loading.remove();

                    if (!validation.valid) {
                        showPRDError('epicNo', validation.error);
                    }
                }
            });
        }

        if (userStoryNoField) {
            userStoryNoField.addEventListener('blur', async function() {
                const userStoryNo = this.value.trim();
                const azureToken = document.getElementById('azureToken').value.trim();

                if (userStoryNo && azureToken) {
                    // Clear any existing error for this field
                    const existingError = document.getElementById('userStoryNo-error');
                    if (existingError) existingError.remove();

                    const userStories = userStoryNo.split(',').map(story => story.trim()).filter(story => story);

                    // Show loading indicator
                    const loadingSpan = document.createElement('span');
                    loadingSpan.id = 'userStoryNo-loading';
                    loadingSpan.innerHTML = '<span class="spinner" style="width: 15px; height: 15px; margin-left: 10px;"></span>';
                    this.parentElement.appendChild(loadingSpan);

                    const invalidStories = [];
                    for (const storyId of userStories) {
                        const validation = await validateWorkItem(storyId, azureToken, 'User Story');
                        if (!validation.valid) {
                            invalidStories.push({
                                id: storyId,
                                error: validation.error
                            });
                        }
                    }

                    // Remove loading indicator
                    const loading = document.getElementById('userStoryNo-loading');
                    if (loading) loading.remove();

                    if (invalidStories.length > 0) {
                        const errorMessages = invalidStories.map(item => `${item.id}: ${item.error}`).join('<br>');
                        showPRDError('userStoryNo', errorMessages);
                    }
                }
            });
        }

        // Voice toggle button
        const voiceToggle = document.getElementById('voiceToggle');
        if (voiceToggle) {
            voiceToggle.addEventListener('click', function(e) {
                // Stop event propagation
                e.stopPropagation();

                console.log('Voice button clicked - isPlaying:', isVoicePlaying);

                if (isVoicePlaying) {
                    // Stop the speech
                    stopSpeech();
                } else {
                    // Play the welcome message
                    playWelcomeMessageWithPauses();
                }

                // Visual feedback
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 100);
            });
        }

        const features = document.querySelectorAll('.feature');
        features.forEach((feature, index) => {
            feature.style.opacity = '0';
            feature.style.transform = 'translateX(-20px)';

            setTimeout(() => {
                feature.style.transition = 'all 0.5s ease';
                feature.style.opacity = '1';
                feature.style.transform = 'translateX(0)';
            }, 100 * (index + 1));
        });

        const buttons = document.querySelectorAll('.cta-button');
        buttons.forEach((button, index) => {
            button.style.opacity = '0';
            button.style.transform = 'translateY(20px)';

            setTimeout(() => {
                button.style.transition = 'all 0.5s ease';
                button.style.opacity = '1';
                button.style.transform = 'translateY(0)';
            }, 300 + (100 * index));
        });
    });

    // Reset button state when page is restored from back-forward cache
    window.addEventListener('pageshow', function (event) {
        const loadingRing = document.getElementById('loadingRing');
        const button = document.getElementById('llmApiBtn');

        if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
            loadingRing.style.display = 'none';
            button.style.pointerEvents = 'auto';
        }
    });
        // Initialize PRD checkboxes to handle mutual exclusivity
        document.getElementById('prdUserStoryEpic')?.addEventListener('change', function(e) {
            const expandable = document.getElementById('prdUserStoryEpicExpand');
            if (e.target.checked) {
                expandable.classList.add('active');
                // Uncheck other options
                document.getElementById('prdUpload').checked = false;
                document.getElementById('prdUploadExpand').classList.remove('active');
                document.getElementById('customizeTestGeneration').checked = false;
                document.getElementById('customizeTestGenerationExpand').classList.remove('active');
            } else {
                expandable.classList.remove('active');
            }
        });

        document.getElementById('prdUpload')?.addEventListener('change', function(e) {
            const expandable = document.getElementById('prdUploadExpand');
            if (e.target.checked) {
                expandable.classList.add('active');
                // Uncheck other options
                document.getElementById('prdUserStoryEpic').checked = false;
                document.getElementById('prdUserStoryEpicExpand').classList.remove('active');
                document.getElementById('customizeTestGeneration').checked = false;
                document.getElementById('customizeTestGenerationExpand').classList.remove('active');
            } else {
                expandable.classList.remove('active');
            }
        });

        // Initialize customize test generation checkbox
        document.getElementById('customizeTestGeneration')?.addEventListener('change', function(e) {
            const expandable = document.getElementById('customizeTestGenerationExpand');
            if (e.target.checked) {
                expandable.classList.add('active');
                // Uncheck other options
                document.getElementById('prdUserStoryEpic').checked = false;
                document.getElementById('prdUserStoryEpicExpand').classList.remove('active');
                document.getElementById('prdUpload').checked = false;
                document.getElementById('prdUploadExpand').classList.remove('active');
            } else {
                expandable.classList.remove('active');
            }
        });

        // Close result modal
        document.getElementById('closeResultModalBtn')?.addEventListener('click', function() {
            document.getElementById('resultModal').classList.remove('active');
        });

        // Copy test case to clipboard
        document.getElementById('copyTestCaseBtn')?.addEventListener('click', async function() {
            const resultBody = document.getElementById('resultBody');
            const btn = this;
            const originalHTML = btn.innerHTML;

            try {
                // Show copying state
                btn.innerHTML = '<span>üìã</span> Copying...';
                btn.disabled = true;

                await navigator.clipboard.writeText(resultBody.textContent);

                // Show success state
                btn.innerHTML = '<span>‚úÖ</span> Copied!';

                // Reset after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                // Reset on error
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                alert('Failed to copy to clipboard');
            }
        });

        // Download button functionality is now handled by onclick attribute in HTML

        // Process custom test generation button
        document.getElementById('processCustomTestBtn')?.addEventListener('click', async function() {
            const customInput = document.getElementById('customTestInput').value.trim();

            if (!customInput) {
                alert('Please enter your custom test requirements.');
                return;
            }

            const btn = this;
            const originalHTML = btn.innerHTML;

            // Show result modal IMMEDIATELY with loading state
            const modal = document.getElementById('resultModal');
            const resultBody = document.getElementById('resultBody');
            const resultMeta = document.getElementById('resultMeta');

            // Set loading content in result modal
            resultBody.innerHTML = '<div class="spinner"></div><div class="loading-text" style="text-align: center; margin-top: 20px;">Generating Custom Test Cases...</div>';
            resultMeta.textContent = 'Please wait...';

            // Show the modal immediately
            modal.classList.add('active');

            try {
                // Show loading state on button too
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div><span class="loading-text">Processing...</span>';

                // Call the /contact-testCase-llm API
                const response = await fetch('/ai/contact-testCase-llm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        us_data: customInput
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();

                // Store the full content
                fullTestCaseContent = result;
                currentTestType = 'prd';  // Set to 'prd' to support Excel & TXT downloads

                // Update the already open modal with actual content
                resultBody.textContent = result;
                resultMeta.textContent = `Generated on ${new Date().toLocaleString()}`;

                // Update download button visibility for PRD (supports Excel & TXT)
                const prdDownloadContainer = document.getElementById('prdDownloadContainer');
                const apiDownloadBtn = document.getElementById('apiDownloadBtn');
                prdDownloadContainer.style.display = 'inline-block';  // Show Excel/TXT dropdown
                apiDownloadBtn.style.display = 'none';  // Hide simple download

                // Clear the input field for next use
                document.getElementById('customTestInput').value = '';

            } catch (error) {
                console.error('Error generating custom test cases:', error);

                // Update modal with error message
                resultBody.innerHTML = `<div style="color: red; text-align: center;">
                    <p><strong>Error:</strong> Failed to generate test cases</p>
                    <p>${error.message}</p>
                    <p>Please close this modal and try again.</p>
                </div>`;
                resultMeta.textContent = 'Error occurred';

            } finally {
                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        });

    // Initialize copy button event listener when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[INIT] DOMContentLoaded - Setting up copy button');

        // First, define our copy function if it doesn't exist
        if (!window.copyTestCase || typeof window.copyTestCase !== 'function') {
            console.log('[INIT] copyTestCase not found, something is wrong!');
        } else {
            console.log('[INIT] copyTestCase function is available');
        }

        // Copy test case button with HTTP/HTTPS compatibility
        const copyBtn = document.getElementById('copyTestCaseBtn');
        if (copyBtn) {
            // Check if button has onclick attribute
            if (copyBtn.onclick) {
                console.log('[INIT] Button has existing onclick handler, removing it');
                copyBtn.onclick = null;
            }

            // Remove any existing listeners first
            const newCopyBtn = copyBtn.cloneNode(true);
            newCopyBtn.onclick = null; // Remove any inline onclick
            copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);

            console.log('[INIT] Adding copy button event listener');
            newCopyBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();

                console.log('[BUTTON] Copy button clicked');
                console.log('[BUTTON] copyTestCase function exists?', typeof window.copyTestCase);

                const button = this;
                const originalHTML = button.innerHTML;
                const originalBg = window.getComputedStyle(button).backgroundColor;

                // Disable button during copy operation
                button.disabled = true;

                try {
                    // Call our specific copyTestCase function
                    const success = await window.copyTestCase();
                    console.log('[BUTTON] Copy function returned:', success);

                    if (success === true) {
                        // Success feedback
                        console.log('[BUTTON] Showing success UI');
                        button.innerHTML = '<span>‚úì</span> Copied!';
                        button.style.backgroundColor = '#28a745';

                        setTimeout(() => {
                            button.innerHTML = originalHTML;
                            button.style.backgroundColor = '';
                            button.disabled = false;
                        }, 2000);
                    } else {
                        // Error feedback
                        console.log('[BUTTON] Showing error UI - copy returned:', success);
                        button.innerHTML = '<span>‚ö†</span> Copy Failed - Try Manual Copy';
                        button.style.backgroundColor = '#dc3545';

                        setTimeout(() => {
                            button.innerHTML = originalHTML;
                            button.style.backgroundColor = '';
                            button.disabled = false;
                        }, 3000);
                    }
                } catch (error) {
                    // Handle any errors that weren't caught in copyTestCase
                    console.error('[BUTTON] Error in button handler:', error);
                    button.innerHTML = '<span>‚ö†</span> Copy Failed';
                    button.style.backgroundColor = '#dc3545';

                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.backgroundColor = '';
                        button.disabled = false;
                    }, 3000);
                }
            });
        } else {
            console.log('[INIT] Copy button not found');
        }

        // Download button functionality is handled by toggleDownloadOptions and downloadAsFormat functions

        // Log clipboard access status on page load
        console.log('=== Clipboard Access Status ===');
        console.log('URL:', window.location.href);
        console.log('Protocol:', window.location.protocol);
        console.log('Is Secure Context:', window.isSecureContext);
        console.log('Clipboard API Available:', !!navigator.clipboard);
        console.log('execCommand Available:', !!document.execCommand);

        if (!window.isSecureContext) {
            console.warn('‚ö† Not in secure context. Using fallback copy method.');
        }
    });
    </script>
</body>
</html>