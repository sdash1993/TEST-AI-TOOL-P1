<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Discovery Suite - Enhanced with Integrated Parameter Extraction</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .security-badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .swagger-badge {
            display: inline-block;
            background: #f39c12;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 15px;
            margin-left: 10px;
        }

        .parameter-badge {
            display: inline-block;
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 15px;
            margin-left: 10px;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .info-boxes-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
            max-width: 300px;
        }

        .info-box-left {
            border-left: 4px solid #28a745;
        }

        .info-box-right {
            border-left: 4px solid #ffc107;
        }

        .info-box h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .info-box ul {
            margin: 0;
            padding-left: 20px;
            list-style-type: disc;
        }

        .info-box li {
            margin-bottom: 4px;
            font-size: 0.9em;
            color: #555;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .searchable-dropdown {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #007bff;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.highlighted {
            background-color: #007bff;
            color: white;
        }

        .selected-app-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .btn {
            background: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-curl {
            background: #9c27b0;
            color: white;
        }

        .btn-curl:hover {
            background: #7b1fa2;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Smart Test Case Dropdown Styles */
        .smart-test-dropdown {
            position: relative;
            display: inline-block;
        }

        .smart-test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 220px;
        }

        .smart-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .smart-test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .smart-test-btn .rocket-icon {
            font-size: 1.2em;
        }

        .smart-test-btn .dropdown-arrow {
            margin-left: auto;
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .smart-test-btn.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .smart-test-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .smart-test-dropdown-content.show {
            display: block;
        }

        .smart-test-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .smart-test-option:hover {
            background-color: #f8f9fa;
        }

        .smart-test-option:last-child {
            border-bottom: none;
        }

        .smart-test-option-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .smart-test-option-description {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }

        .smart-test-option-category {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-top: 4px;
        }

        .smart-test-loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .smart-test-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .connection-steps {
            margin-bottom: 30px;
        }

        .connection-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .step-number.completed {
            background: #28a745;
        }

        .step-number.current {
            background: #ffc107;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-text {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metric-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-success {
            background: #00b894;
            color: white;
        }

        .api-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .api-table th,
        .api-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .api-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        .api-table tr:hover {
            background: #f8f9fa;
        }

        .api-endpoint {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            max-width: 300px;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card.success {
            border-left-color: #28a745;
        }

        .stat-card.warning {
            border-left-color: #ffc107;
        }

        .stat-card.danger {
            border-left-color: #dc3545;
        }

        .stat-title {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }

        .api-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .success-rate {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
        }

        .success-rate.high {
            background: #d4edda;
            color: #155724;
        }

        .success-rate.medium {
            background: #fff3cd;
            color: #856404;
        }

        .success-rate.low {
            background: #f8d7da;
            color: #721c24;
        }

        .response-time {
            text-align: center;
            font-weight: 500;
        }

        .response-time.fast {
            color: #28a745;
        }

        .response-time.medium {
            color: #ffc107;
        }

        .response-time.slow {
            color: #dc3545;
        }

        /* Enhanced Endpoint Details Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: none;
            border-radius: 10px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .detail-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .detail-card.swagger {
            border-left-color: #ffc107;
        }

        .detail-card.newrelic {
            border-left-color: #28a745;
        }

        .detail-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .detail-value {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .detail-value.json {
            white-space: pre-wrap;
        }

        .swagger-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff8dc;
            border-radius: 8px;
            border: 1px solid #ffc107;
        }

        .swagger-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .swagger-match-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .swagger-match-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .swagger-match-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .payload-tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .payload-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }

        .payload-tab.active {
            background: white;
            border-bottom: 1px solid white;
        }

        .payload-content {
            display: none;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 4px;
            margin-top: -1px;
        }

        .payload-content.active {
            display: block;
        }

        /* Enhanced Parameter Styles */
        .parameter-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .parameter-section h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parameter-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .parameter-table th,
        .parameter-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .parameter-table th {
            background: #f1f3f4;
            font-weight: 600;
            color: #2c3e50;
        }

        .parameter-table tr:hover {
            background: #f8f9fa;
        }

        .param-name {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #0056b3;
        }

        .param-type {
            background: #e3f2fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #1976d2;
        }

        .param-required {
            background: #ffebee;
            color: #c62828;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .param-optional {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .param-description {
            font-style: italic;
            color: #6c757d;
            max-width: 300px;
            word-wrap: break-word;
        }

        .param-example {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .nested-params {
            margin-left: 20px;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 2px solid #e9ecef;
        }

        .nested-param {
            margin-bottom: 8px;
            padding: 8px;
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .enum-values {
            background: #fff3cd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #856404;
            margin-top: 5px;
        }

        .no-parameters {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .parameter-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .parameter-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .parameter-tab:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        .parameter-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: #f8f9fa;
        }

        .parameter-tab-content {
            display: none;
        }

        .parameter-tab-content.active {
            display: block;
        }

        .parameter-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .param-summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .param-summary-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
        }

        .param-summary-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .copy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .copy-button:hover {
            background: #218838;
        }

        .json-viewer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .curl-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .curl-section h4 {
            color: #155724;
            margin-bottom: 15px;
        }

        .curl-command {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }

        .action-buttons {
            margin-top: 20px;
            text-align: center;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* LLM Modal Styles */
        .llm-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .llm-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 30px;
            border: none;
            border-radius: 15px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .llm-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .llm-modal-title {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .llm-close {
            color: #aaa;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            transition: color 0.3s ease;
        }

        .llm-close:hover,
        .llm-close:focus {
            color: #dc3545;
            text-decoration: none;
        }

        .llm-content {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #007bff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 70vh;
            overflow-y: auto;
            color: #2c3e50;
        }

        .llm-loading {
            text-align: center;
            padding: 60px;
        }

        .llm-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        .llm-loading-text {
            font-size: 1.2em;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .llm-progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .llm-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #667eea);
            animation: progressAnimation 2s ease-in-out infinite;
        }

        @keyframes progressAnimation {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        .llm-actions {
            margin-top: 25px;
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .llm-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .llm-btn-copy {
            background: #28a745;
            color: white;
        }

        .llm-btn-copy:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .llm-btn-download {
            background: #17a2b8;
            color: white;
        }

        .llm-btn-download:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .llm-btn-close {
            background: #6c757d;
            color: white;
        }

        .llm-btn-close:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .llm-error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
        }

        .llm-error h4 {
            margin: 0 0 10px 0;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .info-boxes-container {
                flex-direction: column;
                gap: 15px;
            }

            .info-box {
                max-width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .api-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .llm-modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }

            .llm-modal-title {
                font-size: 1.5em;
            }

            .parameter-summary {
                flex-direction: column;
            }

            .parameter-tabs {
                flex-direction: column;
            }

            .parameter-tab {
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }

            .llm-actions {
                flex-direction: column;
                align-items: center;
            }

            .smart-test-dropdown {
                width: 100%;
            }

            .smart-test-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîç LLM API Discovery </h1>
        <p>New Relic API Analysis & Generate AI Test Case</p>
        <div class="security-badge">üîí Complete API Discovery ‚Ä¢ Last 30 Days Analysis</div>
        <div class="swagger-badge">üìã Swagger Integration ‚Ä¢ Request/Response Payloads</div>
        <div class="parameter-badge">üéØ LLM Integration For Test Case Generation</div>
    </div>

    <div class="main-content">
        <div class="info-boxes-container">
            <div class="info-box info-box-left">
                <h4>üõ°Ô∏è Security</h4>
                <ul>
                    <li>Read-only access</li>
                    <li>Auto data purge</li>
                    <li>No PII required</li>
                </ul>
            </div>
            <div class="info-box info-box-center">
                <h4>ü§ñ LLM Integration </h4>
                <ul>
                    <li>Advanced AI Engine</li>
                    <li>Multi-Model Architecture</li>
                    <li>Intelligent Automation</li>
                </ul>
            </div>

            <div class="info-box info-box-right">
                <h4>üìã Swagger Integration</h4>
                <ul>
                    <li>Auto endpoint matching</li>
                    <li>Complete schemas</li>
                    <li>All parameter types</li>
                    <li>Ready-to-use cURL</li>
                </ul>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'connection')">Connection Setup</button>
            <button class="tab" onclick="showTab(event, 'analysis')">API Discovery</button>
            <button class="tab" onclick="showTab(event, 'export')">Export & Review</button>
        </div>

        <!-- Connection Setup Tab -->
        <div id="connection" class="tab-content active">
            <h2>üîå New Relic Connection Setup</h2>

            <div class="connection-steps">
                <div class="connection-step">
                    <div class="step-number current" id="step1">1</div>
                    <div>
                        <h4>Enter API Key</h4>
                        <p>Provide your New Relic Query API key</p>
                    </div>
                </div>
                <div class="connection-step">
                    <div class="step-number" id="step2">2</div>
                    <div>
                        <h4>Select Account</h4>
                        <p>Choose your New Relic account</p>
                    </div>
                </div>
                <div class="connection-step">
                    <div class="step-number" id="step3">3</div>
                    <div>
                        <h4>Select Application</h4>
                        <p>Choose the application to analyze</p>
                    </div>
                </div>
                <div class="connection-step">
                    <div class="step-number" id="step4">4</div>
                    <div>
                        <h4>Configure Swagger (Optional)</h4>
                        <p>Add Swagger URL for enhanced API documentation</p>
                    </div>
                </div>
            </div>

            <form id="connectionForm">
                <div class="form-group">
                    <label for="apiKey">New Relic Query API Key</label>
                    <input type="password" id="apiKey" name="apiKey" required placeholder="Enter your New Relic API key">
                    <div class="help-text">Generate from: New Relic One ‚Üí API Keys ‚Üí Query Keys</div>
                </div>

                <div class="form-group account-selector" id="accountSelector" style="display: none;">
                    <label for="accountSelect">Select Account</label>
                    <select id="accountSelect" name="accountId" onchange="onAccountChange()">
                        <option value="">Loading accounts...</option>
                    </select>
                </div>

                <div class="form-group app-selector" id="appSelector" style="display: none;">
                    <label for="appSelect">Select Application</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="appSelect" name="appName" placeholder="Type to search applications..." autocomplete="off" oninput="handleAppInput(event)" onfocus="showDropdown()" onblur="hideDropdownDelayed()">
                        <div id="appDropdownList" class="dropdown-list"></div>
                    </div>
                    <div id="selectedAppInfo" class="selected-app-info" style="display: none;"></div>
                </div>

                <div class="form-group swagger-config" id="swaggerConfig" style="display: none;">
                    <label for="swaggerUrl">Swagger/OpenAPI Base URL (Optional)</label>
                    <input type="url" id="swaggerUrl" name="swaggerUrl" placeholder="https://api.example.com/your-service">
                    <div class="help-text">Enter your Swagger/OpenAPI base URL to get comprehensive parameter details and cURL commands</div>
                </div>

                <div class="form-group" id="timeRangeGroup" style="display: none;">
                    <label for="timeRange">Analysis Time Range</label>
                    <select id="timeRange" name="timeRange">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days (Recommended)</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>

                <button type="button" class="btn" onclick="getAccounts()" id="getAccountsBtn">Get Accounts</button>
                <button type="button" class="btn btn-secondary" onclick="getApps()" id="getAppsBtn" style="display: none;">Get Applications</button>
                <button type="button" class="btn" onclick="testConnection()" id="testConnectionBtn" style="display: none;">Test Connection</button>
                <button type="button" class="btn btn-secondary" onclick="showTab(event, 'analysis')" id="nextStepBtn" style="display: none;">Start API Discovery</button>
            </form>

            <div id="connectionStatus" style="display: none;"></div>
        </div>

        <!-- API Discovery Tab -->
        <div id="analysis" class="tab-content">
            <h2>üîç API Discovery & Analysis</h2>

            <div class="alert alert-info">
                <strong>API Discovery Progress:</strong> We'll analyze your New Relic data to discover all APIs from the last 30 days.
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="analysisProgress" style="width: 0%"></div>
            </div>

            <div id="analysisSteps">
                <div class="metric-card">
                    <h4>üîç Discovering All API Endpoints</h4>
                    <p>Scanning your application for all API endpoints in the last 30 days...</p>
                    <span class="status-indicator status-pending">Pending</span>
                </div>
                <div class="metric-card">
                    <h4>üìà Analyzing Traffic Patterns</h4>
                    <p>Examining request volumes and usage patterns...</p>
                    <span class="status-indicator status-pending">Pending</span>
                </div>
                <div class="metric-card">
                    <h4>‚ö° Performance Analysis</h4>
                    <p>Calculating response times and performance metrics...</p>
                    <span class="status-indicator status-pending">Pending</span>
                </div>
                <div class="metric-card">
                    <h4>üö® Error Analysis</h4>
                    <p>Identifying API endpoints with errors and success rates...</p>
                    <span class="status-indicator status-pending">Pending</span>
                </div>
            </div>

            <div id="analysisResults" style="display: none;">
                <div>
                    <h3>üìã API Discovery Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-title">Total APIs Found</div>
                            <div class="stat-value" id="totalApisCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Total Requests</div>
                            <div class="stat-value" id="totalRequestsCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Avg Response Time</div>
                            <div class="stat-value" id="avgResponseTime">0ms</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-title">High Traffic APIs</div>
                            <div class="stat-value" id="highTrafficCount">0</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-title">Slow APIs (>1s)</div>
                            <div class="stat-value" id="slowApisCount">0</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-title">Error-Prone APIs</div>
                            <div class="stat-value" id="errorProneCount">0</div>
                        </div>
                    </div>

                    <h4>üóÇÔ∏è Complete API List</h4>
                    <div class="api-filter">
                        <input type="text" class="filter-input" id="apiFilter" placeholder="Filter APIs..." onkeyup="filterApiTable()">
                        <select class="filter-select" id="sortBy" onchange="sortApiTable()">
                            <option value="requests">Sort by Requests</option>
                            <option value="response_time">Sort by Response Time</option>
                            <option value="success_rate">Sort by Success Rate</option>
                            <option value="endpoint">Sort by Endpoint Name</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportApiList()">Export API List</button>
                    </div>

                    <div class="table-container">
                        <table class="api-table" id="apiTable">
                            <thead>
                            <tr>
                                <th>API Endpoint</th>
                                <th>Total Requests</th>
                                <th>Avg Response Time</th>
                                <th>Min Time</th>
                                <th>Max Time</th>
                                <th>Error Count</th>
                                <th>Success Rate</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="apiTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">Loading API data...</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn" onclick="startAnalysis()" id="startAnalysisBtn">Start API Discovery</button>
            </div>
        </div>

        <!-- Export & Review Tab -->
        <div id="export" class="tab-content">
            <h2>üì§ API Data Export & Review</h2>

            <div id="exportResults" style="display: none;">
                <div class="alert alert-success">
                    <strong>API Discovery Complete!</strong> Your comprehensive API list has been generated and is ready for export.
                </div>

                <div class="form-group">
                    <label for="exportFormat">Export Format</label>
                    <select id="exportFormat">
                        <option value="json">JSON (Complete Data)</option>
                        <option value="csv">CSV (Spreadsheet)</option>
                        <option value="excel">Excel (Advanced)</option>
                        <option value="api-list">Simple API List (TXT)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="additionalNotes">Additional Notes for Team</label>
                    <textarea id="additionalNotes" rows="4" placeholder="Any specific requirements, observations, or notes about the discovered APIs..."></textarea>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="exportData()" id="exportBtn">Export API Data</button>
                </div>
            </div>

            <div id="exportPending" class="alert alert-info">
                <strong>Ready for Export:</strong> Complete the API discovery step first to generate your comprehensive API data package.
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Endpoint Details Modal -->
<div id="endpointModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>üìã Complete Endpoint Analysis</h2>
        <div id="endpointDetails">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading comprehensive endpoint details...</p>
            </div>
        </div>
    </div>
</div>

<!-- LLM Modal for Smart Test Case Generation -->
<div id="llmModal" class="llm-modal">
    <div class="llm-modal-content">
        <div class="llm-modal-header">
            <h2 class="llm-modal-title">üöÄ Smart Test Case Generation</h2>
            <span class="llm-close" onclick="closeLLMModal()">&times;</span>
        </div>
        <div id="llmContent">
            <div class="llm-loading">
                <div class="llm-spinner"></div>
                <div class="llm-loading-text">Generating Smart Test Case...</div>
                <div class="llm-progress-bar">
                    <div class="llm-progress-fill"></div>
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">
                    Our AI is analyzing your endpoint and generating comprehensive test cases with all parameter combinations...
                </p>
            </div>
        </div>
        <div class="llm-actions" id="llmActions" style="display: none;">
            <button class="llm-btn llm-btn-copy" onclick="copyLLMResponse()">
                üìã Copy Test Case
            </button>
            <button class="llm-btn llm-btn-download" onclick="downloadLLMResponse()">
                üíæ Download Test Case
            </button>
            <button class="llm-btn llm-btn-close" onclick="closeLLMModal()">
                ‚ùå Close
            </button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let analysisData = null;
    let connectionData = null;
    let availableAccounts = [];
    let availableApps = [];
    let filteredApps = [];
    let selectedAppIndex = -1;
    let selectedAppName = null;
    let allApisData = [];
    let swaggerUrl = '';
    let currentEndpointUri = '';
    let currentEndpointDetails = null;
    let swaggerEnabled = false;
    let currentLLMResponse = '';
    let availablePrompts = []; // Store available prompts
    let currentDropdownEndpoint = null; // Store current endpoint for dropdown

    // Tab switching functionality
    function showTab(event, tabName) {
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));

        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('active'));

        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // Event handlers
    function onAccountChange() {
        const accountSelect = document.getElementById('accountSelect');
        const selectedAccount = accountSelect.value;

        const appSelect = document.getElementById('appSelect');
        appSelect.value = '';
        selectedAppName = null;

        document.getElementById('selectedAppInfo').style.display = 'none';
        document.getElementById('appSelector').style.display = 'none';
        document.getElementById('testConnectionBtn').style.display = 'none';
        document.getElementById('nextStepBtn').style.display = 'none';
        hideDropdown();

        if (selectedAccount) {
            getApps();
        }
    }

    function onAppChange() {
        const appSelect = document.getElementById('appSelect');
        const selectedApp = appSelect.value;

        selectedAppName = selectedApp;

        const appInfo = document.getElementById('selectedAppInfo');
        if (selectedApp && selectedAppName) {
            appInfo.innerHTML = `üì± Selected Application: <strong>"${selectedApp}"</strong>`;
            appInfo.style.display = 'block';
            document.getElementById('swaggerConfig').style.display = 'block';
            document.getElementById('testConnectionBtn').style.display = 'inline-block';
            updateStepStatus(4, 'current');
        } else {
            selectedAppName = null;
            appInfo.style.display = 'none';
            document.getElementById('swaggerConfig').style.display = 'none';
            document.getElementById('testConnectionBtn').style.display = 'none';
            document.getElementById('nextStepBtn').style.display = 'none';
        }
    }

    // Dropdown functions
    function showDropdown() {
        const dropdown = document.getElementById('appDropdownList');
        if (availableApps.length > 0) {
            if (filteredApps.length === 0) {
                filteredApps = [...availableApps];
            }
            renderDropdownItems();
            dropdown.style.display = 'block';
        }
    }

    function hideDropdownDelayed() {
        setTimeout(() => {
            hideDropdown();
        }, 200);
    }

    function hideDropdown() {
        const dropdown = document.getElementById('appDropdownList');
        dropdown.style.display = 'none';
        selectedAppIndex = -1;
    }

    function filterApps(searchTerm) {
        if (!searchTerm || searchTerm.trim() === '') {
            filteredApps = [...availableApps];
        } else {
            const term = searchTerm.toLowerCase().trim();
            filteredApps = availableApps.filter(app =>
                app.toLowerCase().includes(term)
            );
        }
        renderDropdownItems();
        selectedAppIndex = -1;
        document.getElementById('appDropdownList').style.display = 'block';
    }

    function renderDropdownItems() {
        const dropdown = document.getElementById('appDropdownList');
        dropdown.innerHTML = '';

        if (filteredApps.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'no-results';
            noResults.textContent = 'No applications found';
            dropdown.appendChild(noResults);
            return;
        }

        filteredApps.forEach((app, index) => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = app;
            item.addEventListener('click', () => selectApp(app));
            item.addEventListener('mouseenter', () => highlightItem(index));
            dropdown.appendChild(item);
        });
    }

    function selectApp(appName) {
        const appSelect = document.getElementById('appSelect');
        selectedAppName = appName;
        appSelect.value = appName;
        hideDropdown();
        onAppChange();
    }

    function highlightItem(index) {
        const items = document.querySelectorAll('.dropdown-item');
        items.forEach((item, i) => {
            if (i === index) {
                item.classList.add('highlighted');
            } else {
                item.classList.remove('highlighted');
            }
        });
        selectedAppIndex = index;
    }

    function handleAppInput(e) {
        const currentValue = e.target.value;
        if (selectedAppName && currentValue !== selectedAppName) {
            selectedAppName = null;
            document.getElementById('selectedAppInfo').style.display = 'none';
            document.getElementById('swaggerConfig').style.display = 'none';
            document.getElementById('testConnectionBtn').style.display = 'none';
            document.getElementById('nextStepBtn').style.display = 'none';
        }
        filterApps(currentValue);
    }

    // Load Available Prompts
    function loadAvailablePrompts() {
        console.log('üîÑ Loading available prompts...');

        return fetch('/ai/get-available-prompts', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Available prompts loaded:', data);

            if (data.status === 'success') {
                availablePrompts = data.prompts;
                console.log(`‚úÖ Found ${availablePrompts.length} available prompts`);
                return availablePrompts;
            } else {
                throw new Error(data.message || 'Failed to load prompts');
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading prompts:', error);
            availablePrompts = [];
            return [];
        });
    }

    // Smart Test Case Dropdown Functions
    function createSmartTestDropdown(basePath, methodType) {
        const dropdownId = `smart-test-dropdown-${Date.now()}`;

        return `
            <div class="smart-test-dropdown" id="${dropdownId}">
                <button class="smart-test-btn" onclick="toggleSmartTestDropdown('${dropdownId}', '${basePath}', '${methodType}')">
                    <span class="rocket-icon">üöÄ</span>
                    <span>Generate Smart Test</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="smart-test-dropdown-content" id="${dropdownId}-content">
                    <div class="smart-test-loading">
                        <div class="spinner"></div>
                        <p>Loading test case options...</p>
                    </div>
                </div>
            </div>
        `;
    }

    function toggleSmartTestDropdown(dropdownId, basePath, methodType) {
        const btn = document.querySelector(`#${dropdownId} .smart-test-btn`);
        const content = document.getElementById(`${dropdownId}-content`);

        if (!btn || !content) {
            console.error('‚ùå Dropdown elements not found');
            return;
        }

        const isOpen = content.classList.contains('show');

        if (isOpen) {
            // Close dropdown
            content.classList.remove('show');
            btn.classList.remove('active');
        } else {
            // Close any other open dropdowns
            document.querySelectorAll('.smart-test-dropdown-content.show').forEach(el => {
                el.classList.remove('show');
            });
            document.querySelectorAll('.smart-test-btn.active').forEach(el => {
                el.classList.remove('active');
            });

            // Open this dropdown
            content.classList.add('show');
            btn.classList.add('active');

            // Store current endpoint info
            currentDropdownEndpoint = {
                basePath: basePath,
                methodType: methodType,
                dropdownId: dropdownId
            };

            // Load prompts and populate dropdown
            loadPromptsForDropdown(dropdownId, basePath, methodType);
        }
    }

    function loadPromptsForDropdown(dropdownId, basePath, methodType) {
        const content = document.getElementById(`${dropdownId}-content`);

        if (!content) {
            console.error('‚ùå Dropdown content not found');
            return;
        }

        // Show loading state
        content.innerHTML = `
            <div class="smart-test-loading">
                <div class="spinner"></div>
                <p>Loading test case options...</p>
            </div>
        `;

        // Load available prompts
        loadAvailablePrompts()
            .then(prompts => {
                if (prompts.length === 0) {
                    content.innerHTML = `
                        <div class="smart-test-error">
                            <strong>‚ùå No Test Case Options Available</strong><br>
                            Unable to load available test case generators. Please check your connection.
                        </div>
                    `;
                    return;
                }

                // Populate dropdown with prompts
                let html = '';
                prompts.forEach(prompt => {
                    html += `
                        <div class="smart-test-option" onclick="selectPromptAndGenerate('${prompt.id}', '${basePath}', '${methodType}', '${dropdownId}')">
                            <div class="smart-test-option-title">${prompt.name}</div>
                            <div class="smart-test-option-description">${prompt.description}</div>
                            <div class="smart-test-option-category">${prompt.category}</div>
                        </div>
                    `;
                });

                content.innerHTML = html;
                console.log(`‚úÖ Populated dropdown with ${prompts.length} prompt options`);
            })
            .catch(error => {
                console.error('‚ùå Error loading prompts for dropdown:', error);
                content.innerHTML = `
                    <div class="smart-test-error">
                        <strong>‚ùå Error Loading Options</strong><br>
                        ${error.message || 'Unable to load test case generators. Please try again.'}
                    </div>
                `;
            });
    }

    function selectPromptAndGenerate(promptId, basePath, methodType, dropdownId) {
        console.log('üöÄ Selected prompt:', promptId);
        console.log('üìç Base Path:', basePath);
        console.log('üìù Method:', methodType);
        console.log('üéØ Dropdown ID:', dropdownId);

        // Close dropdown
        const content = document.getElementById(`${dropdownId}-content`);
        const btn = document.querySelector(`#${dropdownId} .smart-test-btn`);

        if (content) content.classList.remove('show');
        if (btn) btn.classList.remove('active');

        // Find the selected prompt details
        const selectedPrompt = availablePrompts.find(p => p.id === promptId);
        if (!selectedPrompt) {
            console.error('‚ùå Selected prompt not found');
            alert('‚ùå Selected test case generator not found. Please try again.');
            return;
        }

        console.log('‚úÖ Selected prompt details:', selectedPrompt);

        // Generate test case with selected prompt
        generateSmartTestCaseWithPrompt(basePath, methodType, promptId, selectedPrompt.name);
    }

    function generateSmartTestCaseWithPrompt(basePath, methodType, promptType, promptName) {
        console.log('üöÄ Generating Smart Test Case with Prompt');
        console.log('üìç Base Path:', basePath);
        console.log('üìù Method:', methodType);
        console.log('üéØ Prompt Type:', promptType);
        console.log('üìã Prompt Name:', promptName);

        // Check if we have current endpoint details
        if (!currentEndpointDetails) {
            console.error('‚ùå No current endpoint details available');
            alert('‚ùå No endpoint details available. Please try refreshing the endpoint analysis.');
            return;
        }

        console.log('üìã Current Endpoint Details:', currentEndpointDetails);

        // Extract parameters and payload from current endpoint details
        const parameters = currentEndpointDetails.swagger_parameters || {};
        const requestPayload = currentEndpointDetails.swagger_request_payload || null;

        console.log('üìã Parameters:', parameters);
        console.log('üì¶ Request Payload:', requestPayload);

        // Build complete endpoint with path and query parameters
        let completeEndpoint = basePath;

        try {
            // Add path parameters
            if (parameters.path_parameters && parameters.path_parameters.length > 0) {
                console.log('üîó Processing Path Parameters:', parameters.path_parameters);
                parameters.path_parameters.forEach(param => {
                    const placeholder = `{${param.name}}`;
                    const exampleValue = param.example || param.default || `sample_${param.name}`;
                    completeEndpoint = completeEndpoint.replace(placeholder, exampleValue);
                    console.log(`   ‚Ä¢ ${param.name}: ${placeholder} ‚Üí ${exampleValue}`);
                });
            }

            // Add query parameters
            if (parameters.query_parameters && parameters.query_parameters.length > 0) {
                console.log('üîç Processing Query Parameters:', parameters.query_parameters);
                const queryParams = [];
                parameters.query_parameters.forEach(param => {
                    const exampleValue = param.example || param.default || `sample_${param.name}`;
                    queryParams.push(`${param.name}=${exampleValue}`);
                    console.log(`   ‚Ä¢ ${param.name}=${exampleValue}`);
                });

                if (queryParams.length > 0) {
                    completeEndpoint += '?' + queryParams.join('&');
                }
            }

            console.log('üéØ Complete Endpoint:', completeEndpoint);

        } catch (error) {
            console.error('‚ùå Error processing parameters:', error);
            completeEndpoint = basePath; // Fallback to base path
        }

        // Show LLM modal
        const llmModal = document.getElementById('llmModal');
        const llmContent = document.getElementById('llmContent');
        const llmActions = document.getElementById('llmActions');
        const llmTitle = document.querySelector('.llm-modal-title');

        if (!llmModal) {
            console.error('‚ùå LLM Modal not found');
            alert('‚ùå LLM Modal not found. Please check the page structure.');
            return;
        }

        // Update modal title with prompt name
        if (llmTitle) {
            llmTitle.textContent = `üöÄ ${promptName} - Test Case Generation`;
        }

        llmModal.style.display = 'block';
        llmActions.style.display = 'none';

        // Show loading state
        llmContent.innerHTML = `
            <div class="llm-loading">
                <div class="llm-spinner"></div>
                <div class="llm-loading-text">Generating ${promptName} Test Case...</div>
                <div class="llm-progress-bar">
                    <div class="llm-progress-fill"></div>
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">
                    Our AI is analyzing your endpoint using <strong>${promptName}</strong> and generating comprehensive test cases...
                </p>
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.8em;">
                    <strong>üéØ Analyzing:</strong> ${methodType} ${completeEndpoint}<br>
                    <strong>üìã Generator:</strong> ${promptName}<br>
                    <strong>üîß Prompt Type:</strong> ${promptType}
                </div>
            </div>
        `;

        // Prepare request data for LLM
        const llmRequestData = {
            endpoint: completeEndpoint,
            method_type: methodType,
            payload: requestPayload,
            prompt_type: promptType // Add prompt_type parameter
        };

        console.log('üì§ Sending LLM request:', llmRequestData);
        console.log('üì§ Request URL: /contact-llm');
        console.log('üì§ Request Method: POST');

        // Call the LLM API
        fetch('/ai/contact-llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(llmRequestData)
        })
        .then(response => {
            console.log('üì• LLM Response received:', response.status, response.statusText);
            console.log('üì• Response headers:', response.headers);

            if (!response.ok) {
                return response.text().then(text => {
                    console.error('‚ùå Response error text:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }

            return response.text(); // LLM returns raw text
        })
        .then(data => {
            console.log('‚úÖ LLM Response successful');
            console.log('üìù Response length:', data.length);
            console.log('üìù Response preview:', data.substring(0, 200) + '...');

            currentLLMResponse = data;

            // Display the LLM response - use textContent to preserve HTML-like tags
            llmContent.innerHTML = `
                <div class="llm-content"></div>
            `;

            // Set the text content to preserve <tenant> and other HTML-like tags
            const contentDiv = llmContent.querySelector('.llm-content');
            contentDiv.textContent = data;

            // Show action buttons
            llmActions.style.display = 'flex';
        })
        .catch(error => {
            console.error('‚ùå LLM Error:', error);

            llmContent.innerHTML = `
                <div class="llm-error">
                    <h4>‚ùå Error Generating ${promptName} Test Case</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Request Details:</strong></p>
                    <ul>
                        <li><strong>Complete Endpoint:</strong> ${completeEndpoint}</li>
                        <li><strong>Method:</strong> ${methodType}</li>
                        <li><strong>Payload:</strong> ${requestPayload ? 'Present' : 'None'}</li>
                        <li><strong>Prompt Type:</strong> ${promptType}</li>
                        <li><strong>Prompt Name:</strong> ${promptName}</li>
                        <li><strong>Backend URL:</strong> /contact-llm</li>
                    </ul>
                    <p><strong>Debug Information:</strong></p>
                    <ul>
                        <li>Check browser Network tab for failed requests</li>
                        <li>Verify backend server is running on localhost:5000</li>
                        <li>Check backend logs for LLM service errors</li>
                        <li>Ensure CORS is properly configured</li>
                        <li>Verify prompt type '${promptType}' is available in backend</li>
                    </ul>
                </div>
            `;

            // Show only close button on error
            llmActions.innerHTML = `
                <button class="llm-btn llm-btn-close" onclick="closeLLMModal()">
                    ‚ùå Close
                </button>
            `;
            llmActions.style.display = 'flex';
        });
    }

    // Create a new function specifically for the modal dropdown
    function createSmartTestDropdownForModal(endpoint, methodType, requestBody) {
        const dropdownId = `modal-smart-test-dropdown-${Date.now()}`;

        // Store the request body for this endpoint
        if (requestBody && requestBody !== 'No body data') {
            window.modalEndpointData = {
                endpoint: endpoint,
                methodType: methodType,
                requestBody: requestBody
            };
        } else {
            window.modalEndpointData = {
                endpoint: endpoint,
                methodType: methodType,
                requestBody: null
            };
        }

        return `
            <div class="smart-test-dropdown" id="${dropdownId}">
                <button class="smart-test-btn" onclick="toggleModalSmartTestDropdown('${dropdownId}', '${endpoint}', '${methodType}')">
                    <span class="rocket-icon">üöÄ</span>
                    <span>Generate Smart Test</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="smart-test-dropdown-content" id="${dropdownId}-content">
                    <div class="smart-test-loading">
                        <div class="spinner"></div>
                        <p>Loading test case options...</p>
                    </div>
                </div>
            </div>
        `;
    }

    // Toggle function for modal dropdown
    function toggleModalSmartTestDropdown(dropdownId, endpoint, methodType) {
        const btn = document.querySelector(`#${dropdownId} .smart-test-btn`);
        const content = document.getElementById(`${dropdownId}-content`);

        if (!btn || !content) {
            console.error('‚ùå Dropdown elements not found');
            return;
        }

        const isOpen = content.classList.contains('show');

        if (isOpen) {
            // Close dropdown
            content.classList.remove('show');
            btn.classList.remove('active');
        } else {
            // Close any other open dropdowns
            document.querySelectorAll('.smart-test-dropdown-content.show').forEach(el => {
                el.classList.remove('show');
            });
            document.querySelectorAll('.smart-test-btn.active').forEach(el => {
                el.classList.remove('active');
            });

            // Open this dropdown
            content.classList.add('show');
            btn.classList.add('active');

            // Load prompts and populate dropdown
            loadPromptsForModalDropdown(dropdownId, endpoint, methodType);
        }
    }

    // Load prompts for modal dropdown
    function loadPromptsForModalDropdown(dropdownId, endpoint, methodType) {
        const content = document.getElementById(`${dropdownId}-content`);

        if (!content) {
            console.error('‚ùå Dropdown content not found');
            return;
        }

        // Show loading state
        content.innerHTML = `
            <div class="smart-test-loading">
                <div class="spinner"></div>
                <p>Loading test case options...</p>
            </div>
        `;

        // Load available prompts
        loadAvailablePrompts()
            .then(prompts => {
                if (prompts.length === 0) {
                    content.innerHTML = `
                        <div class="smart-test-error">
                            <strong>‚ùå No Test Case Options Available</strong><br>
                            Unable to load available test case generators. Please check your connection.
                        </div>
                    `;
                    return;
                }

                // Populate dropdown with prompts
                let html = '';
                prompts.forEach(prompt => {
                    html += `
                        <div class="smart-test-option" onclick="selectModalPromptAndGenerate('${prompt.id}', '${endpoint}', '${methodType}', '${dropdownId}')">
                            <div class="smart-test-option-title">${prompt.name}</div>
                            <div class="smart-test-option-description">${prompt.description}</div>
                            <div class="smart-test-option-category">${prompt.category}</div>
                        </div>
                    `;
                });

                content.innerHTML = html;
                console.log(`‚úÖ Populated modal dropdown with ${prompts.length} prompt options`);
            })
            .catch(error => {
                console.error('‚ùå Error loading prompts for dropdown:', error);
                content.innerHTML = `
                    <div class="smart-test-error">
                        <strong>‚ùå Error Loading Options</strong><br>
                        ${error.message || 'Unable to load test case generators. Please try again.'}
                    </div>
                `;
            });
    }

    // Select prompt and generate for modal
    function selectModalPromptAndGenerate(promptId, endpoint, methodType, dropdownId) {
        console.log('üöÄ Modal: Selected prompt:', promptId);
        console.log('üìç Modal: Endpoint:', endpoint);
        console.log('üìù Modal: Method:', methodType);

        // Close dropdown
        const content = document.getElementById(`${dropdownId}-content`);
        const btn = document.querySelector(`#${dropdownId} .smart-test-btn`);

        if (content) content.classList.remove('show');
        if (btn) btn.classList.remove('active');

        // Find the selected prompt details
        const selectedPrompt = availablePrompts.find(p => p.id === promptId);
        if (!selectedPrompt) {
            console.error('‚ùå Selected prompt not found');
            alert('‚ùå Selected test case generator not found. Please try again.');
            return;
        }

        console.log('‚úÖ Selected prompt details:', selectedPrompt);

        // Get the stored request body data
        const requestBody = window.modalEndpointData?.requestBody;

        // Parse the request body if it's a JSON string
        let payload = null;
        if (requestBody && requestBody !== 'No body data') {
            try {
                payload = JSON.parse(requestBody);
                console.log('‚úÖ Parsed request body:', payload);
            } catch (e) {
                console.log('‚ö†Ô∏è Could not parse request body as JSON, using as string');
                payload = requestBody;
            }
        }

        // Generate test case with selected prompt using New Relic data
        generateModalSmartTestCase(endpoint, methodType, payload, promptId, selectedPrompt.name);
    }

    // Generate smart test case for modal
    function generateModalSmartTestCase(endpoint, methodType, payload, promptType, promptName) {
        console.log('üöÄ Generating Smart Test Case from Modal');
        console.log('üìç Endpoint:', endpoint);
        console.log('üìù Method:', methodType);
        console.log('üì¶ Payload:', payload);
        console.log('üéØ Prompt Type:', promptType);
        console.log('üìã Prompt Name:', promptName);

        // Show LLM modal
        const llmModal = document.getElementById('llmModal');
        const llmContent = document.getElementById('llmContent');
        const llmActions = document.getElementById('llmActions');
        const llmTitle = document.querySelector('.llm-modal-title');

        if (!llmModal) {
            console.error('‚ùå LLM Modal not found');
            alert('‚ùå LLM Modal not found. Please check the page structure.');
            return;
        }

        // Update modal title with prompt name
        if (llmTitle) {
            llmTitle.textContent = `üöÄ ${promptName} - Test Case Generation`;
        }

        llmModal.style.display = 'block';
        llmActions.style.display = 'none';

        // Show loading state
        llmContent.innerHTML = `
            <div class="llm-loading">
                <div class="llm-spinner"></div>
                <div class="llm-loading-text">Generating ${promptName} Test Case...</div>
                <div class="llm-progress-bar">
                    <div class="llm-progress-fill"></div>
                </div>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 15px;">
                    Our AI is analyzing your endpoint using <strong>${promptName}</strong> and generating comprehensive test cases...
                </p>
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.8em;">
                    <strong>üéØ Analyzing:</strong> ${methodType} ${endpoint}<br>
                    <strong>üìã Generator:</strong> ${promptName}<br>
                    <strong>üîß Prompt Type:</strong> ${promptType}<br>
                    <strong>üì¶ Payload:</strong> ${payload ? 'Present' : 'None'}
                </div>
            </div>
        `;

        // Prepare request data for LLM
        const llmRequestData = {
            endpoint: endpoint,
            method_type: methodType,
            payload: payload,
            prompt_type: promptType
        };

        console.log('üì§ Sending LLM request:', llmRequestData);

        // Call the LLM API
        fetch('/ai/contact-llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(llmRequestData)
        })
        .then(response => {
            console.log('üì• LLM Response received:', response.status, response.statusText);

            if (!response.ok) {
                return response.text().then(text => {
                    console.error('‚ùå Response error text:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }

            return response.text(); // LLM returns raw text
        })
        .then(data => {
            console.log('‚úÖ LLM Response successful');
            console.log('üìù Response length:', data.length);

            currentLLMResponse = data;

            // Display the LLM response - use textContent to preserve HTML-like tags
            llmContent.innerHTML = `
                <div class="llm-content"></div>
            `;

            // Set the text content to preserve <tenant> and other HTML-like tags
            const contentDiv = llmContent.querySelector('.llm-content');
            contentDiv.textContent = data;

            // Show action buttons
            llmActions.style.display = 'flex';
        })
        .catch(error => {
            console.error('‚ùå LLM Error:', error);

            llmContent.innerHTML = `
                <div class="llm-error">
                    <h4>‚ùå Error Generating ${promptName} Test Case</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Request Details:</strong></p>
                    <ul>
                        <li><strong>Endpoint:</strong> ${endpoint}</li>
                        <li><strong>Method:</strong> ${methodType}</li>
                        <li><strong>Payload:</strong> ${payload ? 'Present' : 'None'}</li>
                        <li><strong>Prompt Type:</strong> ${promptType}</li>
                        <li><strong>Prompt Name:</strong> ${promptName}</li>
                    </ul>
                </div>
            `;

            // Show only close button on error
            llmActions.innerHTML = `
                <button class="llm-btn llm-btn-close" onclick="closeLLMModal()">
                    ‚ùå Close
                </button>
            `;
            llmActions.style.display = 'flex';
        });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.smart-test-dropdown')) {
            document.querySelectorAll('.smart-test-dropdown-content.show').forEach(el => {
                el.classList.remove('show');
            });
            document.querySelectorAll('.smart-test-btn.active').forEach(el => {
                el.classList.remove('active');
            });
        }
    });

    // Main API functions
    function getAccounts() {
        console.log('‚úÖ GET ACCOUNTS BUTTON CLICKED');

        const apiKey = document.getElementById('apiKey').value;
        const getAccountsBtn = document.getElementById('getAccountsBtn');
        const statusDiv = document.getElementById('connectionStatus');

        if (!apiKey || apiKey.trim() === '') {
            alert('Please enter your API key first');
            return;
        }

        getAccountsBtn.disabled = true;
        getAccountsBtn.textContent = 'Getting Accounts...';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Fetching available accounts...</p>
                </div>
            </div>
        `;

        fetch('/ai/get-accounts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ apiKey: apiKey.trim() })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            getAccountsBtn.disabled = false;
            getAccountsBtn.textContent = 'Get Accounts';

            if (data.status === 'success') {
                availableAccounts = data.accounts;
                populateAccountSelector(data.accounts);
                updateStepStatus(1, 'completed');
                updateStepStatus(2, 'current');
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ${data.accounts.length} accounts found!</strong><br>
                        Please select an account to continue.
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Failed to get accounts!</strong><br>
                        ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            getAccountsBtn.disabled = false;
            getAccountsBtn.textContent = 'Get Accounts';
            statusDiv.innerHTML = `
                <div class="alert alert-error">
                    <strong>‚ùå Error getting accounts!</strong><br>
                    ${error.message}<br>
                    <small>Make sure the backend server is running on http://localhost:5000</small>
                </div>
            `;
        });
    }

    function getApps() {
        const apiKey = document.getElementById('apiKey').value;
        const accountId = document.getElementById('accountSelect').value;
        const getAppsBtn = document.getElementById('getAppsBtn');
        const statusDiv = document.getElementById('connectionStatus');

        if (!accountId) {
            alert('Please select an account first');
            return;
        }

        getAppsBtn.disabled = true;
        getAppsBtn.textContent = 'Getting Applications...';
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Fetching applications for selected account...</p>
                </div>
            </div>
        `;

        fetch('/ai/get-apps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                apiKey: apiKey,
                accountId: accountId
            })
        })
        .then(response => response.json())
        .then(data => {
            getAppsBtn.disabled = false;
            getAppsBtn.textContent = 'Get Applications';

            if (data.status === 'success') {
                availableApps = data.apps;
                populateAppSelector(data.apps);
                updateStepStatus(2, 'completed');
                updateStepStatus(3, 'current');

                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ${data.apps.length} applications found!</strong><br>
                        Please select an application to continue.
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Failed to get applications!</strong><br>
                        ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            getAppsBtn.disabled = false;
            getAppsBtn.textContent = 'Get Applications';
            statusDiv.innerHTML = `
                <div class="alert alert-error">
                    <strong>‚ùå Error getting applications!</strong><br>
                    ${error.message}
                </div>
            `;
        });
    }

    function testConnection() {
        const apiKey = document.getElementById('apiKey').value;
        const accountId = document.getElementById('accountSelect').value;
        const statusDiv = document.getElementById('connectionStatus');
        const testBtn = document.getElementById('testConnectionBtn');

        // Get swagger URL
        swaggerUrl = document.getElementById('swaggerUrl').value.trim();

        if (!selectedAppName) {
            alert('Please select an application first');
            return;
        }

        if (!apiKey || !accountId) {
            alert('Please fill in all required fields');
            return;
        }

        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';

        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Testing connection to New Relic with app: "${selectedAppName}"...</p>
                </div>
            </div>
        `;

        const formData = {
            accountId: accountId,
            apiKey: apiKey,
            appName: selectedAppName,
            swaggerUrl: swaggerUrl
        };

        fetch('/ai/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            testBtn.disabled = false;
            testBtn.textContent = 'Test Connection';

            if (data.status === 'success') {
                connectionData = formData;
                updateStepStatus(3, 'completed');
                document.getElementById('nextStepBtn').style.display = 'inline-block';

                let swaggerStatus = '';
                if (swaggerUrl) {
                    swaggerStatus = `<br>‚Ä¢ Swagger URL configured: ${swaggerUrl}`;
                }

                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Connection Successful!</strong><br>
                        ‚Ä¢ Account ID validated<br>
                        ‚Ä¢ API key authenticated<br>
                        ‚Ä¢ Application "${selectedAppName}" found<br>
                        ‚Ä¢ ${data.app_transactions || 0} transactions found${swaggerStatus}<br>
                        ‚Ä¢ Ready to proceed with API discovery
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Connection Failed!</strong><br>
                        ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            testBtn.disabled = false;
            testBtn.textContent = 'Test Connection';
            statusDiv.innerHTML = `
                <div class="alert alert-error">
                    <strong>‚ùå Connection Error!</strong><br>
                    ${error.message}
                </div>
            `;
        });
    }

    function startAnalysis() {
        console.log('üöÄ Starting analysis...');

        if (!connectionData || !selectedAppName) {
            console.error('‚ùå Missing connection data or app name');
            alert('Please complete the connection setup first!');
            return;
        }

        console.log('‚úÖ Connection data:', connectionData);
        console.log('‚úÖ Selected app:', selectedAppName);

        const steps = document.querySelectorAll('#analysisSteps .metric-card');
        const progressBar = document.getElementById('analysisProgress');
        const startBtn = document.getElementById('startAnalysisBtn');

        startBtn.disabled = true;
        startBtn.textContent = 'Discovering APIs...';

        let currentStep = 0;

        function processStep() {
            console.log(`üîÑ Processing step ${currentStep + 1}/${steps.length}`);

            if (currentStep < steps.length) {
                const progress = ((currentStep + 1) / steps.length) * 100;
                progressBar.style.width = progress + '%';

                const statusSpan = steps[currentStep].querySelector('.status-indicator');
                statusSpan.textContent = 'Processing...';
                statusSpan.className = 'status-indicator status-pending';

                setTimeout(() => {
                    statusSpan.textContent = 'Complete';
                    statusSpan.className = 'status-indicator status-success';
                    currentStep++;

                    if (currentStep < steps.length) {
                        processStep();
                    } else {
                        console.log('‚úÖ All steps completed, fetching analysis data...');
                        fetchAnalysisData();
                    }
                }, 1000);
            }
        }

        processStep();
    }

    function fetchAnalysisData() {
        console.log('üîç Starting fetchAnalysisData...');

        const formData = {
            accountId: connectionData.accountId,
            apiKey: connectionData.apiKey,
            appName: selectedAppName,
            timeRange: document.getElementById('timeRange').value,
            swaggerUrl: swaggerUrl
        };

        console.log('üì§ Sending request:', formData);

        fetch('/ai/analyze-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('üì• Response received:', response.status, response.statusText);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Analysis data received:', data);

            const startBtn = document.getElementById('startAnalysisBtn');

            startBtn.disabled = false;
            startBtn.textContent = 'Start API Discovery';

            if (data.status === 'success') {
                console.log('‚úÖ Analysis successful, showing results...');
                analysisData = data;
                allApisData = data.all_apis || [];
                showResults(data);
                populateExportTab(data);
            } else {
                console.error('‚ùå Analysis failed:', data.message);
                alert('Analysis failed: ' + data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Analysis error:', error);

            const startBtn = document.getElementById('startAnalysisBtn');
            startBtn.disabled = false;
            startBtn.textContent = 'Start API Discovery';

            alert('Analysis error: ' + error.message);
        });
    }

    function showResults(data) {
        const resultsDiv = document.getElementById('analysisResults');
        resultsDiv.style.display = 'block';

        document.getElementById('totalApisCount').textContent = data.summary.total_apis;
        document.getElementById('totalRequestsCount').textContent = data.summary.total_requests.toLocaleString();
        document.getElementById('avgResponseTime').textContent = data.summary.avg_response_time + 'ms';
        document.getElementById('highTrafficCount').textContent = data.categorized_apis.high_traffic.length;
        document.getElementById('slowApisCount').textContent = data.categorized_apis.slow_response.length;
        document.getElementById('errorProneCount').textContent = data.categorized_apis.error_prone.length;

        populateApiTable(data.all_apis);
    }

    function populateApiTable(apis) {
        const tableBody = document.getElementById('apiTableBody');
        tableBody.innerHTML = '';

        if (!apis || apis.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No APIs found</td></tr>';
            return;
        }

        apis.forEach(api => {
            const row = document.createElement('tr');

            let successRateClass = 'high';
            if (api.success_rate < 95) successRateClass = 'medium';
            if (api.success_rate < 90) successRateClass = 'low';

            let responseTimeClass = 'fast';
            if (api.avg_response_time > 500) responseTimeClass = 'medium';
            if (api.avg_response_time > 1000) responseTimeClass = 'slow';

            row.innerHTML = `
                <td><div class="api-endpoint">${api.api_endpoint}</div></td>
                <td style="text-align: center;">${api.total_requests.toLocaleString()}</td>
                <td class="response-time ${responseTimeClass}">${Math.round(api.avg_response_time)}ms</td>
                <td style="text-align: center;">${Math.round(api.min_response_time)}ms</td>
                <td style="text-align: center;">${Math.round(api.max_response_time)}ms</td>
                <td style="text-align: center;">${api.error_count}</td>
                <td><div class="success-rate ${successRateClass}">${api.success_rate}%</div></td>
                <td style="text-align: center;">
                    <button class="btn btn-info btn-small" onclick="showEndpointDetails('${api.api_endpoint}')">
                        Complete Analysis
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function showEndpointDetails(endpointUri) {
        const modal = document.getElementById('endpointModal');
        const detailsDiv = document.getElementById('endpointDetails');

        currentEndpointUri = endpointUri;

        modal.style.display = 'block';
        detailsDiv.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading comprehensive endpoint analysis...</p>
            </div>
        `;

        const requestData = {
            ...connectionData,
            endpointUri: endpointUri,
            timeRange: document.getElementById('timeRange').value,
            swaggerBaseUrl: swaggerUrl,
            swaggerEnabled: false
        };

        fetch('/ai/get-endpoint-details', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const details = data.endpoint_details;
                currentEndpointDetails = details;
                renderCompleteEndpointDetails(details, endpointUri);
            } else {
                detailsDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Failed to load endpoint details!</strong><br>
                        ${data.message}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                `;
            }
        })
        .catch(error => {
            detailsDiv.innerHTML = `
                <div class="alert alert-error">
                    <strong>‚ùå Error loading endpoint details!</strong><br>
                    ${error.message}
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `;
        });
    }

    function renderCompleteEndpointDetails(details, endpointUri) {
        const detailsDiv = document.getElementById('endpointDetails');

        let html = `
            <div class="detail-card newrelic">
                <div class="detail-label">üîó Endpoint (New Relic)</div>
                <div class="detail-value">${details.endpoint}</div>
            </div>
            <div class="detail-card newrelic">
                <div class="detail-label">üìù HTTP Method</div>
                <div class="detail-value">${details.httpMethod}</div>
            </div>
            <div class="detail-card newrelic">
                <div class="detail-label">üìã Content Type</div>
                <div class="detail-value">${details.contentType}</div>
            </div>
            <div class="detail-card newrelic">
                <div class="detail-label">‚úÖ Accept Header</div>
                <div class="detail-value">${details.accept}</div>
            </div>
            <div class="detail-card newrelic">
                <div class="detail-label">üì¶ Request Body (New Relic)</div>
                <div class="detail-value json">${formatJsonString(details.requestBody)}</div>
            </div>
            <div class="detail-card newrelic">
                <div class="detail-label">üöÄ Request Payload (New Relic)</div>
                <div class="detail-value json">${formatJsonString(details.requestPayload)}</div>
            </div>
        `;

        // Always show the Swagger Integration section with checkbox
        html += `
            <div class="swagger-section">
                <div class="checkbox-group" style="margin-bottom: 15px;">
                    <input type="checkbox" id="enableSwaggerModal_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}" name="enableSwagger" onchange="toggleSwaggerForEndpoint('${endpointUri}')">
                    <label for="enableSwaggerModal_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}">Swagger Integration</label>
                </div>
                <div id="swaggerContent_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}">
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Swagger Integration Disabled</strong><br>
                        Enable the checkbox above and ensure you have a Swagger URL configured in Connection Setup to get comprehensive parameter details and cURL commands.
                    </div>
                </div>
            </div>
        `;

        // Add the Smart Test Case button ONLY if Swagger is not enabled (controlled by a div that we'll show/hide)
        html += `
            <div class="action-buttons" id="mainActionButtons_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}">
                ${createSmartTestDropdownForModal(details.endpoint, details.httpMethod, details.requestBody)}
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        `;

        detailsDiv.innerHTML = html;
    }

    function toggleSwaggerForEndpoint(endpointUri) {
        const checkboxId = `enableSwaggerModal_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const contentId = `swaggerContent_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const actionButtonsId = `mainActionButtons_${endpointUri.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const checkbox = document.getElementById(checkboxId);
        const contentDiv = document.getElementById(contentId);
        const actionButtonsDiv = document.getElementById(actionButtonsId);

        if (!checkbox || !contentDiv) return;

        const isEnabled = checkbox.checked;

        if (isEnabled) {
            // Hide only the smart test button, not the entire action buttons div
            if (actionButtonsDiv) {
                const smartTestDropdown = actionButtonsDiv.querySelector('.smart-test-dropdown');
                if (smartTestDropdown) {
                    smartTestDropdown.style.display = 'none';
                }
            }

            // Check if Swagger URL is configured
            if (!swaggerUrl || swaggerUrl.trim() === '') {
                checkbox.checked = false;
                alert('‚ùå Please configure a Swagger URL in the Connection Setup first!');
                // Show the smart test button again
                if (actionButtonsDiv) {
                    const smartTestDropdown = actionButtonsDiv.querySelector('.smart-test-dropdown');
                    if (smartTestDropdown) {
                        smartTestDropdown.style.display = 'inline-block';
                    }
                }
                return;
            }

            // Show loading state
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading Swagger integration...</p>
                </div>
            `;

            // Fetch Swagger details
            const requestData = {
                ...connectionData,
                endpointUri: endpointUri,
                timeRange: document.getElementById('timeRange').value,
                swaggerBaseUrl: swaggerUrl,
                swaggerEnabled: true
            };

            fetch('/ai/get-endpoint-details', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const details = data.endpoint_details;
                    currentEndpointDetails = details;

                    if (details.swagger_matched) {
                        contentDiv.innerHTML = renderSwaggerIntegrationContent(details);
                    } else {
                        contentDiv.innerHTML = `
                            <div class="swagger-match-badge error">‚ùå No Match Found</div>
                            <div class="alert alert-warning">
                                <strong>Swagger URL:</strong> ${swaggerUrl}<br>
                                <strong>Error:</strong> ${details.swagger_error || 'No matching endpoint found'}
                            </div>
                        `;
                    }
                } else {
                    contentDiv.innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Failed to load Swagger details!</strong><br>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                contentDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå Error loading Swagger details!</strong><br>
                        ${error.message}
                    </div>
                `;
            });
        } else {
            // Disable Swagger integration
            contentDiv.innerHTML = `
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Swagger Integration Disabled</strong><br>
                    Enable the checkbox above and ensure you have a Swagger URL configured in Connection Setup to get comprehensive parameter details and cURL commands.
                </div>
            `;

            // Show the smart test button again
            if (actionButtonsDiv) {
                const smartTestDropdown = actionButtonsDiv.querySelector('.smart-test-dropdown');
                if (smartTestDropdown) {
                    smartTestDropdown.style.display = 'inline-block';
                }
            }
        }
    }

    function renderSwaggerIntegrationContent(details) {
        const parameters = details.swagger_parameters;

        let html = `
            <div class="swagger-match-badge success">‚úÖ Match Found</div>
            <div class="alert alert-info">
                <strong>üîó Swagger URL:</strong> ${swaggerUrl}<br>
                <strong>üìç Matched Endpoint:</strong> ${details.swagger_matched_method} ${details.swagger_matched_path}
            </div>

            <div class="parameter-tabs">
                <button class="parameter-tab active" onclick="showParameterTab(event, 'path')">Path Parameters</button>
                <button class="parameter-tab" onclick="showParameterTab(event, 'query')">Query Parameters</button>
                <button class="parameter-tab" onclick="showParameterTab(event, 'header')">Header Parameters</button>
                <button class="parameter-tab" onclick="showParameterTab(event, 'body')">Body Parameters</button>
                <button class="parameter-tab" onclick="showParameterTab(event, 'schemas')">Request/Response</button>
            </div>

            <div id="path-params" class="parameter-tab-content active">
                ${renderParameterTable(parameters.path_parameters, 'Path Parameters')}
            </div>

            <div id="query-params" class="parameter-tab-content">
                ${renderParameterTable(parameters.query_parameters, 'Query Parameters')}
            </div>

            <div id="header-params" class="parameter-tab-content">
                ${renderParameterTable(parameters.header_parameters, 'Header Parameters')}
            </div>

            <div id="body-params" class="parameter-tab-content">
                ${renderBodyParameters(parameters.body_parameters)}
            </div>

            <div id="schemas-params" class="parameter-tab-content">
                ${renderSchemas(details.swagger_request_payload, details.swagger_response_payload)}
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-curl" onclick="generateCurlFromSchema()">
                    üéØ Generate cURL Command
                </button>

                ${createSmartTestDropdown(details.swagger_matched_path, details.swagger_matched_method)}
            </div>
        `;

        return html;
    }

    function renderParameterTable(parameters, title) {
        if (!parameters || parameters.length === 0) {
            return `
                <div class="parameter-section">
                    <h4>${title} <span class="parameter-count">0</span></h4>
                    <div class="no-parameters">No ${title.toLowerCase()} found</div>
                </div>
            `;
        }

        let html = `
            <div class="parameter-section">
                <h4>${title} <span class="parameter-count">${parameters.length}</span></h4>
                <table class="parameter-table">
                    <thead>
                        <tr>
                            <th>Parameter Name</th>
                            <th>Type</th>
                            <th>Required</th>
                            <th>Description</th>
                            <th>Example</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        parameters.forEach(param => {
            html += `
                <tr>
                    <td><span class="param-name">${param.name}</span></td>
                    <td><span class="param-type">${param.type}</span></td>
                    <td>${param.required ? '<span class="param-required">Required</span>' : '<span class="param-optional">Optional</span>'}</td>
                    <td><span class="param-description">${param.description || 'No description'}</span></td>
                    <td>${param.example ? `<span class="param-example">${param.example}</span>` : '-'}</td>
                </tr>
            `;

            if (param.enum && param.enum.length > 0) {
                html += `
                    <tr>
                        <td colspan="5">
                            <div class="enum-values">
                                <strong>Possible values:</strong> ${param.enum.join(', ')}
                            </div>
                        </td>
                    </tr>
                `;
            }
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        return html;
    }

    function renderBodyParameters(bodyParams) {
        if (!bodyParams || !bodyParams.properties || Object.keys(bodyParams.properties).length === 0) {
            return `
                <div class="parameter-section">
                    <h4>Body Parameters <span class="parameter-count">0</span></h4>
                    <div class="no-parameters">No body parameters found</div>
                </div>
            `;
        }

        let html = `
            <div class="parameter-section">
                <h4>Body Parameters <span class="parameter-count">${Object.keys(bodyParams.properties).length}</span></h4>
                ${bodyParams.description ? `<p class="param-description">${bodyParams.description}</p>` : ''}
                <table class="parameter-table">
                    <thead>
                        <tr>
                            <th>Property Name</th>
                            <th>Type</th>
                            <th>Required</th>
                            <th>Description</th>
                            <th>Example</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        Object.entries(bodyParams.properties).forEach(([propName, propInfo]) => {
            html += `
                <tr>
                    <td><span class="param-name">${propName}</span></td>
                    <td><span class="param-type">${propInfo.type}</span></td>
                    <td>${propInfo.required ? '<span class="param-required">Required</span>' : '<span class="param-optional">Optional</span>'}</td>
                    <td><span class="param-description">${propInfo.description || 'No description'}</span></td>
                    <td>${propInfo.example ? `<span class="param-example">${propInfo.example}</span>` : '-'}</td>
                </tr>
            `;

            if (propInfo.type === 'object' && propInfo.properties) {
                html += `
                    <tr>
                        <td colspan="5">
                            <div class="nested-params">
                                <strong>Nested properties:</strong>
                `;

                Object.entries(propInfo.properties).forEach(([nestedName, nestedInfo]) => {
                    html += `
                        <div class="nested-param">
                            <span class="param-name">${nestedName}</span>
                            <span class="param-type">${nestedInfo.type}</span>
                            ${nestedInfo.required ? '<span class="param-required">Required</span>' : '<span class="param-optional">Optional</span>'}
                            <br>
                            <span class="param-description">${nestedInfo.description || 'No description'}</span>
                            ${nestedInfo.example ? `<br><span class="param-example">Example: ${nestedInfo.example}</span>` : ''}
                        </div>
                    `;
                });

                html += `
                            </div>
                        </td>
                    </tr>
                `;
            }

            if (propInfo.type === 'array' && propInfo.items) {
                html += `
                    <tr>
                        <td colspan="5">
                            <div class="enum-values">
                                <strong>Array items type:</strong> ${propInfo.items.type}
                                ${propInfo.items.description ? ` - ${propInfo.items.description}` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }

            if (propInfo.enum && propInfo.enum.length > 0) {
                html += `
                    <tr>
                        <td colspan="5">
                            <div class="enum-values">
                                <strong>Possible values:</strong> ${propInfo.enum.join(', ')}
                            </div>
                        </td>
                    </tr>
                `;
            }
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        return html;
    }

    function renderSchemas(requestPayload, responsePayload) {
        let html = `
            <div class="parameter-section">
                <h4>Request Schema</h4>
                <div class="json-viewer">
                    ${requestPayload ? JSON.stringify(requestPayload, null, 2) : 'No request schema available'}
                </div>
            </div>
            <div class="parameter-section">
                <h4>Response Schema</h4>
                <div class="json-viewer">
                    ${responsePayload ? JSON.stringify(responsePayload, null, 2) : 'No response schema available'}
                </div>
            </div>
        `;

        return html;
    }

    function showParameterTab(event, tabName) {
        const tabContents = document.querySelectorAll('.parameter-tab-content');
        tabContents.forEach(content => content.classList.remove('active'));

        const tabs = document.querySelectorAll('.parameter-tab');
        tabs.forEach(tab => tab.classList.remove('active'));

        document.getElementById(tabName + '-params').classList.add('active');
        event.target.classList.add('active');
    }

    function formatJsonString(jsonString) {
        if (!jsonString || jsonString === 'Unknown' || jsonString === 'No body data' || jsonString === 'No payload data') {
            return jsonString;
        }

        try {
            const parsed = JSON.parse(jsonString);
            return JSON.stringify(parsed, null, 2);
        } catch (e) {
            return jsonString;
        }
    }

    function generateCurlFromSchema() {
        if (!currentEndpointDetails || !currentEndpointDetails.swagger_matched) {
            alert('‚ùå No Swagger details available for cURL generation');
            return;
        }

        const details = currentEndpointDetails;
        const requestSchema = details.swagger_request_payload;
        const method = details.swagger_matched_method || 'GET';
        const path = details.swagger_matched_path;
        const parameters = details.swagger_parameters;

        // Build the base URL
        let baseUrl = swaggerUrl;
        if (baseUrl.endsWith('/ai')) {
            baseUrl = baseUrl.slice(0, -1);
        }

        // Replace path parameters
        let finalPath = path;
        if (parameters && parameters.path_parameters) {
            parameters.path_parameters.forEach(param => {
                const placeholder = `{${param.name}}`;
                const exampleValue = param.example || `{${param.name}}`;
                finalPath = finalPath.replace(placeholder, exampleValue);
            });
        }

        const fullUrl = `${baseUrl}${finalPath}`;

        // Build cURL command
        let curlCommand = `curl -X ${method.toUpperCase()} \\\n`;
        curlCommand += `  "${fullUrl}"`;

        // Add headers
        curlCommand += ` \\\n  -H "Content-Type: application/json"`;
        curlCommand += ` \\\n  -H "Accept: application/json"`;

        // Add custom headers from parameters
        if (parameters && parameters.header_parameters) {
            parameters.header_parameters.forEach(header => {
                const headerValue = header.example || `{${header.name}}`;
                curlCommand += ` \\\n  -H "${header.name}: ${headerValue}"`;
            });
        }

        // Add query parameters
        if (parameters && parameters.query_parameters && parameters.query_parameters.length > 0) {
            const queryParams = parameters.query_parameters.map(param => {
                const value = param.example || `{${param.name}}`;
                // Don't encode placeholder values (those with curly braces)
                if (value.startsWith('{') && value.endsWith('}')) {
                    return `${param.name}=${value}`;
                } else {
                    return `${param.name}=${encodeURIComponent(value)}`;
                }
            }).join('&');

            const separator = fullUrl.includes('?') ? '&' : '?';
            curlCommand = curlCommand.replace(fullUrl, `${fullUrl}${separator}${queryParams}`);
        }

        // Add request body using Request Schema
        if (requestSchema && (method.toUpperCase() === 'POST' || method.toUpperCase() === 'PUT' || method.toUpperCase() === 'PATCH')) {
            const requestBody = JSON.stringify(requestSchema, null, 2);
            curlCommand += ` \\\n  -d '${requestBody}'`;
        }

        // Display the generated cURL command
        showGeneratedCurl(curlCommand);
    }

    function showGeneratedCurl(curlCommand) {
        const modal = document.getElementById('endpointModal');
        const detailsDiv = document.getElementById('endpointDetails');

        // Create a new section for the generated cURL
        const curlSection = document.createElement('div');
        curlSection.className = 'curl-section';
        curlSection.style.marginTop = '20px';
        curlSection.innerHTML = `
            <h4>üéØ Generated cURL Command</h4>
            <div class="curl-command" id="curlCommandText">${curlCommand}</div>
            <div style="margin-top: 10px;">
                <button class="btn btn-success" onclick="copySpecificCurl()">
                    üìã Copy cURL Command
                </button>
                <button class="btn btn-secondary" onclick="closeGeneratedCurl()">
                    ‚ùå Close
                </button>
            </div>
        `;

        // Add ID for easy removal
        curlSection.id = 'generated-curl-section';

        // Remove existing generated cURL section if it exists
        const existingSection = document.getElementById('generated-curl-section');
        if (existingSection) {
            existingSection.remove();
        }

        // Insert before the action buttons
        const actionButtons = detailsDiv.querySelector('.action-buttons');
        if (actionButtons) {
            detailsDiv.insertBefore(curlSection, actionButtons);
        } else {
            detailsDiv.appendChild(curlSection);
        }

        // Scroll to the new section
        curlSection.scrollIntoView({ behavior: 'smooth' });
    }

    function copySpecificCurl() {
        const curlElement = document.getElementById('curlCommandText');
        if (!curlElement) {
            alert('‚ùå cURL command not found');
            return;
        }

        const curlCommand = curlElement.textContent || curlElement.innerText;
        console.log('üîÑ Copying cURL command:', curlCommand);

        // Try multiple copy methods
        copyTextToClipboard(curlCommand);
    }

    function copyTextToClipboard(text) {
        console.log('üìã Starting copy process for text:', text.substring(0, 100) + '...');

        // Method 1: Modern Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            console.log('üìã Trying Clipboard API...');
            navigator.clipboard.writeText(text).then(() => {
                console.log('‚úÖ Clipboard API success');
                alert('‚úÖ Content copied to clipboard!');
            }).catch(err => {
                console.error('‚ùå Clipboard API failed:', err);
                tryExecCommandCopy(text);
            });
        } else {
            console.log('üìã Clipboard API not available, using fallback');
            tryExecCommandCopy(text);
        }
    }

    function tryExecCommandCopy(text) {
        console.log('üìã Trying execCommand copy...');

        // Create textarea element
        const textarea = document.createElement('textarea');
        textarea.value = text;

        // Style to make it invisible but selectable
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        textarea.style.opacity = '0';
        textarea.style.pointerEvents = 'none';
        textarea.style.tabIndex = '-1';
        textarea.setAttribute('readonly', '');

        // Add to document
        document.body.appendChild(textarea);

        try {
            // Focus and select
            textarea.focus();
            textarea.select();
            textarea.setSelectionRange(0, text.length);

            // Try to copy
            const successful = document.execCommand('copy');

            if (successful) {
                console.log('‚úÖ execCommand copy success');
                alert('‚úÖ Content copied to clipboard!');
            } else {
                console.error('‚ùå execCommand copy failed');
                showManualCopyDialog(text);
            }
        } catch (err) {
            console.error('‚ùå execCommand copy error:', err);
            showManualCopyDialog(text);
        } finally {
            // Clean up
            document.body.removeChild(textarea);
        }
    }

    function showManualCopyDialog(text) {
        console.log('üìã Showing manual copy dialog');

        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        `;

        overlay.innerHTML = `
            <div style="
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 90%;
                max-height: 80%;
                overflow: auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
                <h3 style="margin-top: 0; color: #333;">üìã Copy Content Manually</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Please select all text below and copy it manually (Ctrl+C / Cmd+C):
                </p>
                <textarea readonly style="
                    width: 100%;
                    height: 250px;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    padding: 15px;
                    border: 2px solid #007bff;
                    border-radius: 6px;
                    resize: none;
                    background: #f8f9fa;
                    color: #333;
                    line-height: 1.4;
                " id="manualCopyTextarea">${text}</textarea>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="selectAllInTextarea(); this.textContent='‚úÖ Selected! Now press Ctrl+C'" style="
                        padding: 12px 24px;
                        background: #28a745;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-right: 10px;
                        font-weight: 600;
                    ">üìã Select All</button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        padding: 12px 24px;
                        background: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">‚ùå Close</button>
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        // Auto-select the text
        setTimeout(() => {
            const textarea = document.getElementById('manualCopyTextarea');
            if (textarea) {
                textarea.focus();
                textarea.select();
            }
        }, 100);
    }

    function selectAllInTextarea() {
        const textarea = document.getElementById('manualCopyTextarea');
        if (textarea) {
            textarea.focus();
            textarea.select();
            textarea.setSelectionRange(0, textarea.value.length);
        }
    }

    function closeGeneratedCurl() {
        const generatedSection = document.getElementById('generated-curl-section');
        if (generatedSection) {
            generatedSection.remove();
        }
    }

    // LLM Modal functions
    function closeLLMModal() {
        const llmModal = document.getElementById('llmModal');
        llmModal.style.display = 'none';
        currentLLMResponse = '';
    }

    function copyLLMResponse() {
        if (!currentLLMResponse) {
            alert('‚ùå No test case content to copy');
            return;
        }

        copyTextToClipboard(currentLLMResponse);
    }

    function downloadLLMResponse() {
        if (!currentLLMResponse) {
            alert('‚ùå No test case content to download');
            return;
        }

        const blob = new Blob([currentLLMResponse], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `smart_test_case_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function closeModal() {
        document.getElementById('endpointModal').style.display = 'none';
        // Clean up generated cURL section
        const generatedSection = document.getElementById('generated-curl-section');
        if (generatedSection) {
            generatedSection.remove();
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('endpointModal');
        const llmModal = document.getElementById('llmModal');

        if (event.target === modal) {
            modal.style.display = 'none';
            // Clean up generated cURL section
            const generatedSection = document.getElementById('generated-curl-section');
            if (generatedSection) {
                generatedSection.remove();
            }
        }

        if (event.target === llmModal) {
            llmModal.style.display = 'none';
            currentLLMResponse = '';
        }
    }

    function filterApiTable() {
        const filter = document.getElementById('apiFilter').value.toLowerCase();
        const table = document.getElementById('apiTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const endpoint = row.cells[0].textContent.toLowerCase();

            if (endpoint.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }

    function sortApiTable() {
        const sortBy = document.getElementById('sortBy').value;
        const sortedApis = [...allApisData];

        switch (sortBy) {
            case 'requests':
                sortedApis.sort((a, b) => b.total_requests - a.total_requests);
                break;
            case 'response_time':
                sortedApis.sort((a, b) => b.avg_response_time - a.avg_response_time);
                break;
            case 'success_rate':
                sortedApis.sort((a, b) => a.success_rate - b.success_rate);
                break;
            case 'endpoint':
                sortedApis.sort((a, b) => a.api_endpoint.localeCompare(b.api_endpoint));
                break;
        }

        populateApiTable(sortedApis);
    }

    function exportApiList() {
        if (!allApisData || allApisData.length === 0) {
            alert('No API data to export');
            return;
        }

        const apiList = allApisData.map(api => api.api_endpoint).join('\n');

        const blob = new Blob([apiList], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `api_list_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function exportData() {
        if (!analysisData) {
            alert('Please complete the analysis first!');
            return;
        }

        const format = document.getElementById('exportFormat').value;
        const notes = document.getElementById('additionalNotes').value;
        const exportBtn = document.getElementById('exportBtn');

        exportBtn.disabled = true;
        exportBtn.textContent = 'Exporting...';

        const exportPayload = {
            format: format,
            notes: notes,
            analysisData: analysisData
        };

        fetch('/ai/export-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(exportPayload)
        })
        .then(response => response.json())
        .then(data => {
            exportBtn.disabled = false;
            exportBtn.textContent = 'Export API Data';

            if (data.status === 'success') {
                const blob = new Blob([JSON.stringify(data.data, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.filename;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('Export failed: ' + data.message);
            }
        })
        .catch(error => {
            exportBtn.disabled = false;
            exportBtn.textContent = 'Export API Data';
            alert('Export error: ' + error.message);
        });
    }

    function populateExportTab(data) {
        document.getElementById('exportResults').style.display = 'block';
        document.getElementById('exportPending').style.display = 'none';
    }

    function populateAccountSelector(accounts) {
        const accountSelect = document.getElementById('accountSelect');
        const accountSelector = document.getElementById('accountSelector');

        accountSelect.innerHTML = '<option value="">Select an account...</option>';
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.name} (ID: ${account.id})`;
            accountSelect.appendChild(option);
        });

        accountSelector.style.display = 'block';
        document.getElementById('getAppsBtn').style.display = 'inline-block';
    }

    function populateAppSelector(apps) {
        const appSelect = document.getElementById('appSelect');
        const appSelector = document.getElementById('appSelector');

        availableApps = apps || [];
        filteredApps = [...availableApps];

        appSelect.value = '';
        appSelect.placeholder = availableApps.length > 0 ? 'Type to search applications...' : 'No applications found';

        selectedAppName = null;
        document.getElementById('selectedAppInfo').style.display = 'none';
        document.getElementById('swaggerConfig').style.display = 'none';
        document.getElementById('testConnectionBtn').style.display = 'none';
        document.getElementById('nextStepBtn').style.display = 'none';

        if (availableApps.length === 0) {
            appSelect.placeholder = 'No applications found';
            appSelect.disabled = true;
        } else {
            appSelect.disabled = false;
        }

        appSelector.style.display = 'block';
        document.getElementById('timeRangeGroup').style.display = 'block';
    }

    function updateStepStatus(stepNumber, status) {
        const stepElement = document.getElementById(`step${stepNumber}`);
        if (stepElement) {
            stepElement.className = `step-number ${status}`;
            if (status === 'completed') {
                stepElement.textContent = '‚úì';
            }
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('endpointModal');
            const llmModal = document.getElementById('llmModal');

            if (modal.style.display === 'block') {
                closeModal();
            }

            if (llmModal.style.display === 'block') {
                closeLLMModal();
            }
        }

        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const filterInput = document.getElementById('apiFilter');
            if (filterInput) {
                filterInput.focus();
            }
        }
    });

    // Initialize page - Load prompts on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Enhanced API Discovery Suite with LLM Integration - Page Loaded');

        // Load available prompts on page initialization
        loadAvailablePrompts().then(prompts => {
            console.log(`‚úÖ Initialized with ${prompts.length} available prompts`);
        });

        console.log('‚úÖ Page initialization complete');
    });
</script>
</body>
</html>